(window.webpackJsonp=window.webpackJsonp||[]).push([[150],{585:function(s,a,t){"use strict";t.r(a);var e=t(10),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"redis-认证-访问控制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis-认证-访问控制"}},[s._v("#")]),s._v(" Redis 认证/访问控制")]),s._v(" "),t("p",[s._v("Redis 认证/访问控制使用外部 Redis 数据库作为数据源，可以存储大量数据，同时方便与外部设备管理系统集成。")]),s._v(" "),t("p",[s._v("搭建 Redis 环境，以 MacOS X 为例:")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v(" $ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" http://download.redis.io/releases/redis-4.0.14.tar.gz\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" xzf redis-4.0.14.tar.gz\n$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" redis-4.0.14\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动 redis")]),s._v("\n$ redis-server\n")])])]),t("h2",{attrs:{id:"创建模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建模块"}},[s._v("#")]),s._v(" 创建模块")]),s._v(" "),t("p",[s._v("打开 "),t("a",{attrs:{href:"http://127.0.0.1:18083/#/modules",target:"_blank",rel:"noopener noreferrer"}},[s._v("EMQ X Dashboard"),t("OutboundLink")],1),s._v("，点击左侧的 “模块” 选项卡，选择添加：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/develop_png/zh_CN/modules/assets/auth_redis1.png",alt:"auth_redis1.png"}})]),s._v(" "),t("p",[s._v("选择 Redis 认证/访问控制模块")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/develop_png/zh_CN/modules/assets/auth_redis2.png",alt:"auth_redis2.png"}})]),s._v(" "),t("p",[s._v("配置相关参数")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/develop_png/zh_CN/modules/assets/auth_redis3.png",alt:"auth_redis3.png"}})]),s._v(" "),t("p",[s._v("点击添加后，模块添加完成")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/develop_png/zh_CN/modules/assets/auth_redis4.png",alt:"auth_redis4.png"}})]),s._v(" "),t("h2",{attrs:{id:"认证默认数据结构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#认证默认数据结构"}},[s._v("#")]),s._v(" 认证默认数据结构")]),s._v(" "),t("p",[s._v("Redis 认证默认配置下使用哈希表存储认证数据，使用 "),t("code",[s._v("mqtt_user:")]),s._v(" 作为 Redis 键前缀，数据结构如下：")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("redis> hgetall mqtt_user:emqx\npassword public\n")])])]),t("p",[s._v("默认配置下示例数据如下：")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("HMSET mqtt_user:emqx password public\n")])])]),t("p",[s._v("启用 Redis 认证后，你可以通过用户名： emqx，密码：public 连接。")]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),t("p",[s._v("这是默认配置使用的数据结构，熟悉该模块的使用后，你可以使用任何满足条件的数据结构进行认证。")])]),s._v(" "),t("h2",{attrs:{id:"加盐规则与哈希方法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#加盐规则与哈希方法"}},[s._v("#")]),s._v(" 加盐规则与哈希方法")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("## 不加盐，明文\nplain\n\n## 不加盐，仅做哈希处理\nsha256\n\n## salt 前缀：使用 sha256 加密 salt + 密码 拼接的字符串\nsalt,sha256\n\n## salt 后缀：使用 sha256 加密 密码 + salt 拼接的字符串\nsha256,salt\n\n## pbkdf2 with macfun iterations dklen\n## macfun: md4, md5, ripemd160, sha, sha224, sha256, sha384, sha512\npbkdf2,sha256,1000,20\n")])])]),t("h3",{attrs:{id:"认证查询命令-auth-query-cmd"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#认证查询命令-auth-query-cmd"}},[s._v("#")]),s._v(" 认证查询命令（auth query cmd）")]),s._v(" "),t("p",[s._v("进行身份认证时，EMQ X 将使用当前客户端信息填充并执行用户配置的认证查询命令，查询出该客户端在 Redis 中的认证数据。")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("HMGET mqtt_user:%u password\n")])])]),t("p",[s._v("你可以在命令中使用以下占位符，执行时 EMQ X 将自动填充为客户端信息：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("%u：用户名")])]),s._v(" "),t("li",[t("p",[s._v("%c：Client ID")])]),s._v(" "),t("li",[t("p",[s._v("%C：TLS 证书公用名（证书的域名或子域名），仅当 TLS 连接时有效")])]),s._v(" "),t("li",[t("p",[s._v("%d：TLS 证书 subject，仅当 TLS 连接时有效")])])]),s._v(" "),t("p",[s._v("你可以根据业务需要调整认证查询命令，使用任意 "),t("a",{attrs:{href:"http://redisdoc.com/index.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Redis 支持的命令"),t("OutboundLink")],1),s._v("，但是任何情况下认证查询命令需要满足以下条件：")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("查询结果中第一个数据必须为 password，EMQ X 使用该字段与客户端密码比对")])]),s._v(" "),t("li",[t("p",[s._v("如果启用了加盐配置，查询结果中第二个数据必须是 salt 字段，EMQ X 使用该字段作为 salt（盐）值")])])]),s._v(" "),t("h2",{attrs:{id:"访问控制默认数据结构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#访问控制默认数据结构"}},[s._v("#")]),s._v(" 访问控制默认数据结构")]),s._v(" "),t("h3",{attrs:{id:"acl-规则数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#acl-规则数据"}},[s._v("#")]),s._v(" ACL 规则数据")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("## 格式\nHSET mqtt_acl:[username clientid][topic] [access]\n\n## 结构\nredis> hgetall mqtt_acl:emqx\ntesttopic/1 1\n")])])]),t("p",[s._v("默认配置下示例数据：")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("HSET mqtt_acl:emqx # 1\n\nHSET mqtt_acl:testtopic/2 2\n")])])]),t("h2",{attrs:{id:"acl-查询命令-acl-cmd"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#acl-查询命令-acl-cmd"}},[s._v("#")]),s._v(" ACL 查询命令（acl cmd）")]),s._v(" "),t("p",[s._v("进行 ACL 鉴权时，EMQ X 将使用当前客户端信息填充并执行用户配置的超级用户命令，如果没有启用超级用户命令或客户端不是超级用户，则使用 ACL 查询命令查询出该客户端在数据库中的 ACL 规则。")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("HGETALL mqtt_acl:%u\n")])])]),t("p",[s._v("你可以在 ACL 查询命令中使用以下占位符，执行时 EMQ X 将自动填充为客户端信息：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("%u：用户名")])]),s._v(" "),t("li",[t("p",[s._v("%c：Client ID")])])]),s._v(" "),t("p",[s._v("你可以根据业务需要调整 ACL 查询命令，但是任何情况下 ACL 查询命令需要满足以下条件：")]),s._v(" "),t("ol",[t("li",[s._v("哈希中使用 topic 作为键，access 作为值")])]),s._v(" "),t("h2",{attrs:{id:"超级用户查询命令-super-cmd"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#超级用户查询命令-super-cmd"}},[s._v("#")]),s._v(" 超级用户查询命令（super cmd）")]),s._v(" "),t("p",[s._v("进行 ACL 鉴权时，EMQ X 将使用当前客户端信息填充并执行用户配置的超级用户查询命令，查询客户端是否为超级用户。客户端为超级用户时将跳过 ACL 查询命令。")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("HGET mqtt_user:%u is_superuser\n")])])]),t("p",[s._v("你可以在命令中使用以下占位符，执行时 EMQ X 将自动填充为客户端信息：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("%u：用户名")])]),s._v(" "),t("li",[t("p",[s._v("%c：Client ID")])]),s._v(" "),t("li",[t("p",[s._v("%C：TLS 证书公用名（证书的域名或子域名），仅当 TLS 连接时有效")])]),s._v(" "),t("li",[t("p",[s._v("%d：TLS 证书 subject，仅当 TLS 连接时有效")])])]),s._v(" "),t("p",[s._v("你可以根据业务需要调整超级用户查询命令，如添加多个查询条件、使用数据库预处理函数，以实现更多业务相关的功能。但是任何情况下超级用户查询命令需要满足以下条件：")]),s._v(" "),t("ol",[t("li",[s._v("查询结果中第一个数据必须为 is_superuser 数据")])]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),t("p",[s._v("如果不需要超级用户功能，注释并禁用该选项能有效提高效率")])])])}),[],!1,null,null,null);a.default=r.exports}}]);