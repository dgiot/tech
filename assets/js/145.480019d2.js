(window.webpackJsonp=window.webpackJsonp||[]).push([[145],{668:function(t,s,a){"use strict";a.r(s);var n=a(7),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"mongodb-认证-访问控制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mongodb-认证-访问控制"}},[t._v("#")]),t._v(" MongoDB 认证/访问控制")]),t._v(" "),a("p",[t._v("MongoDB 认证/访问控制使⽤外部 MongoBD 数据库作为数据源，可以存储⼤量数据，同时⽅便与外部设备管理系统集成。")]),t._v(" "),a("h2",{attrs:{id:"安装mongodb"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装mongodb"}},[t._v("#")]),t._v(" 安装MongoDB")]),t._v(" "),a("p",[t._v("打开MongoDB官网地址:https://www.mongodb.com/try/download/communit, 选择你需要的版本,这里我们用MacOS V4.4.1版本:")]),t._v(" "),a("p",[a("img",{attrs:{src:"http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/emqx/modules/assets/auth_mongo1.png",alt:"auth_mongo1.png"}})]),t._v(" "),a("p",[t._v("安装后启动MongoDB")]),t._v(" "),a("h2",{attrs:{id:"创建模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建模块"}},[t._v("#")]),t._v(" 创建模块")]),t._v(" "),a("p",[t._v("打开 "),a("a",{attrs:{href:"http://127.0.0.1:18083/#/modules",target:"_blank",rel:"noopener noreferrer"}},[t._v("EMQ X Dashboard"),a("OutboundLink")],1),t._v("，点击左侧的 “模块” 选项卡，选择添加：")]),t._v(" "),a("p",[a("img",{attrs:{src:"http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/emqx/modules/assets/modules.png",alt:"modules.png"}})]),t._v(" "),a("p",[t._v("选择 MongoDB 认证/访问控制模块")]),t._v(" "),a("p",[a("img",{attrs:{src:"http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/emqx/modules/assets/auth_mongo2.png",alt:"auth_mongo2.png"}})]),t._v(" "),a("p",[t._v("配置 MongoDB 相关参数")]),t._v(" "),a("p",[a("img",{attrs:{src:"http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/emqx/modules/assets/auth_mongo3.png",alt:"auth_mongo3.png"}})]),t._v(" "),a("p",[t._v("点击添加后，模块添加完成:")]),t._v(" "),a("p",[a("img",{attrs:{src:"http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/emqx/modules/assets/auth_mongo4.png",alt:"auth_mongo4.png"}})]),t._v(" "),a("h2",{attrs:{id:"认证集合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#认证集合"}},[t._v("#")]),t._v(" 认证集合")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  username"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"user"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  password"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"password hash"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  salt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"password salt"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  is_superuser"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  created"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2020-02-20 12:12:14"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("进行身份认证时，EMQ X 将使用当前客户端信息填充并执行用户配置的认证 Query，查询出该客户端在数据库中的认证数据。")]),t._v(" "),a("p",[t._v("MongoDB 支持配置集合名称、认证字段、认证占位符等等参数。")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("配置项")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("认证查询集合")]),t._v(" "),a("td",[t._v("认证查询的MongoDB集合")])]),t._v(" "),a("tr",[a("td",[t._v("认证查询字段名")]),t._v(" "),a("td",[t._v("需要从集合里面查询出来的字段，如果需要查询多个，使用逗号分隔。例如password,salt")])]),t._v(" "),a("tr",[a("td",[t._v("认证条件字段")]),t._v(" "),a("td",[t._v("认证查询的条件，如果需要查询多个，使用逗号分隔。例如 username=%u,clientid=%c")])])])]),t._v(" "),a("p",[t._v("你可以在认证查询占位符中使用以下占位符，执行时 EMQ X 将自动填充为客户端信息：")]),t._v(" "),a("ul",[a("li",[t._v("%u：用户名")]),t._v(" "),a("li",[t._v("%c：clientid")]),t._v(" "),a("li",[t._v("%C：TLS 证书公用名（证书的域名或子域名），仅当 TLS 连接时有效")]),t._v(" "),a("li",[t._v("%d：TLS 证书 subject，仅当 TLS 连接时有效")])]),t._v(" "),a("p",[t._v("你可以根据业务需要调整认证查询，如添加多个查询条件、使用数据库预处理函数，以实现更多业务相关的功能。但是任何情况下认证查询需要满足以下条件：")]),t._v(" "),a("ol",[a("li",[t._v("查询结果中必须包含 password 字段，EMQ X 使用该字段与客户端密码比对")]),t._v(" "),a("li",[t._v("如果启用了加盐配置，查询结果中必须包含 salt 字段，EMQ X 使用该字段作为 salt（盐）值")]),t._v(" "),a("li",[t._v("MongoDB 使用 findOne 查询命令，确保你期望的查询结果能够出现在第一条数据中")])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("提示")]),t._v(" "),a("p",[t._v("这是默认配置使用的集合结构，熟悉该插件的使用后你可以使用任何满足条件的集合进行认证。")])]),t._v(" "),a("h2",{attrs:{id:"访问控制集合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#访问控制集合"}},[t._v("#")]),t._v(" 访问控制集合")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    username"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"username"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    clientid"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"clientid"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    publish"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"topic1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"topic2"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ..."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    subscribe"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"subtop1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"subtop2"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ..."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    pubsub"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"topic/#"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"topic1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ..."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("MongoDB ACL 一条规则中定义了发布、订阅和发布/订阅的信息，在规则中的都是"),a("strong",[t._v("允许")]),t._v("列表。")]),t._v(" "),a("p",[t._v("规则字段说明：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("配置项")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("访问控制查询集合")]),t._v(" "),a("td",[t._v("访问控制查询的MongoDB集合")])]),t._v(" "),a("tr",[a("td",[t._v("访问控制查询字段名")]),t._v(" "),a("td",[t._v("需要从集合里面查询出来的字段")])]),t._v(" "),a("tr",[a("td",[t._v("访问控制条件字段")]),t._v(" "),a("td",[t._v("访问控制查询的条件，支持and 和 or 操作，and操作通过逗号分隔，例如：username=%u,clientid=%c, or 操作需要添加多条数据")])])])]),t._v(" "),a("h2",{attrs:{id:"超级用户查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#超级用户查询"}},[t._v("#")]),t._v(" 超级用户查询")]),t._v(" "),a("p",[t._v("进行 ACL 鉴权时，EMQ X 将使用当前客户端信息填充并执行用户配置的超级用户查询，查询客户端是否为超级用户。客户端为超级用户时将跳过 ACL 查询。\n同一个选择器的多个条件时实际查询中使用 MongoDB and 查询：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('db.mqtt_user.find({\n  "username": "wivwiv"\n  "clientid": "$all"\n})\n')])])]),a("p",[t._v("你可以在查询条件中使用以下占位符，执行时 EMQ X 将自动填充为客户端信息：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("%u：用户名")])]),t._v(" "),a("li",[a("p",[t._v("%c：clientid")])])]),t._v(" "),a("p",[t._v("你可以根据业务需要调整超级用户查询，如添加多个查询条件、使用数据库预处理函数，以实现更多业务相关的功能。但是任何情况下超级用户查询需要满足以下条件：\n查询结果中必须包含 is_superuser 字段，is_superuser 应该显式的为 true。\nMongoDB 支持配置集合名称、认证字段、认证占位符等等参数。")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("配置项")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("超级用户查询集合")]),t._v(" "),a("td",[t._v("超级用户查询的MongoDB集合")])]),t._v(" "),a("tr",[a("td",[t._v("超级用户查询字段名")]),t._v(" "),a("td",[t._v("需要从集合里面查询出来的字段")])]),t._v(" "),a("tr",[a("td",[t._v("超级用户条件字段")]),t._v(" "),a("td",[t._v("超级用户查询的条件，如果需要查询多个，使用逗号分隔。例如 username=%u,clientid=%c")])])])]),t._v(" "),a("div",{staticClass:"custom-block danger"},[a("p",{staticClass:"custom-block-title"},[t._v("警告")]),t._v(" "),a("p",[t._v("MongoDB ACL 规则需严格使用上述数据结构。 MongoDB ACL 中添加的所有规则都是 允许 规则，可以搭配 "),a("code",[t._v("etc/emqx.conf")]),t._v(" 中 "),a("code",[t._v("acl_nomatch = deny")]),t._v(" 使用。")])]),t._v(" "),a("h2",{attrs:{id:"加密规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#加密规则"}},[t._v("#")]),t._v(" 加密规则")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## 不加盐，明文")]),t._v("\nplain\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## 不加盐，仅做哈希处理")]),t._v("\nsha256\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## salt 前缀：使用 sha256 加密 salt + 密码 拼接的字符串")]),t._v("\nsalt,sha256\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## salt 后缀：使用 sha256 加密 密码 + salt 拼接的字符串")]),t._v("\nsha256,salt\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## pbkdf2 with macfun iterations dklen")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## macfun: md4, md5, ripemd160, sha, sha224, sha256, sha384, sha512")]),t._v("\npbkdf2,sha256,1000,20\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("提示")]),t._v(" "),a("p",[t._v("可参考:"),a("a",{attrs:{href:"https://docs.emqx.cn/cn/broker/latest/advanced/auth.html#%E5%AF%86%E7%A0%81%E5%8A%A0%E7%9B%90%E8%A7%84%E5%88%99%E4%B8%8E%E5%93%88%E5%B8%8C%E6%96%B9%E6%B3%95",target:"_blank",rel:"noopener noreferrer"}},[t._v("加盐规则与哈希方法"),a("OutboundLink")],1),t._v("。")])])])}),[],!1,null,null,null);s.default=e.exports}}]);