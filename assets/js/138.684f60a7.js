(window.webpackJsonp=window.webpackJsonp||[]).push([[138],{875:function(t,s,a){"use strict";a.r(s);var e=a(7),r=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"http-认证-访问控制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http-认证-访问控制"}},[t._v("#")]),t._v(" HTTP 认证/访问控制")]),t._v(" "),a("p",[t._v("HTTP 认证/访问控制使用外部自建 HTTP 应用认证数据源，根据 HTTP API 返回的数据判定认证结果，能够实现复杂的认证鉴权逻辑和实现复杂的 ACL 校验逻辑。")]),t._v(" "),a("h2",{attrs:{id:"创建模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建模块"}},[t._v("#")]),t._v(" 创建模块")]),t._v(" "),a("p",[t._v("打开 "),a("a",{attrs:{href:"http://127.0.0.1:18083/#/modules",target:"_blank",rel:"noopener noreferrer"}},[t._v("EMQ X Dashboard"),a("OutboundLink")],1),t._v("，点击左侧的 “模块” 选项卡，选择添加：")]),t._v(" "),a("p",[a("img",{attrs:{src:"http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/emqx/modules/assets/modules.png",alt:"modules.png"}})]),t._v(" "),a("p",[t._v("选择 HTTP 认证/访问控制模块")]),t._v(" "),a("p",[a("img",{attrs:{src:"http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/emqx/modules/assets/auth_http2.png",alt:"auth_http2.png"}})]),t._v(" "),a("p",[t._v("配置相关参数")]),t._v(" "),a("p",[a("img",{attrs:{src:"http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/emqx/modules/assets/auth_http3.png",alt:"auth_http3.png"}})]),t._v(" "),a("p",[t._v("点击添加后，模块添加完成")]),t._v(" "),a("p",[a("img",{attrs:{src:"http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/emqx/modules/assets/auth_http4.png",alt:"auth_http4.png"}})]),t._v(" "),a("h2",{attrs:{id:"http-认证原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http-认证原理"}},[t._v("#")]),t._v(" HTTP 认证原理")]),t._v(" "),a("p",[t._v("EMQ X 在设备连接事件中使用当前客户端相关信息作为参数，向用户自定义的认证服务发起请求查询权限，通过返回的 HTTP "),a("strong",[t._v("响应状态码")]),t._v(" (HTTP statusCode) 来处理认证请求。")]),t._v(" "),a("ul",[a("li",[t._v("认证失败：API 返回 4xx 状态码")]),t._v(" "),a("li",[t._v("认证成功：API 返回 200 状态码")]),t._v(" "),a("li",[t._v("忽略认证：API 返回 200 状态码且消息体 ignore")])]),t._v(" "),a("h2",{attrs:{id:"认证请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#认证请求"}},[t._v("#")]),t._v(" 认证请求")]),t._v(" "),a("p",[t._v("进行身份认证时，EMQ X 将使用当前客户端信息填充并发起用户配置的认证查询请求，查询出该客户端在 HTTP 服务器端的认证数据。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## 认证请求地址")]),t._v("\nhttp://127.0.0.1:8991/mqtt/auth\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## HTTP 请求方法")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## Value: POST | GET")]),t._v("\nPOST\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## 请求参数")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("clientid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("%c,username"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("%u,password"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("%P\n")])])]),a("p",[t._v("HTTP 请求方法为 GET 时，请求参数将以 URL 查询字符串的形式传递；POST 请求则将请求参数以普通表单形式提交（content-type 为 x-www-form-urlencoded）。")]),t._v(" "),a("p",[t._v("你可以在认证请求中使用以下占位符，请求时 EMQ X 将自动填充为客户端信息：")]),t._v(" "),a("ul",[a("li",[t._v("%u：用户名")]),t._v(" "),a("li",[t._v("%c：Client ID")]),t._v(" "),a("li",[t._v("%a：客户端 IP 地址")]),t._v(" "),a("li",[t._v("%r：客户端接入协议")]),t._v(" "),a("li",[t._v("%P：明文密码")]),t._v(" "),a("li",[t._v("%p：客户端端口")]),t._v(" "),a("li",[t._v("%C：TLS 证书公用名（证书的域名或子域名），仅当 TLS 连接时有效")]),t._v(" "),a("li",[t._v("%d：TLS 证书 subject，仅当 TLS 连接时有效")])]),t._v(" "),a("div",{staticClass:"custom-block danger"},[a("p",{staticClass:"custom-block-title"},[t._v("警告")]),t._v(" "),a("p",[t._v("推荐使用 POST 与 PUT 方法，使用 GET 方法时明文密码可能会随 URL 被记录到传输过程中的服务器日志中。")])]),t._v(" "),a("h2",{attrs:{id:"http-访问控制原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http-访问控制原理"}},[t._v("#")]),t._v(" HTTP 访问控制原理")]),t._v(" "),a("p",[t._v("EMQ X 在设备发布、订阅事件中使用当前客户端相关信息作为参数，向用户自定义的认证服务发起请求权限，通过返回的 HTTP "),a("strong",[t._v("响应状态码")]),t._v(" (HTTP statusCode) 来处理 ACL 授权请求。")]),t._v(" "),a("ul",[a("li",[t._v("无权限：API 返回 4xx 状态码")]),t._v(" "),a("li",[t._v("授权成功：API 返回 200 状态码")]),t._v(" "),a("li",[t._v('忽略授权：API 返回 200 状态码且消息体为固定内容: "ignore"')])]),t._v(" "),a("h2",{attrs:{id:"http-请求信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http-请求信息"}},[t._v("#")]),t._v(" HTTP 请求信息")]),t._v(" "),a("p",[t._v("HTTP API 基础请求信息，配置证书、请求头与重试规则。")]),t._v(" "),a("p",[t._v("进行发布、订阅认证时，EMQ X 将使用当前客户端信息填充并发起用户配置的 ACL 授权查询请求，查询出该客户端在 HTTP 服务器端的授权数据。")]),t._v(" "),a("h2",{attrs:{id:"superuser-请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#superuser-请求"}},[t._v("#")]),t._v(" superuser 请求")]),t._v(" "),a("p",[t._v("首先查询客户端是否为超级用户，客户端为超级用户时将跳过 ACL 查询。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# etc/plugins/emqx_auth_http.conf")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## 超级用户请求地址")]),t._v("\nhttp://127.0.0.1:8991/mqtt/superuser\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## HTTP 请求方法")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## Value: POST | GET")]),t._v("\nPOST\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## 超级用户请求参数")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("clientid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("%c,username"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("%u\n")])])]),a("h2",{attrs:{id:"acl-访问控制请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#acl-访问控制请求"}},[t._v("#")]),t._v(" ACL 访问控制请求")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## 访问控制请求地址")]),t._v("\nhttp://127.0.0.1:8991/mqtt/acl\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## HTTP 请求方法")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## Value: POST | GET")]),t._v("\nPOST\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## 访问控制请求参数")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("access")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("%A,username"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("%u,clientid"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("%c,ipaddr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("%a,topic"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("%t,mountpoint"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("%m\n\n")])])]),a("h2",{attrs:{id:"请求说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#请求说明"}},[t._v("#")]),t._v(" 请求说明")]),t._v(" "),a("p",[t._v("HTTP 请求方法为 GET 时，请求参数将以 URL 查询字符串的形式传递；POST、PUT 请求则将请求参数以普通表单形式提交（content-type 为 x-www-form-urlencoded）。")]),t._v(" "),a("p",[t._v("你可以在认证请求中使用以下占位符，请求时 EMQ X 将自动填充为客户端信息：")]),t._v(" "),a("ul",[a("li",[t._v("%A：操作类型，'1' 订阅；'2' 发布")]),t._v(" "),a("li",[t._v("%u：客户端用户名")]),t._v(" "),a("li",[t._v("%c：Client ID")]),t._v(" "),a("li",[t._v("%a：客户端 IP 地址")]),t._v(" "),a("li",[t._v("%r：客户端接入协议")]),t._v(" "),a("li",[t._v("%m：Mountpoint")]),t._v(" "),a("li",[t._v("%t：主题")])]),t._v(" "),a("div",{staticClass:"custom-block danger"},[a("p",{staticClass:"custom-block-title"},[t._v("警告")]),t._v(" "),a("p",[t._v("推荐使用 POST 与 PUT 方法，使用 GET 方法时明文密码可能会随 URL 被记录到传输过程中的服务器日志中。")])])])}),[],!1,null,null,null);s.default=r.exports}}]);