(window.webpackJsonp=window.webpackJsonp||[]).push([[97],{805:function(s,t,v){"use strict";v.r(t);var _=v(8),e=Object(_.a)({},(function(){var s=this,t=s.$createElement,v=s._self._c||t;return v("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[v("h1",{attrs:{id:"升级指南"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#升级指南"}},[s._v("#")]),s._v(" 升级指南")]),s._v(" "),v("h2",{attrs:{id:"升级到-4-0-版本"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#升级到-4-0-版本"}},[s._v("#")]),s._v(" 升级到 4.0 版本")]),s._v(" "),v("p",[s._v("下文提供了一套从 "),v("strong",[s._v("EMQ X 3.x")]),s._v(" 版本迁移到最新 "),v("strong",[s._v("EMQ X 4.0")]),s._v("\n版本的准则。尽管我们试图减少一些重大更改，但为了兼顾性能、简化使用方式，我们在几个地方进行了修改。")]),s._v(" "),v("p",[v("strong",[s._v("EMQ X 3.x 版本迁移 EMQ X 4.0 要花多长时间？")])]),s._v(" "),v("p",[s._v("EMQ X 始终保证接入协议的规范性和持续更新，版本迁移时客户端部分\n"),v("strong",[s._v("无需做任何调整")]),s._v("，这意味着您无需停止设备功能、重新烧录设备程序固件。您仅需关注插件、配置项、命令行以及\nREST API 的变更。")]),s._v(" "),v("p",[s._v("所需时长取决于您的项目规模和变更涉及范围，中小型的项目基本一天内就可以搞定。")]),s._v(" "),v("h3",{attrs:{id:"核心"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#核心"}},[s._v("#")]),s._v(" 核心")]),s._v(" "),v("h4",{attrs:{id:"client-id-改为-clientid"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#client-id-改为-clientid"}},[s._v("#")]),s._v(" client_id 改为 clientid")]),s._v(" "),v("p",[s._v("在此处变量命名上我们做了较大的变动，EMQ X 内部所有 client_id 字符都更改为 clientid，包括：")]),s._v(" "),v("ul",[v("li",[s._v("REST API 的 URL、请求/相应数据中的字段名称")]),s._v(" "),v("li",[s._v("源代码中的命名规范")]),s._v(" "),v("li",[s._v("命令行 CLI")])]),s._v(" "),v("h3",{attrs:{id:"rest-api"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#rest-api"}},[s._v("#")]),s._v(" REST API")]),s._v(" "),v("h4",{attrs:{id:"v3-改为-v4"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#v3-改为-v4"}},[s._v("#")]),s._v(" v3 改为 v4")]),s._v(" "),v("p",[s._v("REST API 由 "),v("code",[s._v("http(s)://host:8081/api/v3/")]),s._v(" 变更为\n"),v("code",[s._v("http(s)://host:8081/api/v4/")]),s._v("。")]),s._v(" "),v("h4",{attrs:{id:"连接-connection-改为客户端-clients"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#连接-connection-改为客户端-clients"}},[s._v("#")]),s._v(" 连接 (connection) 改为客户端 (clients)")]),s._v(" "),v("p",[s._v("将 connections 概念改为 clients，涉及节点与集群相关的 API：")]),s._v(" "),v("ul",[v("li",[s._v("获取集群连接列表："),v("code",[s._v("GET /connections")]),s._v(" -> "),v("code",[s._v("/clients")])]),s._v(" "),v("li",[s._v("获取集群指定连接信息："),v("code",[s._v("GET /connections/:clientid")]),s._v(" -> "),v("code",[s._v("GET /connections/:clientid")])]),s._v(" "),v("li",[s._v("获取节点连接列表："),v("code",[s._v("GET /nodes/:node/connections")]),s._v(" -> "),v("code",[s._v("GET /nodes/:node/clients")])]),s._v(" "),v("li",[s._v("获取节点指定连接信息："),v("code",[s._v("GET /nodes/:node/connections/:clientid")]),s._v(" -> "),v("code",[s._v("GET /nodes/:node/clients/:clientid")])]),s._v(" "),v("li",[s._v("请求/相应数据中的 client_id 字段名称均变为 clientid")])]),s._v(" "),v("p",[s._v("同时 API 返回内容有较大变动，变动部分详见 4.0 文档。")]),s._v(" "),v("h4",{attrs:{id:"移除会话-session-相关的-api"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#移除会话-session-相关的-api"}},[s._v("#")]),s._v(" 移除会话 (session) 相关的 API")]),s._v(" "),v("p",[s._v("4.0 中引入 Channel 概念，将会话 (session) 和客户端 (client) 合二为一，4.0 版本中以下 API 已被\n"),v("strong",[s._v("移除")]),s._v("：")]),s._v(" "),v("ul",[v("li",[s._v("获取集群会话列表："),v("code",[s._v("GET /sessions")])]),s._v(" "),v("li",[s._v("获取集群指定客户端会话信息："),v("code",[s._v("GET /sessions/:clientid")])]),s._v(" "),v("li",[s._v("获取节点会话列表："),v("code",[s._v("GET /nodes/:node/sessions")])]),s._v(" "),v("li",[s._v("获取节点指定客户端会话信息："),v("code",[s._v("GET /nodes/:node/sessions/:clientid")])])]),s._v(" "),v("p",[s._v("4.0 以后如需获取会话相关信息，请使用客户端相关 API。")]),s._v(" "),v("h4",{attrs:{id:"移除插件配置获取与更改-api"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#移除插件配置获取与更改-api"}},[s._v("#")]),s._v(" 移除插件配置获取与更改 API")]),s._v(" "),v("p",[s._v("插件配置中可能包含敏感信息，同时插件配置不支持持久化为用户使用带来了很大疑惑。考虑到安全问题与实用性问题，我们 "),v("strong",[s._v("移除")]),s._v(" 了插件获取与更改\nAPI。")]),s._v(" "),v("ul",[v("li",[s._v("获取插件配置信息："),v("code",[s._v("GET /nodes/:node/plugins/:plugin_name")])]),s._v(" "),v("li",[s._v("更新插件配置："),v("code",[s._v("PUT /nodes/:node/plugins/:plugin_name")])])]),s._v(" "),v("p",[s._v("我们计划在 "),v("strong",[s._v("企业版")]),s._v(" 中通过安全规范及配置项本地存储提供解决以上问题，重新提供插件热配置相关的 API, "),v("strong",[s._v("目前企业版本已经支持关键配置的热配置操作")])]),s._v(" "),v("h3",{attrs:{id:"dashboard"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#dashboard"}},[s._v("#")]),s._v(" Dashboard")]),s._v(" "),v("h4",{attrs:{id:"连接-connection-改为客户端-clients-2"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#连接-connection-改为客户端-clients-2"}},[s._v("#")]),s._v(" 连接 (connection) 改为客户端 (clients)")]),s._v(" "),v("p",[s._v("Dashboard 中 "),v("strong",[s._v("连接 (connections)")]),s._v(" 概念改为 "),v("strong",[s._v("客户端 (clients)")]),s._v("，原连接信息可在现 "),v("strong",[s._v("客户端\n(clients)")]),s._v(" 页面查看。")]),s._v(" "),v("h4",{attrs:{id:"移除-会话-sessions-管理页面"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#移除-会话-sessions-管理页面"}},[s._v("#")]),s._v(" 移除 "),v("strong",[s._v("会话 (sessions)")]),s._v(" 管理页面")]),s._v(" "),v("p",[s._v("Dashboard 中移除 "),v("strong",[s._v("会话 (sessions)")]),s._v(" 管理页面，相关信息整合到 "),v("strong",[s._v("客户端 (clients)")]),s._v(" 页面中。")]),s._v(" "),v("h4",{attrs:{id:"规则引擎"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#规则引擎"}},[s._v("#")]),s._v(" 规则引擎")]),s._v(" "),v("p",[s._v("规则引擎 SQL 语法有所变动，规则创建时 Dashboard 中不再提供 "),v("strong",[s._v("事件")]),s._v(" 下拉选择框，SQL 语法详细变更参照本文\n"),v("strong",[s._v("规则引擎")]),s._v(" 部分。")]),s._v(" "),v("h3",{attrs:{id:"规则引擎-2"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#规则引擎-2"}},[s._v("#")]),s._v(" 规则引擎")]),s._v(" "),v("h4",{attrs:{id:"sql-语法变更"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#sql-语法变更"}},[s._v("#")]),s._v(" SQL 语法变更")]),s._v(" "),v("p",[s._v("4.0 版本中规则引擎 SQL 语法更加易用，3.x 版本中所有事件 "),v("strong",[s._v("FROM")]),s._v(" 子句后面均需要指定事件名称，4.0 以后我们引入\n"),v("strong",[s._v("事件主题")]),s._v(" 概念，默认情况下 "),v("strong",[s._v("消息发布")]),s._v(" 事件不再需要指定事件名称：")]),s._v(" "),v("div",{staticClass:"language-bash extra-class"},[v("pre",{pre:!0,attrs:{class:"language-bash"}},[v("code",[v("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 3.x 版本")]),s._v("\n"),v("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 需要指定事件名称进行处理")]),s._v("\nSELECT * FROM "),v("span",{pre:!0,attrs:{class:"token string"}},[s._v('"message.publish"')]),s._v(" WHERE topic "),v("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("~ "),v("span",{pre:!0,attrs:{class:"token string"}},[s._v("'t/#'")]),s._v("\n\n"),v("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 4.0 及以后版本")]),s._v("\n"),v("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 默认处理 message.publish 事件, FROM 后面直接筛选 MQTT 主题")]),s._v("\n"),v("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 上述 SQL 语句等价于:")]),s._v("\nSELECT * FROM "),v("span",{pre:!0,attrs:{class:"token string"}},[s._v("'t/#'")]),s._v("\n\n"),v("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 其他事件通过 事件主题 进行筛选")]),s._v("\nSELECT * FROM "),v("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),v("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$events")]),s._v('/message_acked"')]),s._v(" where topic "),v("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("~ "),v("span",{pre:!0,attrs:{class:"token string"}},[s._v("'t/#'")]),s._v("\nSELECT * FROM "),v("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),v("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$events")]),s._v('/client_connected"')]),s._v("\n")])])]),v("p",[s._v("Dashboard 中提供了旧版 SQL 语法转换功能可以完成 SQL 升级迁移。")]),s._v(" "),v("h4",{attrs:{id:"事件名称变更"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#事件名称变更"}},[s._v("#")]),s._v(" 事件名称变更")]),s._v(" "),v("p",[s._v("4.0 版本中 "),v("strong",[s._v("订阅/取消订阅")]),s._v(" 主体变为 "),v("strong",[s._v("会话 (session)")]),s._v("，"),v("strong",[s._v("事件")]),s._v(" 在转换为 "),v("strong",[s._v("事件主题")]),s._v("\n时，需要注意以下变更：")]),s._v(" "),v("ul",[v("li",[v("strong",[s._v("终端订阅")]),s._v(" 变更为 "),v("strong",[s._v("会话订阅")]),s._v("："),v("code",[s._v("client.subscribe")]),s._v(" ->\n"),v("code",[s._v("$events/session_subscribe")])]),s._v(" "),v("li",[v("strong",[s._v("终端取消订阅")]),s._v(" 变更为 "),v("strong",[s._v("会话取消订阅")]),s._v("："),v("code",[s._v("client.unsubscribe")]),s._v(" ->\n"),v("code",[s._v("$events/session_unsubscribe")])])]),s._v(" "),v("h2",{attrs:{id:"升级到3-1版本"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#升级到3-1版本"}},[s._v("#")]),s._v(" 升级到3.1版本")]),s._v(" "),v("div",{staticClass:"custom-block tip"},[v("p",{staticClass:"custom-block-title"},[s._v("Tip")]),s._v(" "),v("p",[s._v("3.1版本全新设计了项目架构、配置方式与插件管理方式。2.x与1.x版本升级需要重新配置部署。")])]),s._v(" "),v("p",[s._v("升级流程:")]),s._v(" "),v("ol",[v("li",[s._v("下载解压3.1版本到新安装目录，例如 /opt/emqx-3.1/；")]),s._v(" "),v("li",[s._v("参考旧版本 etc/vm.args、etc/emqttd.config 或 etc/emq.conf，配置3.1版本的\netc/emqx.conf；")]),s._v(" "),v("li",[s._v("重新配置插件 etc/plugins/${your-plugin}.conf；")]),s._v(" "),v("li",[s._v("编辑插件加载文件 data/loaded_plugins；")]),s._v(" "),v("li",[s._v("停止旧版本，启动新版。")])]),s._v(" "),v("h2",{attrs:{id:"_2-0升级到2-0-3版本"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_2-0升级到2-0-3版本"}},[s._v("#")]),s._v(" 2.0升级到2.0.3版本")]),s._v(" "),v("p",[s._v("升级流程:")]),s._v(" "),v("ol",[v("li",[s._v("下载解压2.0.3版本到新安装目录，例如 /opt/emqttd-2.0.3/；")]),s._v(" "),v("li",[s._v("旧版本的 'etc/' 配置文件、'data/' 数据文件覆盖到新版目录；")]),s._v(" "),v("li",[s._v("停止旧版本，启动新版。")])]),s._v(" "),v("h2",{attrs:{id:"升级到2-0版本"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#升级到2-0版本"}},[s._v("#")]),s._v(" 升级到2.0版本")]),s._v(" "),v("div",{staticClass:"custom-block tip"},[v("p",{staticClass:"custom-block-title"},[s._v("Tip")]),s._v(" "),v("p",[s._v("2.0版本全新设计了项目架构、配置方式与插件管理方式。1.x版本升级需要重新配置部署。")])]),s._v(" "),v("p",[s._v("升级流程:")]),s._v(" "),v("ol",[v("li",[s._v("下载解压2.0版本到新安装目录，例如 /opt/emqttd-2.0/")]),s._v(" "),v("li",[s._v("参考旧版本 etc/vm.args、etc/emqttd.config，配置2.0版本的 etc/emq.conf")]),s._v(" "),v("li",[s._v("重新配置插件 etc/plugins/${your-plugin}.conf")]),s._v(" "),v("li",[s._v("编辑插件加载文件 data/loaded_plugins")]),s._v(" "),v("li",[s._v("停止旧版本，启动新版。")])]),s._v(" "),v("h2",{attrs:{id:"升级到1-1-2版本"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#升级到1-1-2版本"}},[s._v("#")]),s._v(" 升级到1.1.2版本")]),s._v(" "),v("div",{staticClass:"custom-block tip"},[v("p",{staticClass:"custom-block-title"},[s._v("Tip")]),s._v(" "),v("p",[s._v("1.0以后版本可平滑升级到1.1.2")])]),s._v(" "),v("p",[s._v("升级流程:")]),s._v(" "),v("ol",[v("li",[s._v("下载解压1.1.2版本到新安装目录，例如 /opt/emqttd_112；")]),s._v(" "),v("li",[s._v("旧版本的 'etc/' 配置文件、'data/' 数据文件覆盖到新版目录；")]),s._v(" "),v("li",[s._v("如果有加载插件，将旧版插件配置文件覆盖到新版；")]),s._v(" "),v("li",[s._v("停止旧版本，启动新版。")])])])}),[],!1,null,null,null);t.default=e.exports}}]);