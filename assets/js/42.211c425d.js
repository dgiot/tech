(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{599:function(t,a,s){"use strict";s.r(a);var n=s(9),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"内置-acl"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#内置-acl"}},[t._v("#")]),t._v(" 内置 ACL")]),t._v(" "),s("p",[t._v("内置 ACL 通过文件设置规则，使用上足够简单轻量，适用于规则数量可预测、无变动需求或变动较小的项目。")]),t._v(" "),s("p",[t._v("ACL 规则文件：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("etc/acl.conf\n")])])]),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("提示")]),t._v(" "),s("p",[t._v("内置 ACL 优先级最低，可以被 ACL 插件覆盖，如需禁用全部注释即可。规则文件更改后需重启 EMQ X 以应用生效。")])]),t._v(" "),s("h2",{attrs:{id:"定义-acl"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#定义-acl"}},[t._v("#")]),t._v(" 定义 ACL")]),t._v(" "),s("p",[t._v("内置 ACL 是优先级最低规则表，在所有的 ACL 检查完成后，如果仍然未命中则检查默认的 ACL 规则。")]),t._v(" "),s("p",[t._v("该规则文件以 Erlang 语法的格式进行描述：")]),t._v(" "),s("div",{staticClass:"language-erlang extra-class"},[s("pre",{pre:!0,attrs:{class:"language-erlang"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('%% 允许 "dashboard" 用户 订阅 "$SYS/#" 主题')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token atom"}},[t._v("allow")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token atom"}},[t._v("user")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"dashboard"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token atom"}},[t._v("subscribe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"$SYS/#"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('%% 允许 IP 地址为 "127.0.0.1" 的用户 发布/订阅 "$SYS/#"，"#" 主题')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token atom"}},[t._v("allow")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token atom"}},[t._v("ipaddr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"127.0.0.1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token atom"}},[t._v("pubsub")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"$SYS/#"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"#"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('%% 拒绝 "所有用户" 订阅 "$SYS/#" "#" 主题')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token atom"}},[t._v("deny")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token atom"}},[t._v("all")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token atom"}},[t._v("subscribe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"$SYS/#"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token atom"}},[t._v("eq")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"#"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("%% 允许其它任意的发布订阅操作")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token atom"}},[t._v("allow")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token atom"}},[t._v("all")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])])]),s("ol",[s("li",[t._v("第一条规则允许客户端发布订阅所有主题")]),t._v(" "),s("li",[t._v("第二条规则禁止全部客户端订阅 "),s("code",[t._v("$SYS/#")]),t._v(" 与 "),s("code",[t._v("#")]),t._v(" 主题")]),t._v(" "),s("li",[t._v("第三条规则允许 ip 地址为 "),s("code",[t._v("127.0.0.1")]),t._v(" 的客户端发布/订阅 "),s("code",[t._v("$SYS/#")]),t._v(" 与 "),s("code",[t._v("#")]),t._v(" 主题，为第二条开了特例")]),t._v(" "),s("li",[t._v("第四条规则允许用户名为 "),s("code",[t._v("dashboard")]),t._v(" 的客户端订阅 "),s("code",[t._v("$SYS/#")]),t._v(" 主题，为第二条开了特例")])]),t._v(" "),s("p",[t._v("可知，默认的 ACL 主要是为了限制客户端对系统主题 "),s("code",[t._v("$SYS/#")]),t._v(" 和全通配主题 "),s("code",[t._v("#")]),t._v(" 的权限。")]),t._v(" "),s("h2",{attrs:{id:"acl-conf-编写规则"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#acl-conf-编写规则"}},[t._v("#")]),t._v(" acl.conf 编写规则")]),t._v(" "),s("p",[s("code",[t._v("acl.conf")]),t._v(" 文件中的规则按书写顺序从上往下匹配。")]),t._v(" "),s("p",[s("code",[t._v("acl.conf")]),t._v(" 的语法规则包含在顶部的注释中，熟悉 Erlang 语法的可直接阅读文件顶部的注释。或参考以下的释义：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("以 "),s("code",[t._v("%%")]),t._v(" 表示行注释。")])]),t._v(" "),s("li",[s("p",[t._v("每条规则由四元组组成，以 "),s("code",[t._v(".")]),t._v(" 结束。")])]),t._v(" "),s("li",[s("p",[t._v("元组第一位：表示规则命中成功后，执行权限控制操作，可取值为：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("allow")]),t._v("：表示 "),s("code",[t._v("允许")])]),t._v(" "),s("li",[s("code",[t._v("deny")]),t._v("： 表示 "),s("code",[t._v("拒绝")])])])]),t._v(" "),s("li",[s("p",[t._v("元组第二位：表示规则所生效的用户，可使用的格式为：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v('{user, "dashboard"}')]),t._v("：表明规则仅对 "),s("em",[t._v("用户名 (Username)")]),t._v(' 为 "dashboard" 的用户生效')]),t._v(" "),s("li",[s("code",[t._v('{clientid, "dashboard"}')]),t._v("：表明规则仅对 "),s("em",[t._v("客户端标识 (ClientId)")]),t._v(' 为 "dashboard" 的用户生效')]),t._v(" "),s("li",[s("code",[t._v('{ipaddr, "127.0.0.1"}')]),t._v("：表明规则仅对 "),s("em",[t._v("源地址")]),t._v(' 为 "127.0.0.1" 的用户生效')]),t._v(" "),s("li",[s("code",[t._v("all")]),t._v("：表明规则对所有的用户都生效")])])]),t._v(" "),s("li",[s("p",[t._v("元组第三位：表示规则所控制的操作，可取值为：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("publish")]),t._v("：表明规则应用在 PUBLISH 操作上")]),t._v(" "),s("li",[s("code",[t._v("subscribe")]),t._v("：表明规则应用在 SUBSCRIBE 操作上")]),t._v(" "),s("li",[s("code",[t._v("pubsub")]),t._v("：表明规则对 PUBLISH 和 SUBSCRIBE 操作都有效")])])]),t._v(" "),s("li",[s("p",[t._v("元组第四位：表示规则所限制的主题列表，内容以数组的格式给出，例如：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v('"$SYS/#"')]),t._v("：为一个 "),s("strong",[t._v("主题过滤器 (Topic Filter)")]),t._v("；表示规则可命中与 "),s("code",[t._v("$SYS/#")]),t._v(' 匹配的主题；如：可命中 "$SYS/#"，也可命中 "$SYS/a/b/c"')]),t._v(" "),s("li",[s("code",[t._v('{eq, "#"}')]),t._v("：表示字符的全等，规则仅可命中主题为 "),s("code",[t._v("#")]),t._v(" 的字串，不能命中 "),s("code",[t._v("/a/b/c")]),t._v(" 等")])])]),t._v(" "),s("li",[s("p",[t._v("除此之外还存在两条特殊的规则：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("{allow, all}")]),t._v("：允许所有操作")]),t._v(" "),s("li",[s("code",[t._v("{deny, all}")]),t._v("：拒绝所有操作")])])])]),t._v(" "),s("p",[t._v("在 "),s("code",[t._v("acl.conf")]),t._v(" 修改完成后，并不会自动加载至 EMQ X 系统。需要手动执行：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("./bin/emqx_ctl modules reload emqx_mod_acl_internal\n")])])]),s("h2",{attrs:{id:"占位符"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#占位符"}},[t._v("#")]),t._v(" 占位符")]),t._v(" "),s("p",[t._v("内置的 "),s("code",[t._v("acl.conf")]),t._v(" 在主题的域（元组的第四位）仅支持以下占位符：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("%c")]),t._v("： 表示客户端 ID，在规则生效时它将被替换为实际的客户端 ID。")]),t._v(" "),s("li",[s("code",[t._v("%u")]),t._v("： 表示客户端的用户名，在规则生效时将被替换为实际的客户端用户名。")])]),t._v(" "),s("p",[t._v("例如：")]),t._v(" "),s("div",{staticClass:"language-erlang extra-class"},[s("pre",{pre:!0,attrs:{class:"language-erlang"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token atom"}},[t._v("allow")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token atom"}},[t._v("all")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token atom"}},[t._v("pubsub")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sensor/%c/ctrl"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])])]),s("p",[t._v("表示，"),s("strong",[t._v("允许")]),t._v(" 客户端 ID 为 "),s("code",[t._v("light")]),t._v(" 的客户端 "),s("strong",[t._v("订阅和发布")]),t._v(" 到 "),s("code",[t._v("sensor/light/ctrl")]),t._v(" 主题。")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("提示")]),t._v(" "),s("p",[t._v("acl.conf 中应只包含一些简单而通用的规则，使其成为系统基础的 ACL 原则。如果需要支持复杂、大量的 ACL 内容，你应该在认证插件中去实现它。")])])])}),[],!1,null,null,null);a.default=e.exports}}]);