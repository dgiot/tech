<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>EMQ X 规则引擎数据存储 | 数蛙技术团队</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    <meta name="description" content="数蛙科技是一家致力于提供物联网垂直领域应用使能平台及解决方案的创新型公司。">
    <meta name="referrer" content="never">
    
    <link rel="preload" href="/assets/css/0.styles.a081a12a.css" as="style"><link rel="preload" href="/assets/js/app.25b3400a.js" as="script"><link rel="preload" href="/assets/js/6.5fcf748f.js" as="script"><link rel="preload" href="/assets/js/5.ef440211.js" as="script"><link rel="preload" href="/assets/js/86.3cb3d02d.js" as="script"><link rel="prefetch" href="/assets/js/10.06421c1a.js"><link rel="prefetch" href="/assets/js/100.c4f7cc3d.js"><link rel="prefetch" href="/assets/js/101.68869abc.js"><link rel="prefetch" href="/assets/js/102.990f288d.js"><link rel="prefetch" href="/assets/js/103.a3f751e6.js"><link rel="prefetch" href="/assets/js/104.fa7dbfce.js"><link rel="prefetch" href="/assets/js/105.4ae0f983.js"><link rel="prefetch" href="/assets/js/106.3f041995.js"><link rel="prefetch" href="/assets/js/107.034bd90d.js"><link rel="prefetch" href="/assets/js/108.47d4c865.js"><link rel="prefetch" href="/assets/js/109.647be4f7.js"><link rel="prefetch" href="/assets/js/11.11449620.js"><link rel="prefetch" href="/assets/js/110.78623214.js"><link rel="prefetch" href="/assets/js/111.32576bb4.js"><link rel="prefetch" href="/assets/js/112.b564b023.js"><link rel="prefetch" href="/assets/js/113.6268ce36.js"><link rel="prefetch" href="/assets/js/114.295ee54e.js"><link rel="prefetch" href="/assets/js/115.977f788a.js"><link rel="prefetch" href="/assets/js/116.3f1c47ff.js"><link rel="prefetch" href="/assets/js/117.adf74da8.js"><link rel="prefetch" href="/assets/js/118.ce7cc3f0.js"><link rel="prefetch" href="/assets/js/119.f7a44feb.js"><link rel="prefetch" href="/assets/js/12.92d366b3.js"><link rel="prefetch" href="/assets/js/120.ffaf9261.js"><link rel="prefetch" href="/assets/js/121.1df31a25.js"><link rel="prefetch" href="/assets/js/122.c7a8316d.js"><link rel="prefetch" href="/assets/js/123.bf7e0b75.js"><link rel="prefetch" href="/assets/js/124.783f5500.js"><link rel="prefetch" href="/assets/js/125.6f5899f0.js"><link rel="prefetch" href="/assets/js/126.81ed0acd.js"><link rel="prefetch" href="/assets/js/127.306552e5.js"><link rel="prefetch" href="/assets/js/128.0bcbb810.js"><link rel="prefetch" href="/assets/js/129.f43be59f.js"><link rel="prefetch" href="/assets/js/13.ea923bb6.js"><link rel="prefetch" href="/assets/js/130.5e59e2b1.js"><link rel="prefetch" href="/assets/js/131.2b1bf832.js"><link rel="prefetch" href="/assets/js/132.7b8af0ea.js"><link rel="prefetch" href="/assets/js/133.8e9c506a.js"><link rel="prefetch" href="/assets/js/134.e0fb7840.js"><link rel="prefetch" href="/assets/js/135.4711dec6.js"><link rel="prefetch" href="/assets/js/136.b1123357.js"><link rel="prefetch" href="/assets/js/137.30d4aae8.js"><link rel="prefetch" href="/assets/js/138.45f5a115.js"><link rel="prefetch" href="/assets/js/139.5a120e5e.js"><link rel="prefetch" href="/assets/js/14.60a96236.js"><link rel="prefetch" href="/assets/js/140.c87dcd4d.js"><link rel="prefetch" href="/assets/js/141.2b3d527e.js"><link rel="prefetch" href="/assets/js/142.4ee29ec4.js"><link rel="prefetch" href="/assets/js/143.57cd5ff6.js"><link rel="prefetch" href="/assets/js/144.75445d42.js"><link rel="prefetch" href="/assets/js/145.fb652e2a.js"><link rel="prefetch" href="/assets/js/146.ba5ebc13.js"><link rel="prefetch" href="/assets/js/147.b173763f.js"><link rel="prefetch" href="/assets/js/148.3b54385e.js"><link rel="prefetch" href="/assets/js/149.a42aff1d.js"><link rel="prefetch" href="/assets/js/15.afc6c6f9.js"><link rel="prefetch" href="/assets/js/150.245f8ecb.js"><link rel="prefetch" href="/assets/js/151.99bf5d52.js"><link rel="prefetch" href="/assets/js/152.2a6f5cf4.js"><link rel="prefetch" href="/assets/js/153.8cd1a791.js"><link rel="prefetch" href="/assets/js/154.0e401428.js"><link rel="prefetch" href="/assets/js/155.f52ba10f.js"><link rel="prefetch" href="/assets/js/156.4088be41.js"><link rel="prefetch" href="/assets/js/157.173f4f53.js"><link rel="prefetch" href="/assets/js/158.a0c6215a.js"><link rel="prefetch" href="/assets/js/159.7819f7ac.js"><link rel="prefetch" href="/assets/js/16.471d15d5.js"><link rel="prefetch" href="/assets/js/160.de298ea8.js"><link rel="prefetch" href="/assets/js/161.393b330d.js"><link rel="prefetch" href="/assets/js/162.c78ad5a3.js"><link rel="prefetch" href="/assets/js/163.f10da58b.js"><link rel="prefetch" href="/assets/js/164.f3da16a4.js"><link rel="prefetch" href="/assets/js/165.ab301473.js"><link rel="prefetch" href="/assets/js/166.3cf8fcc9.js"><link rel="prefetch" href="/assets/js/167.c0bf6975.js"><link rel="prefetch" href="/assets/js/168.b634d5d0.js"><link rel="prefetch" href="/assets/js/169.40e9704c.js"><link rel="prefetch" href="/assets/js/17.1b55fbf4.js"><link rel="prefetch" href="/assets/js/170.1c5bb17e.js"><link rel="prefetch" href="/assets/js/171.ab263649.js"><link rel="prefetch" href="/assets/js/172.8ddf3f19.js"><link rel="prefetch" href="/assets/js/173.15dfed54.js"><link rel="prefetch" href="/assets/js/174.1475813b.js"><link rel="prefetch" href="/assets/js/175.d3d40906.js"><link rel="prefetch" href="/assets/js/176.3ea2c053.js"><link rel="prefetch" href="/assets/js/177.1eabc91c.js"><link rel="prefetch" href="/assets/js/178.6d441c80.js"><link rel="prefetch" href="/assets/js/179.91817d1f.js"><link rel="prefetch" href="/assets/js/18.dc4f03cd.js"><link rel="prefetch" href="/assets/js/180.5df849bc.js"><link rel="prefetch" href="/assets/js/181.cfce6844.js"><link rel="prefetch" href="/assets/js/182.d63d5f1b.js"><link rel="prefetch" href="/assets/js/183.28e18a3d.js"><link rel="prefetch" href="/assets/js/184.1b4945c4.js"><link rel="prefetch" href="/assets/js/185.9219f7af.js"><link rel="prefetch" href="/assets/js/186.061014e4.js"><link rel="prefetch" href="/assets/js/187.90b44258.js"><link rel="prefetch" href="/assets/js/188.d6033238.js"><link rel="prefetch" href="/assets/js/189.826a1684.js"><link rel="prefetch" href="/assets/js/19.f7c4762b.js"><link rel="prefetch" href="/assets/js/190.b14253ea.js"><link rel="prefetch" href="/assets/js/191.f5d9dc37.js"><link rel="prefetch" href="/assets/js/192.b1cd9375.js"><link rel="prefetch" href="/assets/js/193.8712e844.js"><link rel="prefetch" href="/assets/js/194.1dfb0bb6.js"><link rel="prefetch" href="/assets/js/195.c852918a.js"><link rel="prefetch" href="/assets/js/196.dde9e433.js"><link rel="prefetch" href="/assets/js/197.8009a732.js"><link rel="prefetch" href="/assets/js/198.70517610.js"><link rel="prefetch" href="/assets/js/199.a4b08795.js"><link rel="prefetch" href="/assets/js/20.9128ade6.js"><link rel="prefetch" href="/assets/js/200.b7bb2be0.js"><link rel="prefetch" href="/assets/js/201.2e5eaf1e.js"><link rel="prefetch" href="/assets/js/202.1d847eea.js"><link rel="prefetch" href="/assets/js/203.2abb13b8.js"><link rel="prefetch" href="/assets/js/204.803d030d.js"><link rel="prefetch" href="/assets/js/205.f6f9b05d.js"><link rel="prefetch" href="/assets/js/206.27e7f41c.js"><link rel="prefetch" href="/assets/js/207.dc6d3076.js"><link rel="prefetch" href="/assets/js/208.efb8b483.js"><link rel="prefetch" href="/assets/js/209.12f584f1.js"><link rel="prefetch" href="/assets/js/21.49f946ca.js"><link rel="prefetch" href="/assets/js/210.b590c229.js"><link rel="prefetch" href="/assets/js/211.f9c2060e.js"><link rel="prefetch" href="/assets/js/212.dcb313f0.js"><link rel="prefetch" href="/assets/js/213.34231c5d.js"><link rel="prefetch" href="/assets/js/214.4f270d4c.js"><link rel="prefetch" href="/assets/js/215.9dd903ab.js"><link rel="prefetch" href="/assets/js/216.0c5b7058.js"><link rel="prefetch" href="/assets/js/217.622954ea.js"><link rel="prefetch" href="/assets/js/218.dd14f7ac.js"><link rel="prefetch" href="/assets/js/219.68cbf66f.js"><link rel="prefetch" href="/assets/js/22.2087f02d.js"><link rel="prefetch" href="/assets/js/220.678fe904.js"><link rel="prefetch" href="/assets/js/221.0a606827.js"><link rel="prefetch" href="/assets/js/222.463c0d98.js"><link rel="prefetch" href="/assets/js/223.938f151a.js"><link rel="prefetch" href="/assets/js/224.7b3c3fda.js"><link rel="prefetch" href="/assets/js/225.d4f515a2.js"><link rel="prefetch" href="/assets/js/226.3ad0b067.js"><link rel="prefetch" href="/assets/js/227.4ba2991a.js"><link rel="prefetch" href="/assets/js/228.ca0f81ac.js"><link rel="prefetch" href="/assets/js/229.667ccd6e.js"><link rel="prefetch" href="/assets/js/23.1bce378f.js"><link rel="prefetch" href="/assets/js/230.ff492524.js"><link rel="prefetch" href="/assets/js/231.1843c7a7.js"><link rel="prefetch" href="/assets/js/232.7fa78c1c.js"><link rel="prefetch" href="/assets/js/233.3d52f0ac.js"><link rel="prefetch" href="/assets/js/234.8503a6e7.js"><link rel="prefetch" href="/assets/js/235.2937758a.js"><link rel="prefetch" href="/assets/js/236.5022d458.js"><link rel="prefetch" href="/assets/js/237.79e1407e.js"><link rel="prefetch" href="/assets/js/238.c7a47e33.js"><link rel="prefetch" href="/assets/js/239.bde0cc62.js"><link rel="prefetch" href="/assets/js/24.889fb4ad.js"><link rel="prefetch" href="/assets/js/240.a19b91ec.js"><link rel="prefetch" href="/assets/js/241.0682f5fc.js"><link rel="prefetch" href="/assets/js/242.f7dc07ff.js"><link rel="prefetch" href="/assets/js/243.810f96fe.js"><link rel="prefetch" href="/assets/js/244.edd14001.js"><link rel="prefetch" href="/assets/js/245.3482d8d8.js"><link rel="prefetch" href="/assets/js/246.b70bb32e.js"><link rel="prefetch" href="/assets/js/247.e03f4708.js"><link rel="prefetch" href="/assets/js/248.2904977c.js"><link rel="prefetch" href="/assets/js/249.f1c59b65.js"><link rel="prefetch" href="/assets/js/25.e1f5217e.js"><link rel="prefetch" href="/assets/js/250.a45aa8f3.js"><link rel="prefetch" href="/assets/js/251.4723e879.js"><link rel="prefetch" href="/assets/js/252.f05e15b2.js"><link rel="prefetch" href="/assets/js/253.8d009ad0.js"><link rel="prefetch" href="/assets/js/254.62cd9d48.js"><link rel="prefetch" href="/assets/js/255.c1de9574.js"><link rel="prefetch" href="/assets/js/256.fa1f89af.js"><link rel="prefetch" href="/assets/js/257.7772c462.js"><link rel="prefetch" href="/assets/js/258.1d6fca74.js"><link rel="prefetch" href="/assets/js/259.ff15e8df.js"><link rel="prefetch" href="/assets/js/26.f3563293.js"><link rel="prefetch" href="/assets/js/260.7d81f45e.js"><link rel="prefetch" href="/assets/js/261.d22cb56a.js"><link rel="prefetch" href="/assets/js/262.bb593aca.js"><link rel="prefetch" href="/assets/js/263.f9553ec6.js"><link rel="prefetch" href="/assets/js/264.d187f162.js"><link rel="prefetch" href="/assets/js/265.47abf8c6.js"><link rel="prefetch" href="/assets/js/266.4ad4e303.js"><link rel="prefetch" href="/assets/js/267.29c52180.js"><link rel="prefetch" href="/assets/js/268.3797f0e6.js"><link rel="prefetch" href="/assets/js/269.9aed273a.js"><link rel="prefetch" href="/assets/js/27.c522c4e1.js"><link rel="prefetch" href="/assets/js/270.e74c8707.js"><link rel="prefetch" href="/assets/js/271.669bcfc5.js"><link rel="prefetch" href="/assets/js/272.f3ec6ff4.js"><link rel="prefetch" href="/assets/js/273.dba6399f.js"><link rel="prefetch" href="/assets/js/274.d75bbaf7.js"><link rel="prefetch" href="/assets/js/275.588daa98.js"><link rel="prefetch" href="/assets/js/276.8a6fdde2.js"><link rel="prefetch" href="/assets/js/277.4e395e3a.js"><link rel="prefetch" href="/assets/js/278.f1926f08.js"><link rel="prefetch" href="/assets/js/279.5b2dc2c0.js"><link rel="prefetch" href="/assets/js/28.bc55caed.js"><link rel="prefetch" href="/assets/js/280.5fb00854.js"><link rel="prefetch" href="/assets/js/281.ee7911e9.js"><link rel="prefetch" href="/assets/js/282.353d9724.js"><link rel="prefetch" href="/assets/js/283.1bfc4796.js"><link rel="prefetch" href="/assets/js/284.c079ecba.js"><link rel="prefetch" href="/assets/js/285.bfdd1e8a.js"><link rel="prefetch" href="/assets/js/286.d6ace8d6.js"><link rel="prefetch" href="/assets/js/287.8183694f.js"><link rel="prefetch" href="/assets/js/288.876dfc7a.js"><link rel="prefetch" href="/assets/js/289.b8464b58.js"><link rel="prefetch" href="/assets/js/29.11b33ccc.js"><link rel="prefetch" href="/assets/js/290.0a22f636.js"><link rel="prefetch" href="/assets/js/291.640d9b2b.js"><link rel="prefetch" href="/assets/js/292.9e7d2484.js"><link rel="prefetch" href="/assets/js/293.c0397cd2.js"><link rel="prefetch" href="/assets/js/294.a4cf6dde.js"><link rel="prefetch" href="/assets/js/295.88c66a87.js"><link rel="prefetch" href="/assets/js/296.96e78c92.js"><link rel="prefetch" href="/assets/js/297.b3133203.js"><link rel="prefetch" href="/assets/js/298.610b6900.js"><link rel="prefetch" href="/assets/js/299.48f028ea.js"><link rel="prefetch" href="/assets/js/30.3ee5c30c.js"><link rel="prefetch" href="/assets/js/300.7bcb1946.js"><link rel="prefetch" href="/assets/js/301.3228b80b.js"><link rel="prefetch" href="/assets/js/302.ef76d2b3.js"><link rel="prefetch" href="/assets/js/303.0b336b58.js"><link rel="prefetch" href="/assets/js/304.3ee2d031.js"><link rel="prefetch" href="/assets/js/305.c2cf8067.js"><link rel="prefetch" href="/assets/js/306.082e009d.js"><link rel="prefetch" href="/assets/js/307.f5c5927a.js"><link rel="prefetch" href="/assets/js/308.042c9000.js"><link rel="prefetch" href="/assets/js/309.02d7d0d7.js"><link rel="prefetch" href="/assets/js/31.926e5f68.js"><link rel="prefetch" href="/assets/js/310.50cbfd47.js"><link rel="prefetch" href="/assets/js/311.05203eef.js"><link rel="prefetch" href="/assets/js/312.c51abe40.js"><link rel="prefetch" href="/assets/js/313.845658de.js"><link rel="prefetch" href="/assets/js/314.3ee660a4.js"><link rel="prefetch" href="/assets/js/315.57d03dd1.js"><link rel="prefetch" href="/assets/js/316.b72906d7.js"><link rel="prefetch" href="/assets/js/317.d17c8cc3.js"><link rel="prefetch" href="/assets/js/318.ce093843.js"><link rel="prefetch" href="/assets/js/319.58a3fc12.js"><link rel="prefetch" href="/assets/js/32.a4c6decc.js"><link rel="prefetch" href="/assets/js/320.e67929ed.js"><link rel="prefetch" href="/assets/js/321.60f85d53.js"><link rel="prefetch" href="/assets/js/322.0e3d7ed0.js"><link rel="prefetch" href="/assets/js/323.1358dad7.js"><link rel="prefetch" href="/assets/js/324.d404aa1d.js"><link rel="prefetch" href="/assets/js/325.37caa48c.js"><link rel="prefetch" href="/assets/js/326.89a60b26.js"><link rel="prefetch" href="/assets/js/327.ba35dd40.js"><link rel="prefetch" href="/assets/js/328.d4858ec4.js"><link rel="prefetch" href="/assets/js/329.c79e368b.js"><link rel="prefetch" href="/assets/js/33.42e2a88c.js"><link rel="prefetch" href="/assets/js/330.5da25898.js"><link rel="prefetch" href="/assets/js/331.ba371b9d.js"><link rel="prefetch" href="/assets/js/332.37c15943.js"><link rel="prefetch" href="/assets/js/333.bb2ee7cd.js"><link rel="prefetch" href="/assets/js/334.9f6f0529.js"><link rel="prefetch" href="/assets/js/335.9e6213ab.js"><link rel="prefetch" href="/assets/js/336.c6a74f02.js"><link rel="prefetch" href="/assets/js/337.7b9ab2f6.js"><link rel="prefetch" href="/assets/js/338.3c377d1e.js"><link rel="prefetch" href="/assets/js/339.b3a659cc.js"><link rel="prefetch" href="/assets/js/34.16d3de22.js"><link rel="prefetch" href="/assets/js/340.a387121b.js"><link rel="prefetch" href="/assets/js/341.889b6b22.js"><link rel="prefetch" href="/assets/js/342.ae512d02.js"><link rel="prefetch" href="/assets/js/343.4138f202.js"><link rel="prefetch" href="/assets/js/344.4959cfca.js"><link rel="prefetch" href="/assets/js/345.521c547a.js"><link rel="prefetch" href="/assets/js/346.8dbb5450.js"><link rel="prefetch" href="/assets/js/347.7b86e900.js"><link rel="prefetch" href="/assets/js/348.3c05181b.js"><link rel="prefetch" href="/assets/js/349.96d3f5ef.js"><link rel="prefetch" href="/assets/js/35.43349aa6.js"><link rel="prefetch" href="/assets/js/350.a2e7f322.js"><link rel="prefetch" href="/assets/js/351.903cf330.js"><link rel="prefetch" href="/assets/js/352.e274cd05.js"><link rel="prefetch" href="/assets/js/353.3bda8d95.js"><link rel="prefetch" href="/assets/js/354.320d3bda.js"><link rel="prefetch" href="/assets/js/355.011f0e51.js"><link rel="prefetch" href="/assets/js/356.79457dc9.js"><link rel="prefetch" href="/assets/js/357.3c38d0d4.js"><link rel="prefetch" href="/assets/js/358.01d98354.js"><link rel="prefetch" href="/assets/js/359.1f946d10.js"><link rel="prefetch" href="/assets/js/36.ef199852.js"><link rel="prefetch" href="/assets/js/360.083aec21.js"><link rel="prefetch" href="/assets/js/361.1b2842f7.js"><link rel="prefetch" href="/assets/js/362.087aec7f.js"><link rel="prefetch" href="/assets/js/363.2fb32ccb.js"><link rel="prefetch" href="/assets/js/364.85770fa1.js"><link rel="prefetch" href="/assets/js/365.a17e3405.js"><link rel="prefetch" href="/assets/js/366.07f55245.js"><link rel="prefetch" href="/assets/js/367.57710606.js"><link rel="prefetch" href="/assets/js/368.401913f3.js"><link rel="prefetch" href="/assets/js/369.4c74ff3a.js"><link rel="prefetch" href="/assets/js/37.38c42f0a.js"><link rel="prefetch" href="/assets/js/370.7948f87d.js"><link rel="prefetch" href="/assets/js/371.912b08fa.js"><link rel="prefetch" href="/assets/js/372.0d98286e.js"><link rel="prefetch" href="/assets/js/373.10c57e8c.js"><link rel="prefetch" href="/assets/js/374.561e6ba6.js"><link rel="prefetch" href="/assets/js/375.c37596f5.js"><link rel="prefetch" href="/assets/js/376.43a802d3.js"><link rel="prefetch" href="/assets/js/377.7afee68a.js"><link rel="prefetch" href="/assets/js/378.a6e21ff0.js"><link rel="prefetch" href="/assets/js/379.574f2f3d.js"><link rel="prefetch" href="/assets/js/38.59e813a8.js"><link rel="prefetch" href="/assets/js/380.f9aed211.js"><link rel="prefetch" href="/assets/js/381.81334e94.js"><link rel="prefetch" href="/assets/js/382.47444706.js"><link rel="prefetch" href="/assets/js/383.149beeb5.js"><link rel="prefetch" href="/assets/js/384.0d7310e0.js"><link rel="prefetch" href="/assets/js/385.e6491ded.js"><link rel="prefetch" href="/assets/js/386.4b49f821.js"><link rel="prefetch" href="/assets/js/387.8d515bd1.js"><link rel="prefetch" href="/assets/js/388.7ceba368.js"><link rel="prefetch" href="/assets/js/389.9789c360.js"><link rel="prefetch" href="/assets/js/39.e13d3059.js"><link rel="prefetch" href="/assets/js/390.11999947.js"><link rel="prefetch" href="/assets/js/391.d243aeea.js"><link rel="prefetch" href="/assets/js/392.bccd349f.js"><link rel="prefetch" href="/assets/js/393.4c587359.js"><link rel="prefetch" href="/assets/js/394.2cfa57c6.js"><link rel="prefetch" href="/assets/js/395.739b0a53.js"><link rel="prefetch" href="/assets/js/396.b3a35ae8.js"><link rel="prefetch" href="/assets/js/397.ed8a6960.js"><link rel="prefetch" href="/assets/js/398.143209a4.js"><link rel="prefetch" href="/assets/js/399.7f19ab42.js"><link rel="prefetch" href="/assets/js/40.283d4386.js"><link rel="prefetch" href="/assets/js/400.27a8261d.js"><link rel="prefetch" href="/assets/js/401.acaf7c17.js"><link rel="prefetch" href="/assets/js/402.aaeea18a.js"><link rel="prefetch" href="/assets/js/403.c1da4fb1.js"><link rel="prefetch" href="/assets/js/404.6f258993.js"><link rel="prefetch" href="/assets/js/405.daad9acd.js"><link rel="prefetch" href="/assets/js/406.744cc495.js"><link rel="prefetch" href="/assets/js/407.a849b976.js"><link rel="prefetch" href="/assets/js/408.5592d69c.js"><link rel="prefetch" href="/assets/js/409.297dec10.js"><link rel="prefetch" href="/assets/js/41.ef9a48da.js"><link rel="prefetch" href="/assets/js/410.ec61b212.js"><link rel="prefetch" href="/assets/js/411.efda7d63.js"><link rel="prefetch" href="/assets/js/412.7da25003.js"><link rel="prefetch" href="/assets/js/413.17c81281.js"><link rel="prefetch" href="/assets/js/414.b3a84437.js"><link rel="prefetch" href="/assets/js/415.57f02788.js"><link rel="prefetch" href="/assets/js/416.cda6b6f5.js"><link rel="prefetch" href="/assets/js/417.47057060.js"><link rel="prefetch" href="/assets/js/418.a06bcdd0.js"><link rel="prefetch" href="/assets/js/419.f8492302.js"><link rel="prefetch" href="/assets/js/42.880b2fc1.js"><link rel="prefetch" href="/assets/js/420.5fbf4b43.js"><link rel="prefetch" href="/assets/js/421.e7478ad1.js"><link rel="prefetch" href="/assets/js/422.386ce383.js"><link rel="prefetch" href="/assets/js/423.b18fa61d.js"><link rel="prefetch" href="/assets/js/424.2e28b902.js"><link rel="prefetch" href="/assets/js/425.d9e19048.js"><link rel="prefetch" href="/assets/js/426.d08ec4df.js"><link rel="prefetch" href="/assets/js/43.f9f2a349.js"><link rel="prefetch" href="/assets/js/44.915bfc9b.js"><link rel="prefetch" href="/assets/js/45.011281ef.js"><link rel="prefetch" href="/assets/js/46.f41351c1.js"><link rel="prefetch" href="/assets/js/47.fe4c010e.js"><link rel="prefetch" href="/assets/js/48.976876c0.js"><link rel="prefetch" href="/assets/js/49.c15b3f6d.js"><link rel="prefetch" href="/assets/js/50.2b125ff7.js"><link rel="prefetch" href="/assets/js/51.b5e7fc6b.js"><link rel="prefetch" href="/assets/js/52.096c3a95.js"><link rel="prefetch" href="/assets/js/53.ad749b02.js"><link rel="prefetch" href="/assets/js/54.22b44a74.js"><link rel="prefetch" href="/assets/js/55.d384d1e1.js"><link rel="prefetch" href="/assets/js/56.b0a27d1f.js"><link rel="prefetch" href="/assets/js/57.9620a034.js"><link rel="prefetch" href="/assets/js/58.a92cdbe5.js"><link rel="prefetch" href="/assets/js/59.8bd194a1.js"><link rel="prefetch" href="/assets/js/60.074db8dd.js"><link rel="prefetch" href="/assets/js/61.d7fe85cd.js"><link rel="prefetch" href="/assets/js/62.1f739516.js"><link rel="prefetch" href="/assets/js/63.ce4ee372.js"><link rel="prefetch" href="/assets/js/64.20f6fa43.js"><link rel="prefetch" href="/assets/js/65.59f5de08.js"><link rel="prefetch" href="/assets/js/66.662a5eaf.js"><link rel="prefetch" href="/assets/js/67.b35f8bdf.js"><link rel="prefetch" href="/assets/js/68.af3b9b50.js"><link rel="prefetch" href="/assets/js/69.eeab345c.js"><link rel="prefetch" href="/assets/js/7.b4108a8c.js"><link rel="prefetch" href="/assets/js/70.99a09f40.js"><link rel="prefetch" href="/assets/js/71.337b8e4e.js"><link rel="prefetch" href="/assets/js/72.8f35533f.js"><link rel="prefetch" href="/assets/js/73.8445959a.js"><link rel="prefetch" href="/assets/js/74.3f7dba49.js"><link rel="prefetch" href="/assets/js/75.3c47ba2b.js"><link rel="prefetch" href="/assets/js/76.0291b9d5.js"><link rel="prefetch" href="/assets/js/77.d1cbbbfe.js"><link rel="prefetch" href="/assets/js/78.a8f798ff.js"><link rel="prefetch" href="/assets/js/79.4f770263.js"><link rel="prefetch" href="/assets/js/8.abf30b8a.js"><link rel="prefetch" href="/assets/js/80.5ef07f0d.js"><link rel="prefetch" href="/assets/js/81.0f111f60.js"><link rel="prefetch" href="/assets/js/82.544fb545.js"><link rel="prefetch" href="/assets/js/83.b38bdec4.js"><link rel="prefetch" href="/assets/js/84.4746851a.js"><link rel="prefetch" href="/assets/js/85.b7bc023b.js"><link rel="prefetch" href="/assets/js/87.5a8a3bda.js"><link rel="prefetch" href="/assets/js/88.e8fc521f.js"><link rel="prefetch" href="/assets/js/89.45a08d42.js"><link rel="prefetch" href="/assets/js/9.38012839.js"><link rel="prefetch" href="/assets/js/90.cd678e73.js"><link rel="prefetch" href="/assets/js/91.5fc1141e.js"><link rel="prefetch" href="/assets/js/92.6913f6c8.js"><link rel="prefetch" href="/assets/js/93.54486786.js"><link rel="prefetch" href="/assets/js/94.52a7124c.js"><link rel="prefetch" href="/assets/js/95.7d9d0b78.js"><link rel="prefetch" href="/assets/js/96.6673bbfa.js"><link rel="prefetch" href="/assets/js/97.26974d07.js"><link rel="prefetch" href="/assets/js/98.9c17710b.js"><link rel="prefetch" href="/assets/js/99.416b0ac7.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.d7ff67ab.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.b7eed2e1.js"><link rel="prefetch" href="/assets/js/vendors~photo-swipe.f4bfc23e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a081a12a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">数蛙技术团队</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="用户手册" class="dropdown-title"><span class="title">用户手册</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/manual/cloud/" class="nav-link">数蛙工业数据云平台</a></li><li class="dropdown-item"><!----> <a href="/zh/manual/edge/" class="nav-link">数蛙工业边缘网关</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="产品说明" class="dropdown-title"><span class="title">产品说明</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/product/dgiot/" class="nav-link">一站式物联网平台</a></li><li class="dropdown-item"><!----> <a href="/zh/product/dgtest/" class="nav-link">一站式云压测平台</a></li><li class="dropdown-item"><!----> <a href="/zh/product/dgii/" class="nav-link">工业互联网平台</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发指南" class="dropdown-title"><span class="title">开发指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/backend/" class="nav-link router-link-active">服务架构</a></li><li class="dropdown-item"><!----> <a href="/zh/frontend/" class="nav-link">交互技术</a></li><li class="dropdown-item"><!----> <a href="/zh/dataanalysis/" class="nav-link">数据分析</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实战教程" class="dropdown-title"><span class="title">实战教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blog/knowledge/" class="nav-link">基础知识</a></li><li class="dropdown-item"><!----> <a href="/zh/blog/study/" class="nav-link">案例教程</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/backend/emqx/backend/backends.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">简体中文</a></li><li class="dropdown-item"><!----> <a href="/en/" class="nav-link">English</a></li></ul></div></div> <a href="https://github.com/dgiot" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="用户手册" class="dropdown-title"><span class="title">用户手册</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/manual/cloud/" class="nav-link">数蛙工业数据云平台</a></li><li class="dropdown-item"><!----> <a href="/zh/manual/edge/" class="nav-link">数蛙工业边缘网关</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="产品说明" class="dropdown-title"><span class="title">产品说明</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/product/dgiot/" class="nav-link">一站式物联网平台</a></li><li class="dropdown-item"><!----> <a href="/zh/product/dgtest/" class="nav-link">一站式云压测平台</a></li><li class="dropdown-item"><!----> <a href="/zh/product/dgii/" class="nav-link">工业互联网平台</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发指南" class="dropdown-title"><span class="title">开发指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/backend/" class="nav-link router-link-active">服务架构</a></li><li class="dropdown-item"><!----> <a href="/zh/frontend/" class="nav-link">交互技术</a></li><li class="dropdown-item"><!----> <a href="/zh/dataanalysis/" class="nav-link">数据分析</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实战教程" class="dropdown-title"><span class="title">实战教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blog/knowledge/" class="nav-link">基础知识</a></li><li class="dropdown-item"><!----> <a href="/zh/blog/study/" class="nav-link">案例教程</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/backend/emqx/backend/backends.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">简体中文</a></li><li class="dropdown-item"><!----> <a href="/en/" class="nav-link">English</a></li></ul></div></div> <a href="https://github.com/dgiot" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <div style="padding-left:1.5rem;"><div></div></div> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>产品概览</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>EMQX</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/backend/emqx/" aria-current="page" class="sidebar-link">EMQX 简介</a></li><li><a href="/zh/backend/emqx/introduction/checklist.html" class="sidebar-link">EMQX 功能列表</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>开始使用</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>用户指南</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>模块管理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>规则引擎</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>插件管理</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/backend/emqx/advanced/plugins.html" class="sidebar-link">插件介绍</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading open"><span>数据存储插件</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/backend/emqx/backend/backend.html" class="sidebar-link">数据存储设计</a></li><li><a href="/zh/backend/emqx/backend/backends.html" aria-current="page" class="active sidebar-link">EMQ X 规则引擎数据存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#redis-数据存储" class="sidebar-link">Redis 数据存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#配置-redis-服务器" class="sidebar-link">配置 Redis 服务器</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#配置-redis-存储规则" class="sidebar-link">配置 Redis 存储规则</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#redis-存储规则说明" class="sidebar-link">Redis 存储规则说明</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#redis-命令行参数说明" class="sidebar-link">Redis 命令行参数说明</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#redis-命令行配置-action" class="sidebar-link">Redis 命令行配置 Action</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#redis-设备在线状态-hash" class="sidebar-link">Redis 设备在线状态 Hash</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#redis-保留消息-hash" class="sidebar-link">Redis 保留消息 Hash</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#redis-消息存储-hash" class="sidebar-link">Redis 消息存储 Hash</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#redis-消息确认-set" class="sidebar-link">Redis 消息确认 SET</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#redis-订阅存储-hash" class="sidebar-link">Redis 订阅存储 Hash</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#redis-sub-unsub-事件发布" class="sidebar-link">Redis SUB/UNSUB 事件发布</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#启用-redis-数据存储插件" class="sidebar-link">启用 Redis 数据存储插件</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#mysql-数据存储" class="sidebar-link">MySQL 数据存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#配置-mysql-服务器" class="sidebar-link">配置 MySQL 服务器</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#配置-mysql-存储规则" class="sidebar-link">配置 MySQL 存储规则</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#mysql-存储规则说明" class="sidebar-link">MySQL 存储规则说明</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#sql-语句参数说明" class="sidebar-link">SQL 语句参数说明</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#sql-语句配置-action" class="sidebar-link">SQL 语句配置 Action</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#创建-mysql-数据库表" class="sidebar-link">创建 MySQL 数据库表</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#导入-mysql-库表结构" class="sidebar-link">导入 MySQL 库表结构</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#mysql-设备在线状态表" class="sidebar-link">MySQL 设备在线状态表</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#mysql-主题订阅表" class="sidebar-link">MySQL 主题订阅表</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#mysql-消息存储表" class="sidebar-link">MySQL 消息存储表</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#mysql-保留消息表" class="sidebar-link">MySQL 保留消息表</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#mysql-消息确认表" class="sidebar-link">MySQL 消息确认表</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#启用-mysql-数据存储插件" class="sidebar-link">启用 MySQL 数据存储插件</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#postgresql-数据存储" class="sidebar-link">PostgreSQL 数据存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#配置-postgresql-服务器" class="sidebar-link">配置 PostgreSQL 服务器</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#配置-postgresql-存储规则" class="sidebar-link">配置 PostgreSQL 存储规则</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#postgresql-存储规则说明" class="sidebar-link">PostgreSQL 存储规则说明</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#sql-语句参数说明-2" class="sidebar-link">SQL 语句参数说明</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#sql-语句配置-action-2" class="sidebar-link">SQL 语句配置 Action</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#创建-postgresql-数据库" class="sidebar-link">创建 PostgreSQL 数据库</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#导入-postgresql-库表结构" class="sidebar-link">导入 PostgreSQL 库表结构</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#postgresql-设备在线状态表" class="sidebar-link">PostgreSQL 设备在线状态表</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#postgresql-代理订阅表" class="sidebar-link">PostgreSQL 代理订阅表</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#postgresql-消息存储表" class="sidebar-link">PostgreSQL 消息存储表</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#postgresql-保留消息表" class="sidebar-link">PostgreSQL 保留消息表</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#postgresql-消息确认表" class="sidebar-link">PostgreSQL 消息确认表</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#启用-postgresql-数据存储插件" class="sidebar-link">启用 PostgreSQL 数据存储插件</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#mongodb-消息存储" class="sidebar-link">MongoDB 消息存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#配置-mongodb-消息存储" class="sidebar-link">配置 MongoDB 消息存储</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#配置-mongodb-服务器" class="sidebar-link">配置 MongoDB 服务器</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#mongodb-数据库初始化" class="sidebar-link">MongoDB 数据库初始化</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#mongodb-用户状态集合-client-collection" class="sidebar-link">MongoDB 用户状态集合(Client Collection)</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#mongodb-用户订阅主题集合-subscription-collection" class="sidebar-link">MongoDB 用户订阅主题集合(Subscription Collection)</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#mongodb-发布消息集合-message-collection" class="sidebar-link">MongoDB 发布消息集合(Message Collection)</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#mongodb-保留消息集合-retain-message-collection" class="sidebar-link">MongoDB 保留消息集合(Retain Message Collection)</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#mongodb-接收消息-ack-集合-message-acked-collection" class="sidebar-link">MongoDB 接收消息 ack 集合(Message Acked Collection)</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#启用-mongodb-数据存储插件" class="sidebar-link">启用 MongoDB 数据存储插件</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#cassandra-消息存储" class="sidebar-link">Cassandra 消息存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#配置-cassandra-服务器" class="sidebar-link">配置 Cassandra 服务器</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#cassandra-创建一个-keyspace" class="sidebar-link">Cassandra 创建一个 Keyspace</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#导入-cassandra-表结构" class="sidebar-link">导入 Cassandra 表结构</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#cassandra-用户状态表-client-table" class="sidebar-link">Cassandra 用户状态表(Client Table)</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#cassandra-用户订阅主题表-sub-table" class="sidebar-link">Cassandra 用户订阅主题表(Sub Table)</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#cassandra-发布消息表-msg-table" class="sidebar-link">Cassandra 发布消息表(Msg Table)</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#cassandra-保留消息表-retain-message-table" class="sidebar-link">Cassandra 保留消息表(Retain Message Table)</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#cassandra-接收消息-ack-表-message-acked-table" class="sidebar-link">Cassandra 接收消息 ack 表(Message Acked Table)</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#启用-cassandra-存储插件" class="sidebar-link">启用 Cassandra 存储插件</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#dynamodb-消息存储" class="sidebar-link">DynamoDB 消息存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#配置-dyanmodb-消息存储" class="sidebar-link">配置 DyanmoDB 消息存储</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#dynamodb-数据库创建表" class="sidebar-link">DynamoDB 数据库创建表</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#dynamodb-用户状态表-client-table" class="sidebar-link">DynamoDB 用户状态表(Client Table)</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#dynamodb-用户订阅主题-subscription-table" class="sidebar-link">DynamoDB 用户订阅主题(Subscription Table)</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#dynamodb-发布消息-message-table" class="sidebar-link">DynamoDB 发布消息(Message Table)</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#dynamodb-保留消息-retain-message-table" class="sidebar-link">DynamoDB 保留消息(Retain Message Table)</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#dynamodb-接收消息-ack-message-acked-table" class="sidebar-link">DynamoDB 接收消息 ack (Message Acked Table)</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#influxdb-消息存储" class="sidebar-link">InfluxDB 消息存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#influxdb-配置" class="sidebar-link">InfluxDB 配置</a></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#配置-influxdb-消息存储" class="sidebar-link">配置 InfluxDB 消息存储</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#opentsdb-消息存储" class="sidebar-link">OpenTSDB 消息存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#配置-opentsdb-消息存储" class="sidebar-link">配置 OpenTSDB 消息存储</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#timescale-消息存储" class="sidebar-link">Timescale 消息存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/backend/emqx/backend/backends.html#配置-timescale-消息存储" class="sidebar-link">配置 Timescale 消息存储</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading"><span>消息桥接插件</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>运维操作</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/zh/backend/emqx/advanced/http-api.html" class="sidebar-link">HTTP API</a></li><li><a href="/zh/backend/emqx/configuration/configuration.html" class="sidebar-link">参数配置</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>命令行接口</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/zh/backend/emqx/advanced/relup.html" class="sidebar-link">版本热升级</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>FAQ 常见问题解答</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>SDK &amp; Tools</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>协议介绍</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>版本发布</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>相关资料</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li></ul> </aside> <!----> <!----> <main class="page"><div class="theme-default-content" style="margin-top:3.6rem;padding-top:0;padding-bottom:0;"></div> <div class="theme-default-content"><div class="content__default"><h1 id="emq-x-规则引擎数据存储"><a href="#emq-x-规则引擎数据存储" class="header-anchor">#</a> EMQ X 规则引擎数据存储</h1> <h2 id="redis-数据存储"><a href="#redis-数据存储" class="header-anchor">#</a> Redis 数据存储</h2> <p>配置文件: emqx_backend_redis.conf</p> <h3 id="配置-redis-服务器"><a href="#配置-redis-服务器" class="header-anchor">#</a> 配置 Redis 服务器</h3> <p>支持配置多台 Redis 服务器连接池:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## Redis 服务集群类型: single | sentinel | cluster</span>
backend.redis.pool1.type <span class="token operator">=</span> single

<span class="token comment">## Redis 服务器地址列表</span>
backend.redis.pool1.server <span class="token operator">=</span> <span class="token number">127.0</span>.0.1:6379

<span class="token comment">## Redis sentinel 模式下的 sentinel 名称</span>
<span class="token comment">## backend.redis.pool1.sentinel = mymaster</span>

<span class="token comment">## Redis 连接池大小</span>
backend.redis.pool1.pool_size <span class="token operator">=</span> <span class="token number">8</span>

<span class="token comment">## Redis 数据库名称</span>
backend.redis.pool1.database <span class="token operator">=</span> <span class="token number">0</span>

<span class="token comment">## Redis 密码</span>
<span class="token comment">## backend.redis.pool1.password =</span>

<span class="token comment">## 订阅的 Redis channel 名称</span>
backend.redis.pool1.channel <span class="token operator">=</span> mqtt_channel
</code></pre></div><h3 id="配置-redis-存储规则"><a href="#配置-redis-存储规则" class="header-anchor">#</a> 配置 Redis 存储规则</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>backend.redis.hook.client.connected.1    <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_client_connected&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.redis.hook.session.created.1     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_subscribe_lookup&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.redis.hook.client.disconnected.1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_client_disconnected&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.redis.hook.session.subscribed.1  <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;queue/#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_fetch_for_queue&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.redis.hook.session.subscribed.2  <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pubsub/#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_fetch_for_pubsub&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.redis.hook.session.subscribed.3  <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_retain_lookup&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.redis.hook.session.unsubscribed.1<span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;commands&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;DEL mqtt:acked:<span class="token variable">${clientid}</span>:<span class="token variable">${topic}</span>&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.redis.hook.message.publish.1     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_publish&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;expired_time&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">3600</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.redis.hook.message.publish.2     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_retain&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;expired_time&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">3600</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.redis.hook.message.publish.3     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_retain_delete&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.redis.hook.message.acked.1       <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;queue/#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_acked_for_queue&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.redis.hook.message.acked.2       <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pubsub/#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_acked_for_pubsub&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>

<span class="token comment">## backend.redis.hook.session.subscribed.1  = {&quot;topic&quot;: &quot;#&quot;, &quot;action&quot;: {&quot;function&quot;: &quot;on_message_fetch_for_keep_latest&quot;}, &quot;pool&quot;: &quot;pool1&quot;}</span>
<span class="token comment">## backend.redis.hook.message.publish.1     = {&quot;topic&quot;: &quot;#&quot;, &quot;action&quot;: {&quot;function&quot;: &quot;on_message_store_keep_latest&quot;}, &quot;expired_time&quot; : 3600, &quot;pool&quot;: &quot;pool1&quot;}</span>
<span class="token comment">## backend.redis.hook.message.acked.1       = {&quot;topic&quot;: &quot;#&quot;, &quot;action&quot;: {&quot;function&quot;: &quot;on_message_acked_for_keep_latest&quot;}, &quot;pool&quot;: &quot;pool1&quot;}</span>
</code></pre></div><h3 id="redis-存储规则说明"><a href="#redis-存储规则说明" class="header-anchor">#</a> Redis 存储规则说明</h3> <table><thead><tr><th>hook</th> <th>topic</th> <th>action/function</th> <th>说明</th></tr></thead> <tbody><tr><td>client.connected</td> <td></td> <td>on_client_connected</td> <td>存储客户端在线状态</td></tr> <tr><td>session.created</td> <td></td> <td>on_subscribe_lookup</td> <td>订阅主题</td></tr> <tr><td>client.disconnected</td> <td></td> <td>on_client_disconnected</td> <td>存储客户端离线状态</td></tr> <tr><td>session.subscribed</td> <td>queue/#</td> <td>on_message_fetch_for_queue</td> <td>获取一对一离线消息</td></tr> <tr><td>session.subscribed</td> <td>pubsub/#</td> <td>on_message_fetch_for_pubsub</td> <td>获取一对多离线消息</td></tr> <tr><td>session.subscribed</td> <td>#</td> <td>on_retain_lookup</td> <td>获取 retain 消息</td></tr> <tr><td>session.unsubscribed</td> <td>#</td> <td></td> <td>删除 acked 消息</td></tr> <tr><td>message.publish</td> <td>#</td> <td>on_message_publish</td> <td>存储发布消息</td></tr> <tr><td>message.publish</td> <td>#</td> <td>on_message_retain</td> <td>存储 retain 消息</td></tr> <tr><td>message.publish</td> <td>#</td> <td>on_retain_delete</td> <td>删除 retain 消息</td></tr> <tr><td>message.acked</td> <td>queue/#</td> <td>on_message_acked_for_queue</td> <td>一对一消息 ACK 处理</td></tr> <tr><td>message.acked</td> <td>pubsub/#</td> <td>on_message_acked_for_pubsub</td> <td>一对多消息 ACK 处理</td></tr></tbody></table> <h3 id="redis-命令行参数说明"><a href="#redis-命令行参数说明" class="header-anchor">#</a> Redis 命令行参数说明</h3> <table><thead><tr><th>hook</th> <th>可用参数</th> <th>示例(每个字段分隔，必须是一个空格)</th></tr></thead> <tbody><tr><td>client.connected</td> <td>clientid</td> <td>SET conn:${clientid} ${clientid}</td></tr> <tr><td>client.disconnected</td> <td>clientid</td> <td>SET disconn:${clientid} ${clientid}</td></tr> <tr><td>session.subscribed</td> <td>clientid, topic, qos</td> <td>HSET sub:${clientid} ${topic} ${qos}</td></tr> <tr><td>session.unsubscribed</td> <td>clientid, topic</td> <td>SET unsub:${clientid} ${topic}</td></tr> <tr><td>message.publish</td> <td>message, msgid, topic, payload, qos, clientid</td> <td>RPUSH pub:${topic} ${msgid}</td></tr> <tr><td>message.acked</td> <td>msgid, topic, clientid</td> <td>HSET ack:${clientid} ${topic} ${msgid}</td></tr> <tr><td>message.deliver</td> <td>msgid, topic, clientid</td> <td>HSET deliver:${clientid} ${topic} ${msgid}</td></tr></tbody></table> <h3 id="redis-命令行配置-action"><a href="#redis-命令行配置-action" class="header-anchor">#</a> Redis 命令行配置 Action</h3> <p>Redis 存储支持用户采用 Redis Commands 语句配置 Action，例如:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## 在客户端连接到 EMQ X 服务器后，执行一条 redis</span>
backend.redis.hook.client.connected.3 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;commands&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;SET conn:<span class="token variable">${clientid}</span> <span class="token variable">${clientid}</span>&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
</code></pre></div><h3 id="redis-设备在线状态-hash"><a href="#redis-设备在线状态-hash" class="header-anchor">#</a> Redis 设备在线状态 Hash</h3> <p><em>mqtt:client</em> Hash 存储设备在线状态:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>hmset
key <span class="token operator">=</span> mqtt:client:<span class="token variable">${clientid}</span>
value <span class="token operator">=</span> <span class="token punctuation">{</span>state:int, online_at:timestamp, offline_at:timestamp<span class="token punctuation">}</span>

hset
key <span class="token operator">=</span> mqtt:node:<span class="token variable">${node}</span>
field <span class="token operator">=</span> <span class="token variable">${clientid}</span>
value <span class="token operator">=</span> <span class="token variable">${ts}</span>
</code></pre></div><p>查询设备在线状态:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>HGETALL <span class="token string">&quot;mqtt:client:<span class="token variable">${clientId}</span>&quot;</span>
</code></pre></div><p>例如 ClientId 为 test 客户端上线:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>HGETALL mqtt:client:test
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;state&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;1&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;online_at&quot;</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">&quot;1481685802&quot;</span>
<span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">&quot;offline_at&quot;</span>
<span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">&quot;undefined&quot;</span>
</code></pre></div><p>例如 ClientId 为 test 客户端下线:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>HGETALL mqtt:client:test
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;state&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;0&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;online_at&quot;</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">&quot;1481685802&quot;</span>
<span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">&quot;offline_at&quot;</span>
<span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">&quot;1481685924&quot;</span>
</code></pre></div><h3 id="redis-保留消息-hash"><a href="#redis-保留消息-hash" class="header-anchor">#</a> Redis 保留消息 Hash</h3> <p><em>mqtt:retain</em> Hash 存储 Retain 消息:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>hmset
key <span class="token operator">=</span> mqtt:retain:<span class="token variable">${topic}</span>
value <span class="token operator">=</span> <span class="token punctuation">{</span>id: string, from: string, qos: int, topic: string, retain: int, payload: string, ts: timestamp<span class="token punctuation">}</span>
</code></pre></div><p>查询 retain 消息:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>HGETALL <span class="token string">&quot;mqtt:retain:<span class="token variable">${topic}</span>&quot;</span>
</code></pre></div><p>例如查看 topic 为 topic 的 retain 消息:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>    HGETALL mqtt:retain:topic
     <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;id&quot;</span>

<span class="token operator">&gt;</span>   -     <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;6P9NLcJ65VXBbC22sYb4&quot;</span>
<span class="token operator">&gt;</span>     
<span class="token operator">&gt;</span>     <span class="token number">3</span><span class="token punctuation">)</span>  <span class="token string">&quot;from&quot;</span>
<span class="token operator">&gt;</span> 
<span class="token operator">&gt;</span>   -     <span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">&quot;test&quot;</span>
<span class="token operator">&gt;</span>     
<span class="token operator">&gt;</span>     <span class="token number">5</span><span class="token punctuation">)</span>  <span class="token string">&quot;qos&quot;</span>
<span class="token operator">&gt;</span>     <span class="token number">6</span><span class="token punctuation">)</span>  <span class="token string">&quot;1&quot;</span>
<span class="token operator">&gt;</span>     <span class="token number">7</span><span class="token punctuation">)</span>  <span class="token string">&quot;topic&quot;</span>
<span class="token operator">&gt;</span>     <span class="token number">8</span><span class="token punctuation">)</span>  <span class="token string">&quot;topic&quot;</span>
<span class="token operator">&gt;</span>     <span class="token number">9</span><span class="token punctuation">)</span>  <span class="token string">&quot;retain&quot;</span>
<span class="token operator">&gt;</span> 
<span class="token operator">&gt;</span>   - <span class="token number">10</span><span class="token punctuation">\</span><span class="token punctuation">)</span> <span class="token string">&quot;true&quot;</span>
<span class="token operator">&gt;</span>     
<span class="token operator">&gt;</span>     <span class="token number">11</span><span class="token punctuation">)</span> <span class="token string">&quot;payload&quot;</span>
<span class="token operator">&gt;</span>     <span class="token number">12</span><span class="token punctuation">)</span> <span class="token string">&quot;Hello world\!&quot;</span>
<span class="token operator">&gt;</span>     <span class="token number">13</span><span class="token punctuation">)</span> <span class="token string">&quot;ts&quot;</span>
<span class="token operator">&gt;</span>     <span class="token number">14</span><span class="token punctuation">)</span> <span class="token string">&quot;1481690659&quot;</span>
</code></pre></div><h3 id="redis-消息存储-hash"><a href="#redis-消息存储-hash" class="header-anchor">#</a> Redis 消息存储 Hash</h3> <p><em>mqtt:msg</em> Hash 存储 MQTT 消息:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>hmset
key <span class="token operator">=</span> mqtt:msg:<span class="token variable">${msgid}</span>
value <span class="token operator">=</span> <span class="token punctuation">{</span>id: string, from: string, qos: int, topic: string, retain: int, payload: string, ts: timestamp<span class="token punctuation">}</span>

zadd
key <span class="token operator">=</span> mqtt:msg:<span class="token variable">${topic}</span>
field <span class="token operator">=</span> <span class="token number">1</span>
value <span class="token operator">=</span> <span class="token variable">${msgid}</span>
</code></pre></div><h3 id="redis-消息确认-set"><a href="#redis-消息确认-set" class="header-anchor">#</a> Redis 消息确认 SET</h3> <p><em>mqtt:acked</em> SET 存储客户端消息确认:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">set</span>
key <span class="token operator">=</span> mqtt:acked:<span class="token variable">${clientid}</span><span class="token builtin class-name">:</span><span class="token variable">${topic}</span>
value <span class="token operator">=</span> <span class="token variable">${msgid}</span>
</code></pre></div><h3 id="redis-订阅存储-hash"><a href="#redis-订阅存储-hash" class="header-anchor">#</a> Redis 订阅存储 Hash</h3> <p><em>mqtt:sub</em> Hash 存储订阅关系:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>hset
key <span class="token operator">=</span> mqtt:sub:<span class="token variable">${clientid}</span>
field <span class="token operator">=</span> <span class="token variable">${topic}</span>
value <span class="token operator">=</span> <span class="token variable">${qos}</span>
</code></pre></div><p>某个客户端订阅主题:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>HSET mqtt:sub:<span class="token variable">${clientid}</span> <span class="token variable">${topic}</span> <span class="token variable">${qos}</span>
</code></pre></div><p>例如为 ClientId 为 test 的客户端订阅主题 topic1, topic2 :</p> <div class="language-bash extra-class"><pre class="language-bash"><code>HSET <span class="token string">&quot;mqtt:sub:test&quot;</span> <span class="token string">&quot;topic1&quot;</span> <span class="token number">1</span>
HSET <span class="token string">&quot;mqtt:sub:test&quot;</span> <span class="token string">&quot;topic2&quot;</span> <span class="token number">2</span>
</code></pre></div><p>查询 ClientId 为 test 的客户端已订阅主题:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>HGETALL mqtt:sub:test
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;topic1&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;1&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;topic2&quot;</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">&quot;2&quot;</span>
</code></pre></div><h3 id="redis-sub-unsub-事件发布"><a href="#redis-sub-unsub-事件发布" class="header-anchor">#</a> Redis SUB/UNSUB 事件发布</h3> <p>设备需要订阅/取消订阅主题时，业务服务器向 Redis 发布事件消息:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>PUBLISH
channel <span class="token operator">=</span> <span class="token string">&quot;mqtt_channel&quot;</span>
message <span class="token operator">=</span> <span class="token punctuation">{</span>type: string , topic: string, clientid: string, qos: int<span class="token punctuation">}</span>
<span class="token punctuation">\</span>*type: <span class="token punctuation">[</span>subscribe/unsubscribe<span class="token punctuation">]</span>
</code></pre></div><p>例如 ClientId 为 test 客户端订阅主题 topic0:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>PUBLISH <span class="token string">&quot;mqtt_channel&quot;</span> <span class="token string">&quot;{<span class="token entity" title="\&quot;">\&quot;</span>type<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>subscribe<span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>topic<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>topic0<span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>clientid<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>test<span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>qos<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>0<span class="token entity" title="\&quot;">\&quot;</span>}&quot;</span>
</code></pre></div><p>例如 ClientId 为 test 客户端取消订阅主题:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>PUBLISH <span class="token string">&quot;mqtt_channel&quot;</span> <span class="token string">&quot;{<span class="token entity" title="\&quot;">\&quot;</span>type<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>unsubscribe<span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>topic<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>test_topic0<span class="token entity" title="\&quot;">\&quot;</span>, <span class="token entity" title="\&quot;">\&quot;</span>clientid<span class="token entity" title="\&quot;">\&quot;</span>: <span class="token entity" title="\&quot;">\&quot;</span>test<span class="token entity" title="\&quot;">\&quot;</span>}&quot;</span>
</code></pre></div><div class="custom-block danger"><p class="custom-block-title">警告</p> <p>Redis Cluster 无法使用 Redis PUB/SUB 功能。</p></div> <h3 id="启用-redis-数据存储插件"><a href="#启用-redis-数据存储插件" class="header-anchor">#</a> 启用 Redis 数据存储插件</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>./bin/emqx_ctl plugins load emqx_backend_redis
</code></pre></div><h2 id="mysql-数据存储"><a href="#mysql-数据存储" class="header-anchor">#</a> MySQL 数据存储</h2> <p>配置文件: emqx_backend_mysql.conf</p> <h3 id="配置-mysql-服务器"><a href="#配置-mysql-服务器" class="header-anchor">#</a> 配置 MySQL 服务器</h3> <p>支持配置多台 MySQL 服务器连接池:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## Mysql 服务器地址</span>
backend.mysql.pool1.server <span class="token operator">=</span> <span class="token number">127.0</span>.0.1:3306

<span class="token comment">## Mysql 连接池大小</span>
backend.mysql.pool1.pool_size <span class="token operator">=</span> <span class="token number">8</span>

<span class="token comment">## Mysql 用户名</span>
backend.mysql.pool1.user <span class="token operator">=</span> root

<span class="token comment">## Mysql 密码</span>
backend.mysql.pool1.password <span class="token operator">=</span> public

<span class="token comment">## Mysql 数据库名称</span>
backend.mysql.pool1.database <span class="token operator">=</span> mqtt
</code></pre></div><h3 id="配置-mysql-存储规则"><a href="#配置-mysql-存储规则" class="header-anchor">#</a> 配置 MySQL 存储规则</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>backend.mysql.hook.client.connected.1    <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_client_connected&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.mysql.hook.session.created.1     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_subscribe_lookup&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.mysql.hook.client.disconnected.1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_client_disconnected&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.mysql.hook.session.subscribed.1  <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_fetch&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.mysql.hook.session.subscribed.2  <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_retain_lookup&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.mysql.hook.session.unsubscribed.1<span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;sql&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;delete from mqtt_acked where clientid = <span class="token variable">${clientid}</span> and topic = <span class="token variable">${topic}</span>&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.mysql.hook.message.publish.1     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_publish&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.mysql.hook.message.publish.2     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_retain&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.mysql.hook.message.publish.3     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_retain_delete&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.mysql.hook.message.acked.1       <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_acked&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>

<span class="token comment">## 获取离线消息</span>
<span class="token comment">### &quot;offline_opts&quot;: 获取离线消息的配置</span>
<span class="token comment">####   - max_returned_count: 单次拉去的最大离线消息数目</span>
<span class="token comment">####   - time_range: 仅拉去在当前时间范围的消息</span>
<span class="token comment">## backend.mysql.hook.session.subscribed.1  = {&quot;topic&quot;: &quot;#&quot;, &quot;action&quot;: {&quot;function&quot;: &quot;on_message_fetch&quot;}, &quot;offline_opts&quot;: {&quot;max_returned_count&quot;: 500, &quot;time_range&quot;: &quot;2h&quot;}, &quot;pool&quot;: &quot;pool1&quot;}</span>

<span class="token comment">## 如果需要存储 Qos0 消息, 可开启以下配置</span>
<span class="token comment">## 警告: 当开启以下配置时, 需关闭 'on_message_fetch', 否则 qos1, qos2 消息会被存储俩次</span>
<span class="token comment">## backend.mysql.hook.message.publish.4     = {&quot;topic&quot;: &quot;#&quot;, &quot;action&quot;: {&quot;function&quot;: &quot;on_message_store&quot;}, &quot;pool&quot;: &quot;pool1&quot;}</span>
</code></pre></div><h3 id="mysql-存储规则说明"><a href="#mysql-存储规则说明" class="header-anchor">#</a> MySQL 存储规则说明</h3> <table><thead><tr><th>hook</th> <th>topic</th> <th>action</th> <th>说明</th></tr></thead> <tbody><tr><td>client.connected</td> <td></td> <td>on_client_connected</td> <td>存储客户端在线状态</td></tr> <tr><td>session.created</td> <td></td> <td>on_subscribe_lookup</td> <td>订阅主题</td></tr> <tr><td>client.disconnected</td> <td></td> <td>on_client_disconnected</td> <td>存储客户端离线状态</td></tr> <tr><td>session.subscribed</td> <td>#</td> <td>on_message_fetch</td> <td>获取离线消息</td></tr> <tr><td>session.subscribed</td> <td>#</td> <td>on_retain_lookup</td> <td>获取retain消息</td></tr> <tr><td>message.publish</td> <td>#</td> <td>on_message_publish</td> <td>存储发布消息</td></tr> <tr><td>message.publish</td> <td>#</td> <td>on_message_retain</td> <td>存储retain消息</td></tr> <tr><td>message.publish</td> <td>#</td> <td>on_retain_delete</td> <td>删除retain消息</td></tr> <tr><td>message.acked</td> <td>#</td> <td>on_message_acked</td> <td>消息ACK处理</td></tr></tbody></table> <h3 id="sql-语句参数说明"><a href="#sql-语句参数说明" class="header-anchor">#</a> SQL 语句参数说明</h3> <table><thead><tr><th>hook</th> <th>可用参数</th> <th>示例(sql语句中${name} 表示可获取的参数)</th></tr></thead> <tbody><tr><td>client.connected</td> <td>clientid</td> <td>insert into conn(clientid) values(${clientid})</td></tr> <tr><td>client.disconnected</td> <td>clientid</td> <td>insert into disconn(clientid) values(${clientid})</td></tr> <tr><td>session.subscribed</td> <td>clientid, topic, qos</td> <td>insert into sub(topic, qos) values(${topic}, ${qos})</td></tr> <tr><td>session.unsubscribed</td> <td>clientid, topic</td> <td>delete from sub where topic = ${topic}</td></tr> <tr><td>message.publish</td> <td>msgid, topic, payload, qos, clientid</td> <td>insert into msg(msgid, topic) values(${msgid}, ${topic})</td></tr> <tr><td>message.acked</td> <td>msgid, topic, clientid</td> <td>insert into ack(msgid, topic) values(${msgid}, ${topic})</td></tr> <tr><td>message.deliver</td> <td>msgid, topic, clientid</td> <td>insert into deliver(msgid, topic) values(${msgid}, ${topic})</td></tr></tbody></table> <h3 id="sql-语句配置-action"><a href="#sql-语句配置-action" class="header-anchor">#</a> SQL 语句配置 Action</h3> <p>MySQL 存储支持用户采用 SQL 语句配置 Action:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## 在客户端连接到 EMQ X 服务器后，执行一条 sql 语句(支持多条 sql 语句)</span>
backend.mysql.hook.client.connected.3 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;sql&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;insert into conn(clientid) values(<span class="token variable">${clientid}</span>)&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
</code></pre></div><h3 id="创建-mysql-数据库表"><a href="#创建-mysql-数据库表" class="header-anchor">#</a> 创建 MySQL 数据库表</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">database</span> mqtt<span class="token punctuation">;</span>
</code></pre></div><h3 id="导入-mysql-库表结构"><a href="#导入-mysql-库表结构" class="header-anchor">#</a> 导入 MySQL 库表结构</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>mysql -u root -p mqtt <span class="token operator">&lt;</span> etc/sql/emqx_backend_mysql.sql
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p>数据库名称可自定义</p></div> <h3 id="mysql-设备在线状态表"><a href="#mysql-设备在线状态表" class="header-anchor">#</a> MySQL 设备在线状态表</h3> <p><em>mqtt_client</em> 存储设备在线状态:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>mqtt_client<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>mqtt_client<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>clientid<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>state<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>node<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>online_at<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>offline_at<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>created<span class="token punctuation">`</span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>mqtt_client_idx<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>clientid<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>mqtt_client_key<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>clientid<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">INDEX</span> topic_index<span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>clientid<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8MB4<span class="token punctuation">;</span>
</code></pre></div><p>查询设备在线状态:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">select</span> * from mqtt_client where clientid <span class="token operator">=</span> <span class="token variable">${clientid}</span><span class="token punctuation">;</span>
</code></pre></div><p>例如 ClientId 为 test 客户端上线:</p> <div class="language-bash extra-class"><pre class="language-bash"><code> <span class="token keyword">select</span> * from mqtt_client where clientid <span class="token operator">=</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">;</span>

+----+----------+-------+----------------+---------------------+---------------------+---------------------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> clientid <span class="token operator">|</span> state <span class="token operator">|</span> node           <span class="token operator">|</span> online_at           <span class="token operator">|</span> offline_at          <span class="token operator">|</span> created             <span class="token operator">|</span>
+----+----------+-------+----------------+---------------------+---------------------+---------------------+
   <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token builtin class-name">test</span>     <span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span> emqx@127.0.0.1 <span class="token operator">|</span> <span class="token number">2016</span>-11-15 09:40:40 <span class="token operator">|</span> NULL                <span class="token operator">|</span> <span class="token number">2016</span>-12-24 09:40:22 <span class="token operator">|</span>
+----+----------+-------+----------------+---------------------+---------------------+---------------------+
<span class="token number">1</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre></div><p>例如 ClientId 为 test 客户端下线:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">select</span> * from mqtt_client where clientid <span class="token operator">=</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">;</span>

+----+----------+-------+----------------+---------------------+---------------------+---------------------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> clientid <span class="token operator">|</span> state <span class="token operator">|</span> node           <span class="token operator">|</span> online_at           <span class="token operator">|</span> offline_at          <span class="token operator">|</span> created             <span class="token operator">|</span>
+----+----------+-------+----------------+---------------------+---------------------+---------------------+
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token builtin class-name">test</span>     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span> emqx@127.0.0.1 <span class="token operator">|</span> <span class="token number">2016</span>-11-15 09:40:40 <span class="token operator">|</span> <span class="token number">2016</span>-11-15 09:46:10 <span class="token operator">|</span> <span class="token number">2016</span>-12-24 09:40:22 <span class="token operator">|</span>
+----+----------+-------+----------------+---------------------+---------------------+---------------------+
<span class="token number">1</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre></div><h3 id="mysql-主题订阅表"><a href="#mysql-主题订阅表" class="header-anchor">#</a> MySQL 主题订阅表</h3> <p><em>mqtt_sub</em> 存储设备的主题订阅关系:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>mqtt_sub<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>mqtt_sub<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>clientid<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>topic<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>qos<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>created<span class="token punctuation">`</span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>mqtt_sub_idx<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>clientid<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>topic<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>qos<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>mqtt_sub_key<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>clientid<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>topic<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">INDEX</span> topic_index<span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>topic<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8MB4<span class="token punctuation">;</span>
</code></pre></div><p>例如 ClientId 为 test 客户端订阅主题 test_topic1 test_topic2:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> mqtt_sub<span class="token punctuation">(</span>clientid<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> qos<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test_topic1&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> mqtt_sub<span class="token punctuation">(</span>clientid<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> qos<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test_topic2&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>某个客户端订阅主题:</p> <div class="language-bash extra-class"><pre class="language-bash"><code> <span class="token keyword">select</span> * from mqtt_sub where clientid <span class="token operator">=</span> <span class="token variable">${clientid}</span><span class="token punctuation">;</span>
</code></pre></div><p>查询 ClientId 为 test 的客户端已订阅主题:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">select</span> * from mqtt_sub where clientid <span class="token operator">=</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">;</span>

+----+--------------+-------------+------+---------------------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> clientId     <span class="token operator">|</span> topic       <span class="token operator">|</span> qos  <span class="token operator">|</span> created             <span class="token operator">|</span>
+----+--------------+-------------+------+---------------------+
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token builtin class-name">test</span>         <span class="token operator">|</span> test_topic1 <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2016</span>-12-24 <span class="token number">17</span>:09:05 <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> <span class="token builtin class-name">test</span>         <span class="token operator">|</span> test_topic2 <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">2016</span>-12-24 <span class="token number">17</span>:12:51 <span class="token operator">|</span>
+----+--------------+-------------+------+---------------------+
<span class="token number">2</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre></div><h3 id="mysql-消息存储表"><a href="#mysql-消息存储表" class="header-anchor">#</a> MySQL 消息存储表</h3> <p><em>mqtt_msg</em> 存储 MQTT 消息:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>mqtt_msg<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>mqtt_msg<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>msgid<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>topic<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>sender<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>node<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>qos<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>retain<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>payload<span class="token punctuation">`</span> <span class="token keyword">blob</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>arrived<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">INDEX</span> topic_index<span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>topic<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8MB4<span class="token punctuation">;</span>
</code></pre></div><p>查询某个客户端发布的消息:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mqtt_msg <span class="token keyword">where</span> sender <span class="token operator">=</span> ${clientid}<span class="token punctuation">;</span>
</code></pre></div><p>查询 ClientId 为 test 的客户端发布的消息:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">select</span> * from mqtt_msg where sender <span class="token operator">=</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">;</span>

+----+-------------------------------+----------+--------+------+-----+--------+---------+---------------------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> msgid                         <span class="token operator">|</span> topic    <span class="token operator">|</span> sender <span class="token operator">|</span> node <span class="token operator">|</span> qos <span class="token operator">|</span> retain <span class="token operator">|</span> payload <span class="token operator">|</span> arrived             <span class="token operator">|</span>
+----+-------------------------------+----------+--------+------+-----+--------+---------+---------------------+
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> 53F98F80F66017005000004A60003 <span class="token operator">|</span> hello    <span class="token operator">|</span> <span class="token builtin class-name">test</span>   <span class="token operator">|</span> NULL <span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span>      <span class="token number">0</span> <span class="token operator">|</span> hello   <span class="token operator">|</span> <span class="token number">2016</span>-12-24 <span class="token number">17</span>:25:12 <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span> 53F98F9FE42AD7005000004A60004 <span class="token operator">|</span> world    <span class="token operator">|</span> <span class="token builtin class-name">test</span>   <span class="token operator">|</span> NULL <span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span>      <span class="token number">0</span> <span class="token operator">|</span> world   <span class="token operator">|</span> <span class="token number">2016</span>-12-24 <span class="token number">17</span>:25:45 <span class="token operator">|</span>
+----+-------------------------------+----------+--------+------+-----+--------+---------+---------------------+
<span class="token number">2</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre></div><h3 id="mysql-保留消息表"><a href="#mysql-保留消息表" class="header-anchor">#</a> MySQL 保留消息表</h3> <p>mqtt_retain 存储 retain 消息:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>mqtt_retain<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>mqtt_retain<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>topic<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>msgid<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>sender<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>node<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>qos<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>payload<span class="token punctuation">`</span> <span class="token keyword">blob</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>arrived<span class="token punctuation">`</span> <span class="token keyword">timestamp</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>mqtt_retain_key<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>topic<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">INDEX</span> topic_index<span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>topic<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8MB4<span class="token punctuation">;</span>
</code></pre></div><p>查询 retain 消息:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mqtt_retain <span class="token keyword">where</span> topic <span class="token operator">=</span> ${topic}<span class="token punctuation">;</span>
</code></pre></div><p>查询 topic 为 retain 的 retain 消息:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">select</span> * from mqtt_retain where topic <span class="token operator">=</span> <span class="token string">&quot;retain&quot;</span><span class="token punctuation">;</span>

+----+----------+-------------------------------+---------+------+------+---------+---------------------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> topic    <span class="token operator">|</span> msgid                         <span class="token operator">|</span> sender  <span class="token operator">|</span> node <span class="token operator">|</span> qos  <span class="token operator">|</span> payload <span class="token operator">|</span> arrived             <span class="token operator">|</span>
+----+----------+-------------------------------+---------+------+------+---------+---------------------+
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> retain   <span class="token operator">|</span> 53F33F7E4741E7007000004B70001 <span class="token operator">|</span> <span class="token builtin class-name">test</span>    <span class="token operator">|</span> NULL <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> www     <span class="token operator">|</span> <span class="token number">2016</span>-12-24 <span class="token number">16</span>:55:18 <span class="token operator">|</span>
+----+----------+-------------------------------+---------+------+------+---------+---------------------+


<span class="token operator">&gt;</span>    <span class="token number">1</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

</code></pre></div><h3 id="mysql-消息确认表"><a href="#mysql-消息确认表" class="header-anchor">#</a> MySQL 消息确认表</h3> <p><em>mqtt_acked</em> 存储客户端消息确认:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>mqtt_acked<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>mqtt_acked<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>clientid<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>topic<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>mid<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>created<span class="token punctuation">`</span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>mqtt_acked_key<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>clientid<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>topic<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">INDEX</span> topic_index<span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>topic<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8MB4<span class="token punctuation">;</span>
</code></pre></div><h3 id="启用-mysql-数据存储插件"><a href="#启用-mysql-数据存储插件" class="header-anchor">#</a> 启用 MySQL 数据存储插件</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>./bin/emqx_ctl plugins load emqx_backend_mysql
</code></pre></div><h2 id="postgresql-数据存储"><a href="#postgresql-数据存储" class="header-anchor">#</a> PostgreSQL 数据存储</h2> <p>配置文件: emqx_backend_pgsql.conf</p> <h3 id="配置-postgresql-服务器"><a href="#配置-postgresql-服务器" class="header-anchor">#</a> 配置 PostgreSQL 服务器</h3> <p>支持配置多台PostgreSQL服务器连接池:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## Pgsql 服务器地址</span>
backend.pgsql.pool1.server <span class="token operator">=</span> <span class="token number">127.0</span>.0.1:5432

<span class="token comment">## Pgsql 连接池大小</span>
backend.pgsql.pool1.pool_size <span class="token operator">=</span> <span class="token number">8</span>

<span class="token comment">## Pgsql 用户名</span>
backend.pgsql.pool1.username <span class="token operator">=</span> root

<span class="token comment">## Pgsql 密码</span>
backend.pgsql.pool1.password <span class="token operator">=</span> public

<span class="token comment">## Pgsql 数据库名称</span>
backend.pgsql.pool1.database <span class="token operator">=</span> mqtt

<span class="token comment">## Pgsql Ssl</span>
backend.pgsql.pool1.ssl <span class="token operator">=</span> <span class="token boolean">false</span>
</code></pre></div><h3 id="配置-postgresql-存储规则"><a href="#配置-postgresql-存储规则" class="header-anchor">#</a> 配置 PostgreSQL 存储规则</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>backend.pgsql.hook.client.connected.1    <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_client_connected&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.pgsql.hook.session.created.1     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_subscribe_lookup&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.pgsql.hook.client.disconnected.1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_client_disconnected&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.pgsql.hook.session.subscribed.1  <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_fetch&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.pgsql.hook.session.subscribed.2  <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_retain_lookup&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.pgsql.hook.session.unsubscribed.1<span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;sql&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;delete from mqtt_acked where clientid = <span class="token variable">${clientid}</span> and topic = <span class="token variable">${topic}</span>&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.pgsql.hook.message.publish.1     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_publish&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.pgsql.hook.message.publish.2     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_retain&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.pgsql.hook.message.publish.3     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_retain_delete&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.pgsql.hook.message.acked.1       <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_acked&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>

<span class="token comment">## 获取离线消息</span>
<span class="token comment">### &quot;offline_opts&quot;: 获取离线消息的配置</span>
<span class="token comment">####   - max_returned_count: 单次拉去的最大离线消息数目</span>
<span class="token comment">####   - time_range: 仅拉去在当前时间范围的消息</span>
<span class="token comment">## backend.pgsql.hook.session.subscribed.1  = {&quot;topic&quot;: &quot;#&quot;, &quot;action&quot;: {&quot;function&quot;: &quot;on_message_fetch&quot;}, &quot;offline_opts&quot;: {&quot;max_returned_count&quot;: 500, &quot;time_range&quot;: &quot;2h&quot;}, &quot;pool&quot;: &quot;pool1&quot;}</span>

<span class="token comment">## 如果需要存储 Qos0 消息, 可开启以下配置</span>
<span class="token comment">## 警告: 当开启以下配置时, 需关闭 'on_message_fetch', 否则 qos1, qos2 消息会被存储俩次</span>
<span class="token comment">## backend.pgsql.hook.message.publish.4     = {&quot;topic&quot;: &quot;#&quot;, &quot;action&quot;: {&quot;function&quot;: &quot;on_message_store&quot;}, &quot;pool&quot;: &quot;pool1&quot;}</span>
</code></pre></div><h3 id="postgresql-存储规则说明"><a href="#postgresql-存储规则说明" class="header-anchor">#</a> PostgreSQL 存储规则说明</h3> <table><thead><tr><th>hook</th> <th>topic</th> <th>action</th> <th>说明</th></tr></thead> <tbody><tr><td>client.connected</td> <td></td> <td>on_client_connected</td> <td>存储客户端在线状态</td></tr> <tr><td>session.created</td> <td></td> <td>on_subscribe_lookup</td> <td>订阅主题</td></tr> <tr><td>client.disconnected</td> <td></td> <td>on_client_disconnected</td> <td>存储客户端离线状态</td></tr> <tr><td>session.subscribed</td> <td>#</td> <td>on_message_fetch</td> <td>获取离线消息</td></tr> <tr><td>session.subscribed</td> <td>#</td> <td>on_retain_lookup</td> <td>获取 retain 消息</td></tr> <tr><td>message.publish</td> <td>#</td> <td>on_message_publish</td> <td>存储发布消息</td></tr> <tr><td>message.publish</td> <td>#</td> <td>on_message_retain</td> <td>存储 retain 消息</td></tr> <tr><td>message.publish</td> <td>#</td> <td>on_retain_delete</td> <td>删除 retain 消息</td></tr> <tr><td>message.acked</td> <td>#</td> <td>on_message_acked</td> <td>消息 ACK 处理</td></tr></tbody></table> <h3 id="sql-语句参数说明-2"><a href="#sql-语句参数说明-2" class="header-anchor">#</a> SQL 语句参数说明</h3> <table><thead><tr><th>hook</th> <th>可用参数</th> <th>示例(sql语句中${name} 表示可获取的参数)</th></tr></thead> <tbody><tr><td>client.connected</td> <td>clientid</td> <td>insert into conn(clientid) values(${clientid})</td></tr> <tr><td>client.disconnected</td> <td>clientid</td> <td>insert into disconn(clientid) values(${clientid})</td></tr> <tr><td>session.subscribed</td> <td>clientid, topic, qos</td> <td>insert into sub(topic, qos) values(${topic}, ${qos})</td></tr> <tr><td>session.unsubscribed</td> <td>clientid, topic</td> <td>delete from sub where topic = ${topic}</td></tr> <tr><td>message.publish</td> <td>msgid, topic, payload, qos, clientid</td> <td>insert into msg(msgid, topic) values(${msgid}, ${topic})</td></tr> <tr><td>message.acked</td> <td>msgid, topic, clientid</td> <td>insert into ack(msgid, topic) values(${msgid}, ${topic})</td></tr> <tr><td>message.deliver</td> <td>msgid, topic, clientid</td> <td>insert into deliver(msgid, topic) values(${msgid}, ${topic})</td></tr></tbody></table> <h3 id="sql-语句配置-action-2"><a href="#sql-语句配置-action-2" class="header-anchor">#</a> SQL 语句配置 Action</h3> <p>PostgreSQL 存储支持用户采用SQL语句配置 Action，例如:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## 在客户端连接到 EMQ X 服务器后，执行一条 sql 语句(支持多条sql语句)</span>
backend.pgsql.hook.client.connected.3 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;sql&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;insert into conn(clientid) values(<span class="token variable">${clientid}</span>)&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
</code></pre></div><h3 id="创建-postgresql-数据库"><a href="#创建-postgresql-数据库" class="header-anchor">#</a> 创建 PostgreSQL 数据库</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>createdb mqtt -E UTF8 -e
</code></pre></div><h3 id="导入-postgresql-库表结构"><a href="#导入-postgresql-库表结构" class="header-anchor">#</a> 导入 PostgreSQL 库表结构</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">\</span>i etc/sql/emqx_backend_pgsql.sql
</code></pre></div><h3 id="postgresql-设备在线状态表"><a href="#postgresql-设备在线状态表" class="header-anchor">#</a> PostgreSQL 设备在线状态表</h3> <p><em>mqtt_client</em> 存储设备在线状态:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>CREATE TABLE mqtt_client<span class="token punctuation">(</span>
  <span class="token function">id</span> SERIAL8 primary key,
  clientid character varying<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span>,
  state integer,
  node character varying<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span>,
  online_at timestamp ,
  offline_at timestamp,
  created timestamp without <span class="token function">time</span> zone,
  UNIQUE <span class="token punctuation">(</span>clientid<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>查询设备在线状态:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mqtt_client <span class="token keyword">where</span> clientid <span class="token operator">=</span> ${clientid}<span class="token punctuation">;</span>
</code></pre></div><p>例如 ClientId 为 test 客户端上线:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">select</span> * from mqtt_client where clientid <span class="token operator">=</span> <span class="token string">'test'</span><span class="token punctuation">;</span>

  <span class="token function">id</span> <span class="token operator">|</span> clientid <span class="token operator">|</span> state <span class="token operator">|</span> node             <span class="token operator">|</span> online_at           <span class="token operator">|</span> offline_at        <span class="token operator">|</span> created
----+----------+-------+----------------+---------------------+---------------------+---------------------
   <span class="token number">1</span> <span class="token operator">|</span> <span class="token builtin class-name">test</span>     <span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span> emqx@127.0.0.1 <span class="token operator">|</span> <span class="token number">2016</span>-11-15 09:40:40 <span class="token operator">|</span> NULL                <span class="token operator">|</span> <span class="token number">2016</span>-12-24 09:40:22
<span class="token punctuation">(</span><span class="token number">1</span> rows<span class="token punctuation">)</span>
</code></pre></div><p>例如 ClientId 为 test 客户端下线:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">select</span> * from mqtt_client where clientid <span class="token operator">=</span> <span class="token string">'test'</span><span class="token punctuation">;</span>

  <span class="token function">id</span> <span class="token operator">|</span> clientid <span class="token operator">|</span> state <span class="token operator">|</span> nod            <span class="token operator">|</span> online_at           <span class="token operator">|</span> offline_at          <span class="token operator">|</span> created
----+----------+-------+----------------+---------------------+---------------------+---------------------
  <span class="token number">1</span> <span class="token operator">|</span> <span class="token builtin class-name">test</span>     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span> emqx@127.0.0.1 <span class="token operator">|</span> <span class="token number">2016</span>-11-15 09:40:40 <span class="token operator">|</span> <span class="token number">2016</span>-11-15 09:46:10 <span class="token operator">|</span> <span class="token number">2016</span>-12-24 09:40:22
<span class="token punctuation">(</span><span class="token number">1</span> rows<span class="token punctuation">)</span>
</code></pre></div><h3 id="postgresql-代理订阅表"><a href="#postgresql-代理订阅表" class="header-anchor">#</a> PostgreSQL 代理订阅表</h3> <p><em>mqtt_sub</em> 存储订阅关系:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> mqtt_sub<span class="token punctuation">(</span>
  id SERIAL8 <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
  clientid <span class="token keyword">character</span> <span class="token keyword">varying</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  topic <span class="token keyword">character</span> <span class="token keyword">varying</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  qos <span class="token keyword">integer</span><span class="token punctuation">,</span>
  created <span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone<span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token punctuation">(</span>clientid<span class="token punctuation">,</span> topic<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>例如 ClientId 为 test 客户端订阅主题 test_topic1 test_topic2:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> mqtt_sub<span class="token punctuation">(</span>clientid<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> qos<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token string">'test_topic1'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> mqtt_sub<span class="token punctuation">(</span>clientid<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> qos<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token string">'test_topic2'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>某个客户端订阅主题:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">select</span> * from mqtt_sub where clientid <span class="token operator">=</span> <span class="token variable">${clientid}</span><span class="token punctuation">;</span>
</code></pre></div><p>查询 ClientId 为 test 的客户端已订阅主题:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">select</span> * from mqtt_sub where clientid <span class="token operator">=</span> <span class="token string">'test'</span><span class="token punctuation">;</span>

 <span class="token function">id</span> <span class="token operator">|</span> clientId     <span class="token operator">|</span> topic       <span class="token operator">|</span> qos  <span class="token operator">|</span> created
----+--------------+-------------+------+---------------------
  <span class="token number">1</span> <span class="token operator">|</span> <span class="token builtin class-name">test</span>         <span class="token operator">|</span> test_topic1 <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2016</span>-12-24 <span class="token number">17</span>:09:05
  <span class="token number">2</span> <span class="token operator">|</span> <span class="token builtin class-name">test</span>         <span class="token operator">|</span> test_topic2 <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">2016</span>-12-24 <span class="token number">17</span>:12:51
<span class="token punctuation">(</span><span class="token number">2</span> rows<span class="token punctuation">)</span>
</code></pre></div><h3 id="postgresql-消息存储表"><a href="#postgresql-消息存储表" class="header-anchor">#</a> PostgreSQL 消息存储表</h3> <p><em>mqtt_msg</em> 存储MQTT消息:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> mqtt_msg <span class="token punctuation">(</span>
  id SERIAL8 <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
  msgid <span class="token keyword">character</span> <span class="token keyword">varying</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  sender <span class="token keyword">character</span> <span class="token keyword">varying</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  topic <span class="token keyword">character</span> <span class="token keyword">varying</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  qos <span class="token keyword">integer</span><span class="token punctuation">,</span>
  retain <span class="token keyword">integer</span><span class="token punctuation">,</span>
  payload <span class="token keyword">text</span><span class="token punctuation">,</span>
  arrived <span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>查询某个客户端发布的消息:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mqtt_msg <span class="token keyword">where</span> sender <span class="token operator">=</span> ${clientid}<span class="token punctuation">;</span>
</code></pre></div><p>查询 ClientId 为 test 的客户端发布的消息:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">select</span> * from mqtt_msg where sender <span class="token operator">=</span> <span class="token string">'test'</span><span class="token punctuation">;</span>

  <span class="token function">id</span> <span class="token operator">|</span> msgid                         <span class="token operator">|</span> topic    <span class="token operator">|</span> sender <span class="token operator">|</span> node <span class="token operator">|</span> qos <span class="token operator">|</span> retain <span class="token operator">|</span> payload <span class="token operator">|</span> arrived
----+-------------------------------+----------+--------+------+-----+--------+---------+---------------------
  <span class="token number">1</span>  <span class="token operator">|</span> 53F98F80F66017005000004A60003 <span class="token operator">|</span> hello    <span class="token operator">|</span> <span class="token builtin class-name">test</span>   <span class="token operator">|</span> NULL <span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span>      <span class="token number">0</span> <span class="token operator">|</span> hello   <span class="token operator">|</span> <span class="token number">2016</span>-12-24 <span class="token number">17</span>:25:12
  <span class="token number">2</span>  <span class="token operator">|</span> 53F98F9FE42AD7005000004A60004 <span class="token operator">|</span> world    <span class="token operator">|</span> <span class="token builtin class-name">test</span>   <span class="token operator">|</span> NULL <span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span>      <span class="token number">0</span> <span class="token operator">|</span> world   <span class="token operator">|</span> <span class="token number">2016</span>-12-24 <span class="token number">17</span>:25:45
<span class="token punctuation">(</span><span class="token number">2</span> rows<span class="token punctuation">)</span>
</code></pre></div><h3 id="postgresql-保留消息表"><a href="#postgresql-保留消息表" class="header-anchor">#</a> PostgreSQL 保留消息表</h3> <p><em>mqtt_retain</em> 存储 Retain 消息:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> mqtt_retain<span class="token punctuation">(</span>
  id SERIAL8 <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
  topic <span class="token keyword">character</span> <span class="token keyword">varying</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  msgid <span class="token keyword">character</span> <span class="token keyword">varying</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  sender <span class="token keyword">character</span> <span class="token keyword">varying</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  qos <span class="token keyword">integer</span><span class="token punctuation">,</span>
  payload <span class="token keyword">text</span><span class="token punctuation">,</span>
  arrived <span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone<span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token punctuation">(</span>topic<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>查询 retain 消息:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mqtt_retain <span class="token keyword">where</span> topic <span class="token operator">=</span> ${topic}<span class="token punctuation">;</span>
</code></pre></div><p>查询 topic 为 retain 的 retain 消息:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">select</span> * from mqtt_retain where topic <span class="token operator">=</span> <span class="token string">'retain'</span><span class="token punctuation">;</span>

  <span class="token function">id</span> <span class="token operator">|</span> topic    <span class="token operator">|</span> msgid                         <span class="token operator">|</span> sender  <span class="token operator">|</span> node <span class="token operator">|</span> qos  <span class="token operator">|</span> payload <span class="token operator">|</span> arrived
----+----------+-------------------------------+---------+------+------+---------+---------------------
  <span class="token number">1</span> <span class="token operator">|</span> retain   <span class="token operator">|</span> 53F33F7E4741E7007000004B70001 <span class="token operator">|</span> <span class="token builtin class-name">test</span>    <span class="token operator">|</span> NULL <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> www     <span class="token operator">|</span> <span class="token number">2016</span>-12-24 <span class="token number">16</span>:55:18
<span class="token punctuation">(</span><span class="token number">1</span> rows<span class="token punctuation">)</span>
</code></pre></div><h3 id="postgresql-消息确认表"><a href="#postgresql-消息确认表" class="header-anchor">#</a> PostgreSQL 消息确认表</h3> <p><em>mqtt_acked</em> 存储客户端消息确认:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> mqtt_acked <span class="token punctuation">(</span>
  id SERIAL8 <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
  clientid <span class="token keyword">character</span> <span class="token keyword">varying</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  topic <span class="token keyword">character</span> <span class="token keyword">varying</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  mid <span class="token keyword">integer</span><span class="token punctuation">,</span>
  created <span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone<span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token punctuation">(</span>clientid<span class="token punctuation">,</span> topic<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="启用-postgresql-数据存储插件"><a href="#启用-postgresql-数据存储插件" class="header-anchor">#</a> 启用 PostgreSQL 数据存储插件</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>./bin/emqx_ctl plugins load emqx_backend_pgsql
</code></pre></div><h2 id="mongodb-消息存储"><a href="#mongodb-消息存储" class="header-anchor">#</a> MongoDB 消息存储</h2> <h3 id="配置-mongodb-消息存储"><a href="#配置-mongodb-消息存储" class="header-anchor">#</a> 配置 MongoDB 消息存储</h3> <p>配置文件: emqx_backend_mongo.conf</p> <h3 id="配置-mongodb-服务器"><a href="#配置-mongodb-服务器" class="header-anchor">#</a> 配置 MongoDB 服务器</h3> <p>支持配置多台 MongoDB 服务器连接池:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## MongoDB 集群类型: single | unknown | sharded | rs</span>
backend.mongo.pool1.type <span class="token operator">=</span> single

<span class="token comment">## 如果 type = rs; 需要配置 setname</span>
<span class="token comment">## backend.mongo.pool1.rs_set_name = testrs</span>

<span class="token comment">## MongoDB 服务器地址列表</span>
backend.mongo.pool1.server <span class="token operator">=</span> <span class="token number">127.0</span>.0.1:27017

<span class="token comment">## MongoDB 连接池大小</span>
backend.mongo.pool1.c_pool_size <span class="token operator">=</span> <span class="token number">8</span>

<span class="token comment">## 连接的数据库名称</span>
backend.mongo.pool1.database <span class="token operator">=</span> mqtt

<span class="token comment">## MongoDB 认证用户名密码</span>
<span class="token comment">## backend.mongo.pool1.login =  emqtt</span>
<span class="token comment">## backend.mongo.pool1.password = emqtt</span>

<span class="token comment">## MongoDB 认证源</span>
<span class="token comment">## backend.mongo.pool1.auth_source = admin</span>

<span class="token comment">## 是否开启 SSL</span>
<span class="token comment">## backend.mongo.pool1.ssl = false</span>

<span class="token comment">## SSL 密钥文件路径</span>
<span class="token comment">## backend.mongo.pool1.keyfile =</span>

<span class="token comment">## SSL 证书文件路径</span>
<span class="token comment">## backend.mongo.pool1.certfile =</span>

<span class="token comment">## SSL CA 证书文件路径</span>
<span class="token comment">## backend.mongo.pool1.cacertfile =</span>

<span class="token comment">## MongoDB 数据写入模式: unsafe | safe</span>
<span class="token comment">## backend.mongo.pool1.w_mode = safe</span>

<span class="token comment">## MongoDB 数据读取模式: master | slaver_ok</span>
<span class="token comment">## backend.mongo.pool1.r_mode = slave_ok</span>

<span class="token comment">## MongoDB 底层 driver 配置, 保持默认即可</span>
<span class="token comment">## backend.mongo.topology.pool_size = 1</span>
<span class="token comment">## backend.mongo.topology.max_overflow = 0</span>
<span class="token comment">## backend.mongo.topology.overflow_ttl = 1000</span>
<span class="token comment">## backend.mongo.topology.overflow_check_period = 1000</span>
<span class="token comment">## backend.mongo.topology.local_threshold_ms = 1000</span>
<span class="token comment">## backend.mongo.topology.connect_timeout_ms = 20000</span>
<span class="token comment">## backend.mongo.topology.socket_timeout_ms = 100</span>
<span class="token comment">## backend.mongo.topology.server_selection_timeout_ms = 30000</span>
<span class="token comment">## backend.mongo.topology.wait_queue_timeout_ms = 1000</span>
<span class="token comment">## backend.mongo.topology.heartbeat_frequency_ms = 10000</span>
<span class="token comment">## backend.mongo.topology.min_heartbeat_frequency_ms = 1000</span>

<span class="token comment">## MongoDB Backend Hooks</span>
backend.mongo.hook.client.connected.1    <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_client_connected&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.mongo.hook.session.created.1     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_subscribe_lookup&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.mongo.hook.client.disconnected.1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_client_disconnected&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.mongo.hook.session.subscribed.1  <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_fetch&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span>, <span class="token string">&quot;offline_opts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;time_range&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2h&quot;</span>, <span class="token string">&quot;max_returned_count&quot;</span><span class="token builtin class-name">:</span> <span class="token number">500</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
backend.mongo.hook.session.subscribed.2  <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_retain_lookup&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.mongo.hook.session.unsubscribed.1<span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_acked_delete&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.mongo.hook.message.publish.1     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_publish&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.mongo.hook.message.publish.2     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_retain&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.mongo.hook.message.publish.3     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_retain_delete&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.mongo.hook.message.acked.1       <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_acked&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>

<span class="token comment">## 获取离线消息</span>
<span class="token comment">### &quot;offline_opts&quot;: 获取离线消息的配置</span>
<span class="token comment">####   - max_returned_count: 单次拉去的最大离线消息数目</span>
<span class="token comment">####   - time_range: 仅拉去在当前时间范围的消息</span>
<span class="token comment">## backend.mongo.hook.session.subscribed.1  = {&quot;topic&quot;: &quot;#&quot;, &quot;action&quot;: {&quot;function&quot;: &quot;on_message_fetch&quot;}, &quot;pool&quot;: &quot;pool1&quot;, &quot;offline_opts&quot;: {&quot;time_range&quot;: &quot;2h&quot;, &quot;max_returned_count&quot;: 500}}</span>

<span class="token comment">## 如果需要存储 Qos0 消息, 可开启以下配置</span>
<span class="token comment">## 警告: 当开启以下配置时, 需关闭 'on_message_fetch', 否则 qos1, qos2 消息会被存储俩次</span>
<span class="token comment">## backend.mongo.hook.message.publish.4     = {&quot;topic&quot;: &quot;#&quot;, &quot;action&quot;: {&quot;function&quot;: &quot;on_message_store&quot;}, &quot;pool&quot;: &quot;pool1&quot;, &quot;payload_format&quot;: &quot;mongo_json&quot;}</span>
</code></pre></div><p><em>backend</em> 消息存储规则包括:</p> <table><thead><tr><th>hook</th> <th>topic</th> <th>action</th> <th>说明</th></tr></thead> <tbody><tr><td>client.connected</td> <td></td> <td>on_client_connected</td> <td>存储客户端在线状态</td></tr> <tr><td>session.created</td> <td></td> <td>on_subscribe_lookup</td> <td>订阅主题</td></tr> <tr><td>client.disconnected</td> <td></td> <td>on_client_disconnected</td> <td>存储客户端离线状态</td></tr> <tr><td>session.subscribed</td> <td>#</td> <td>on_message_fetch</td> <td>获取离线消息</td></tr> <tr><td>session.subscribed</td> <td>#</td> <td>on_retain_lookup</td> <td>获取retain消息</td></tr> <tr><td>session.unsubscribed</td> <td>#</td> <td>on_acked_delete</td> <td>删除 acked 消息</td></tr> <tr><td>message.publish</td> <td>#</td> <td>on_message_publish</td> <td>存储发布消息</td></tr> <tr><td>message.publish</td> <td>#</td> <td>on_message_retain</td> <td>存储retain消息</td></tr> <tr><td>message.publish</td> <td>#</td> <td>on_retain_delete</td> <td>删除retain消息</td></tr> <tr><td>message.acked</td> <td>#</td> <td>on_message_acked</td> <td>消息ACK处理</td></tr></tbody></table> <h3 id="mongodb-数据库初始化"><a href="#mongodb-数据库初始化" class="header-anchor">#</a> MongoDB 数据库初始化</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>use mqtt
db.createCollection<span class="token punctuation">(</span><span class="token string">&quot;mqtt_client&quot;</span><span class="token punctuation">)</span>
db.createCollection<span class="token punctuation">(</span><span class="token string">&quot;mqtt_sub&quot;</span><span class="token punctuation">)</span>
db.createCollection<span class="token punctuation">(</span><span class="token string">&quot;mqtt_msg&quot;</span><span class="token punctuation">)</span>
db.createCollection<span class="token punctuation">(</span><span class="token string">&quot;mqtt_retain&quot;</span><span class="token punctuation">)</span>
db.createCollection<span class="token punctuation">(</span><span class="token string">&quot;mqtt_acked&quot;</span><span class="token punctuation">)</span>

db.mqtt_client.ensureIndex<span class="token punctuation">(</span><span class="token punctuation">{</span>clientid:1, node:2<span class="token punctuation">}</span><span class="token punctuation">)</span>
db.mqtt_sub.ensureIndex<span class="token punctuation">(</span><span class="token punctuation">{</span>clientid:1<span class="token punctuation">}</span><span class="token punctuation">)</span>
db.mqtt_msg.ensureIndex<span class="token punctuation">(</span><span class="token punctuation">{</span>sender:1, topic:2<span class="token punctuation">}</span><span class="token punctuation">)</span>
db.mqtt_retain.ensureIndex<span class="token punctuation">(</span><span class="token punctuation">{</span>topic:1<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="mongodb-用户状态集合-client-collection"><a href="#mongodb-用户状态集合-client-collection" class="header-anchor">#</a> MongoDB 用户状态集合(Client Collection)</h3> <p><em>mqtt_client</em> 存储设备在线状态:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    clientid<span class="token operator">:</span> string<span class="token punctuation">,</span>
    state<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//0离线 1在线</span>
    node<span class="token operator">:</span> string<span class="token punctuation">,</span>
    online_at<span class="token operator">:</span> timestamp<span class="token punctuation">,</span>
    offline_at<span class="token operator">:</span> timestamp
<span class="token punctuation">}</span>
</code></pre></div><p>查询设备在线状态:</p> <div class="language-js extra-class"><pre class="language-js"><code>db<span class="token punctuation">.</span>mqtt_client<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>clientid<span class="token operator">:</span> $<span class="token punctuation">{</span>clientid<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>例如 ClientId 为 test 客户端上线:</p> <div class="language-js extra-class"><pre class="language-js"><code>db<span class="token punctuation">.</span>mqtt_client<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>clientid<span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>
  <span class="token string">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">&quot;58646c9bdde89a9fb9f7fb73&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">&quot;clientid&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;state&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token string">&quot;node&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;emqx@127.0.0.1&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;online_at&quot;</span> <span class="token operator">:</span> <span class="token number">1482976411</span><span class="token punctuation">,</span>
  <span class="token string">&quot;offline_at&quot;</span> <span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre></div><p>例如 ClientId 为 test 客户端下线:</p> <div class="language-js extra-class"><pre class="language-js"><code>db<span class="token punctuation">.</span>mqtt_client<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>clientid<span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>
    <span class="token string">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">&quot;58646c9bdde89a9fb9f7fb73&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">&quot;clientid&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;state&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string">&quot;node&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;emqx@127.0.0.1&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;online_at&quot;</span> <span class="token operator">:</span> <span class="token number">1482976411</span><span class="token punctuation">,</span>
    <span class="token string">&quot;offline_at&quot;</span> <span class="token operator">:</span> <span class="token number">1482976501</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="mongodb-用户订阅主题集合-subscription-collection"><a href="#mongodb-用户订阅主题集合-subscription-collection" class="header-anchor">#</a> MongoDB 用户订阅主题集合(Subscription Collection)</h3> <p><em>mqtt_sub</em> 存储订阅关系:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  clientid<span class="token operator">:</span> string<span class="token punctuation">,</span>
  topic<span class="token operator">:</span> string<span class="token punctuation">,</span>
  qos<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre></div><p>用户 test 分别订阅主题 test_topic0 test_topic1 test_topic2:</p> <div class="language-js extra-class"><pre class="language-js"><code>db<span class="token punctuation">.</span>mqtt_sub<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>clientid<span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> topic<span class="token operator">:</span> <span class="token string">&quot;test_topic1&quot;</span><span class="token punctuation">,</span> qos<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>mqtt_sub<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>clientid<span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> topic<span class="token operator">:</span> <span class="token string">&quot;test_topic2&quot;</span><span class="token punctuation">,</span> qos<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>某个客户端订阅主题:</p> <div class="language-js extra-class"><pre class="language-js"><code>db<span class="token punctuation">.</span>mqtt_sub<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>clientid<span class="token operator">:</span> $<span class="token punctuation">{</span>clientid<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>查询 ClientId 为 &quot;test&quot; 的客户端已订阅主题:</p> <div class="language-js extra-class"><pre class="language-js"><code>db<span class="token punctuation">.</span>mqtt_sub<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>clientid<span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">&quot;58646d90c65dff6ac9668ca1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;clientid&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;topic&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_topic1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;qos&quot;</span> <span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">&quot;58646d96c65dff6ac9668ca2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;clientid&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;topic&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_topic2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;qos&quot;</span> <span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
</code></pre></div><h3 id="mongodb-发布消息集合-message-collection"><a href="#mongodb-发布消息集合-message-collection" class="header-anchor">#</a> MongoDB 发布消息集合(Message Collection)</h3> <p><em>mqtt_msg</em> 存储 MQTT 消息:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  _id<span class="token operator">:</span> int<span class="token punctuation">,</span>
  topic<span class="token operator">:</span> string<span class="token punctuation">,</span>
  msgid<span class="token operator">:</span> string<span class="token punctuation">,</span>
  sender<span class="token operator">:</span> string<span class="token punctuation">,</span>
  qos<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>
  retain<span class="token operator">:</span> <span class="token function">boolean</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  payload<span class="token operator">:</span> string<span class="token punctuation">,</span>
  arrived<span class="token operator">:</span> timestamp
<span class="token punctuation">}</span>
</code></pre></div><p>查询某个客户端发布的消息:</p> <div class="language-js extra-class"><pre class="language-js"><code> db<span class="token punctuation">.</span>mqtt_msg<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>sender<span class="token operator">:</span> $<span class="token punctuation">{</span>clientid<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>查询 ClientId 为 &quot;test&quot; 的客户端发布的消息:</p> <div class="language-js extra-class"><pre class="language-js"><code>db<span class="token punctuation">.</span>mqtt_msg<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>sender<span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token string">&quot;topic&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;/World&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;msgid&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;AAVEwm0la4RufgAABeIAAQ==&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;sender&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;qos&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token string">&quot;retain&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token string">&quot;payload&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Hello world!&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;arrived&quot;</span> <span class="token operator">:</span> <span class="token number">1482976729</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="mongodb-保留消息集合-retain-message-collection"><a href="#mongodb-保留消息集合-retain-message-collection" class="header-anchor">#</a> MongoDB 保留消息集合(Retain Message Collection)</h3> <p>mqtt_retain 存储 Retain 消息:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  topic<span class="token operator">:</span> string<span class="token punctuation">,</span>
  msgid<span class="token operator">:</span> string<span class="token punctuation">,</span>
  sender<span class="token operator">:</span> string<span class="token punctuation">,</span>
  qos<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>
  payload<span class="token operator">:</span> string<span class="token punctuation">,</span>
  arrived<span class="token operator">:</span> timestamp
<span class="token punctuation">}</span>
</code></pre></div><p>查询 retain 消息:</p> <div class="language-js extra-class"><pre class="language-js"><code>db<span class="token punctuation">.</span>mqtt_retain<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>topic<span class="token operator">:</span> $<span class="token punctuation">{</span>topic<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>查询topic为 &quot;t/retain&quot; 的 retain 消息:</p> <div class="language-js extra-class"><pre class="language-js"><code>db<span class="token punctuation">.</span>mqtt_retain<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>topic<span class="token operator">:</span> <span class="token string">&quot;t/retain&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">&quot;58646dd9dde89a9fb9f7fb75&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">&quot;topic&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;t/retain&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;msgid&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;AAVEwm0la4RufgAABeIAAQ==&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;sender&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;c1&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;qos&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token string">&quot;payload&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Hello world!&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;arrived&quot;</span> <span class="token operator">:</span> <span class="token number">1482976729</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="mongodb-接收消息-ack-集合-message-acked-collection"><a href="#mongodb-接收消息-ack-集合-message-acked-collection" class="header-anchor">#</a> MongoDB 接收消息 ack 集合(Message Acked Collection)</h3> <p><em>mqtt_acked</em> 存储客户端消息确认:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  clientid<span class="token operator">:</span> string<span class="token punctuation">,</span>
  topic<span class="token operator">:</span> string<span class="token punctuation">,</span>
  mongo_id<span class="token operator">:</span> int
<span class="token punctuation">}</span>
</code></pre></div><h3 id="启用-mongodb-数据存储插件"><a href="#启用-mongodb-数据存储插件" class="header-anchor">#</a> 启用 MongoDB 数据存储插件</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>./bin/emqx_ctl plugins load emqx_backend_mongo
</code></pre></div><h2 id="cassandra-消息存储"><a href="#cassandra-消息存储" class="header-anchor">#</a> Cassandra 消息存储</h2> <h3 id="配置-cassandra-服务器"><a href="#配置-cassandra-服务器" class="header-anchor">#</a> 配置 Cassandra 服务器</h3> <p>配置文件: emqx_backend_cassa.conf</p> <p>支持配置多台Cassandra服务器连接池:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## Cassandra 节点地址</span>
backend.ecql.pool1.nodes <span class="token operator">=</span> <span class="token number">127.0</span>.0.1:9042

<span class="token comment">## Cassandra 连接池大小</span>
backend.ecql.pool1.size <span class="token operator">=</span> <span class="token number">8</span>

<span class="token comment">## Cassandra 自动重连间隔(s)</span>
backend.ecql.pool1.auto_reconnect <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">## Cassandra 认证用户名/密码</span>
backend.ecql.pool1.username <span class="token operator">=</span> cassandra
backend.ecql.pool1.password <span class="token operator">=</span> cassandra

<span class="token comment">## Cassandra Keyspace</span>
backend.ecql.pool1.keyspace <span class="token operator">=</span> mqtt

<span class="token comment">## Cassandra Logger type</span>
backend.ecql.pool1.logger <span class="token operator">=</span> info

<span class="token comment">##--------------------------------------------------------------------</span>
<span class="token comment">## Cassandra Backend Hooks</span>
<span class="token comment">##--------------------------------------------------------------------</span>

<span class="token comment">## Client Connected Record</span>
backend.cassa.hook.client.connected.1    <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_client_connected&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>

<span class="token comment">## Subscribe Lookup Record</span>
backend.cassa.hook.session.created.1     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_subscription_lookup&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>

<span class="token comment">## Client DisConnected Record</span>
backend.cassa.hook.client.disconnected.1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_client_disconnected&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>

<span class="token comment">## Lookup Unread Message QOS &gt; 0</span>
backend.cassa.hook.session.subscribed.1  <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_fetch&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>

<span class="token comment">## Lookup Retain Message</span>
backend.cassa.hook.session.subscribed.2  <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_retain_lookup&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>

<span class="token comment">## Store Publish Message  QOS &gt; 0</span>
backend.cassa.hook.message.publish.1     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_publish&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>

<span class="token comment">## Delete Acked Record</span>
backend.cassa.hook.session.unsubscribed.1<span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, action<span class="token string">&quot;: {&quot;</span>cql<span class="token string">&quot;: [&quot;</span>delete from acked where client_id <span class="token operator">=</span> <span class="token variable">${clientid}</span> and topic <span class="token operator">=</span> <span class="token variable">${topic}</span><span class="token string">&quot;]}, &quot;</span>pool<span class="token string">&quot;: &quot;</span>pool1<span class="token string">&quot;}

## Store Retain Message
backend.cassa.hook.message.publish.2     = {&quot;</span>topic<span class="token string">&quot;: &quot;</span>#<span class="token string">&quot;, &quot;</span>action<span class="token string">&quot;: {&quot;</span><span class="token keyword">function</span><span class="token string">&quot;: &quot;</span>on_message_retain<span class="token string">&quot;}, &quot;</span>pool<span class="token string">&quot;: &quot;</span>pool1<span class="token string">&quot;}

## Delete Retain Message
backend.cassa.hook.message.publish.3     = {&quot;</span>topic<span class="token string">&quot;: &quot;</span>#<span class="token string">&quot;, &quot;</span>action<span class="token string">&quot;: {&quot;</span><span class="token keyword">function</span><span class="token string">&quot;: &quot;</span>on_retain_delete<span class="token string">&quot;}, &quot;</span>pool<span class="token string">&quot;: &quot;</span>pool1<span class="token string">&quot;}

## Store Ack
backend.cassa.hook.message.acked.1       = {&quot;</span>topic<span class="token string">&quot;: &quot;</span>#<span class="token string">&quot;, &quot;</span>action<span class="token string">&quot;: {&quot;</span><span class="token keyword">function</span><span class="token string">&quot;: &quot;</span>on_message_acked<span class="token string">&quot;}, &quot;</span>pool<span class="token string">&quot;: &quot;</span>pool1<span class="token string">&quot;}

## 获取离线消息
### &quot;</span>offline_opts<span class="token string">&quot;: 获取离线消息的配置
####   - max_returned_count: 单次拉去的最大离线消息数目
####   - time_range: 仅拉去在当前时间范围的消息
## backend.cassa.hook.session.subscribed.1  = {&quot;</span>topic<span class="token string">&quot;: &quot;</span>#<span class="token string">&quot;, &quot;</span>action<span class="token string">&quot;: {&quot;</span><span class="token keyword">function</span><span class="token string">&quot;: &quot;</span>on_message_fetch<span class="token string">&quot;}, &quot;</span>offline_opts<span class="token string">&quot;: {&quot;</span>max_returned_count<span class="token string">&quot;: 500, &quot;</span>time_range<span class="token string">&quot;: &quot;</span>2h<span class="token string">&quot;}, &quot;</span>pool<span class="token string">&quot;: &quot;</span>pool1<span class="token string">&quot;}

## 如果需要存储 Qos0 消息, 可开启以下配置
## 警告: 当开启以下配置时, 需关闭 'on_message_fetch', 否则 qos1, qos2 消息会被存储俩次
## backend.cassa.hook.message.publish.4     = {&quot;</span>topic<span class="token string">&quot;: &quot;</span>#<span class="token string">&quot;, &quot;</span>action<span class="token string">&quot;: {&quot;</span><span class="token keyword">function</span><span class="token string">&quot;: &quot;</span>on_message_store<span class="token string">&quot;}, &quot;</span>pool<span class="token string">&quot;: &quot;</span>pool1&quot;<span class="token punctuation">}</span>
</code></pre></div><p><em>backend</em>
消息存储规则包括:</p> <table><thead><tr><th>hook</th> <th>topic</th> <th>action</th> <th>说明</th></tr></thead> <tbody><tr><td>client.connected</td> <td></td> <td>on_client_connected</td> <td>存储客户端在线状态</td></tr> <tr><td>session.created</td> <td></td> <td>on_subscribe_lookup</td> <td>订阅主题</td></tr> <tr><td>client.disconnected</td> <td></td> <td>on_client_disconnected</td> <td>存储客户端离线状态</td></tr> <tr><td>session.subscribed</td> <td>#</td> <td>on_message_fetch</td> <td>获取离线消息</td></tr> <tr><td>session.subscribed</td> <td>#</td> <td>on_retain_lookup</td> <td>获取retain消息</td></tr> <tr><td>session.unsubscribed</td> <td>#</td> <td></td> <td>删除 akced 消息</td></tr> <tr><td>message.publish</td> <td>#</td> <td>on_message_publish</td> <td>存储发布消息</td></tr> <tr><td>message.publish</td> <td>#</td> <td>on_message_retain</td> <td>存储retain消息</td></tr> <tr><td>message.publish</td> <td>#</td> <td>on_retain_delete</td> <td>删除retain消息</td></tr> <tr><td>message.acked</td> <td>#</td> <td>on_message_acked</td> <td>消息ACK处理</td></tr></tbody></table> <p><em>自定义 CQL 语句</em>
可用参数包括:</p> <table><thead><tr><th>hook</th> <th>可用参数</th> <th>示例(cql语句中${name} 表示可获取的参数)</th></tr></thead> <tbody><tr><td>client.connected</td> <td>clientid</td> <td>insert into conn(clientid) values(${clientid})</td></tr> <tr><td>client.disconnected</td> <td>clientid</td> <td>insert into disconn(clientid) values(${clientid})</td></tr> <tr><td>session.subscribed</td> <td>clientid, topic, qos</td> <td>insert into sub(topic, qos) values(${topic}, ${qos})</td></tr> <tr><td>session.unsubscribed</td> <td>clientid, topic</td> <td>delete from sub where topic = ${topic}</td></tr> <tr><td>message.publish</td> <td>msgid, topic, payload, qos, clientid</td> <td>insert into msg(msgid, topic) values(${msgid}, ${topic})</td></tr> <tr><td>message.acked</td> <td>msgid, topic, clientid</td> <td>insert into ack(msgid, topic) values(${msgid}, ${topic})</td></tr> <tr><td>message.deliver</td> <td>msgid, topic, clientid</td> <td>insert into deliver(msgid, topic) values(${msgid}, ${topic})</td></tr></tbody></table> <p>支持 CQL 语句配置:</p> <p>考虑到用户的需求不同, backend cassandra 自带的函数无法满足用户需求, 用户可根据自己的需求配置 cql 语句</p> <p>在 etc/plugins/emqx_backend_cassa.conf 中添加如下配置:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## 在客户端连接到 EMQ X 服务器后，执行一条 cql 语句(支持多条 cql 语句)</span>
backend.cassa.hook.client.connected.3 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;cql&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;insert into conn(clientid) values(<span class="token variable">${clientid}</span>)&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
</code></pre></div><h3 id="cassandra-创建一个-keyspace"><a href="#cassandra-创建一个-keyspace" class="header-anchor">#</a> Cassandra 创建一个 Keyspace</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>CREATE KEYSPACE mqtt WITH replication <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'class'</span><span class="token builtin class-name">:</span> <span class="token string">'SimpleStrategy'</span>, <span class="token string">'replication_factor'</span><span class="token builtin class-name">:</span> <span class="token string">'1'</span><span class="token punctuation">}</span>  AND durable_writes <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
USR mqtt<span class="token punctuation">;</span>
</code></pre></div><h3 id="导入-cassandra-表结构"><a href="#导入-cassandra-表结构" class="header-anchor">#</a> 导入 Cassandra 表结构</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>cqlsh -e <span class="token string">&quot;SOURCE 'emqx_backend_cassa.cql'&quot;</span>
</code></pre></div><h3 id="cassandra-用户状态表-client-table"><a href="#cassandra-用户状态表-client-table" class="header-anchor">#</a> Cassandra 用户状态表(Client Table)</h3> <p><em>mqtt.client</em> 存储设备在线状态:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> mqtt<span class="token punctuation">.</span>client <span class="token punctuation">(</span>
  client_id <span class="token keyword">text</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
  connected <span class="token keyword">timestamp</span><span class="token punctuation">,</span>
  disconnected <span class="token keyword">timestamp</span><span class="token punctuation">,</span>
  node <span class="token keyword">text</span><span class="token punctuation">,</span>
  state <span class="token keyword">int</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>查询设备在线状态:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">select</span> * from mqtt.client where client_id <span class="token operator">=</span> <span class="token variable">${clientid}</span><span class="token punctuation">;</span>
</code></pre></div><p>例如 ClientId 为 test 的客户端上线:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">select</span> * from mqtt.client where client_id <span class="token operator">=</span> <span class="token string">'test'</span><span class="token punctuation">;</span>

 client_id <span class="token operator">|</span> connected                       <span class="token operator">|</span> disconnected  <span class="token operator">|</span> node            <span class="token operator">|</span> state
-----------+---------------------------------+---------------+-----------------+-------
      <span class="token builtin class-name">test</span> <span class="token operator">|</span> <span class="token number">2017</span>-02-14 08:27:29.872000+0000 <span class="token operator">|</span>          null <span class="token operator">|</span> emqx@127.0.0.1<span class="token operator">|</span>   <span class="token number">1</span>
</code></pre></div><p>例如ClientId为test客户端下线:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">select</span> * from mqtt.client where client_id <span class="token operator">=</span> <span class="token string">'test'</span><span class="token punctuation">;</span>

 client_id <span class="token operator">|</span> connected                       <span class="token operator">|</span> disconnected                    <span class="token operator">|</span> node            <span class="token operator">|</span> state
-----------+---------------------------------+---------------------------------+-----------------+-------
      <span class="token builtin class-name">test</span> <span class="token operator">|</span> <span class="token number">2017</span>-02-14 08:27:29.872000+0000 <span class="token operator">|</span> <span class="token number">2017</span>-02-14 08:27:35.872000+0000 <span class="token operator">|</span> emqx@127.0.0.1<span class="token operator">|</span>     <span class="token number">0</span>
</code></pre></div><h3 id="cassandra-用户订阅主题表-sub-table"><a href="#cassandra-用户订阅主题表-sub-table" class="header-anchor">#</a> Cassandra 用户订阅主题表(Sub Table)</h3> <p><em>mqtt.sub</em> 存储订阅关系:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> mqtt<span class="token punctuation">.</span>sub <span class="token punctuation">(</span>
  client_id <span class="token keyword">text</span><span class="token punctuation">,</span>
  topic <span class="token keyword">text</span><span class="token punctuation">,</span>
  qos <span class="token keyword">int</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>client_id<span class="token punctuation">,</span> topic<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>用户test分别订阅主题test_topic1
test_topic2:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> mqtt<span class="token punctuation">.</span>sub<span class="token punctuation">(</span>client_id<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> qos<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token string">'test_topic1'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> mqtt<span class="token punctuation">.</span>sub<span class="token punctuation">(</span>client_id<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> qos<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token string">'test_topic2'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>某个客户端订阅主题:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mqtt_sub <span class="token keyword">where</span> clientid <span class="token operator">=</span> ${clientid}<span class="token punctuation">;</span>
</code></pre></div><p>查询ClientId为'test'的客户端已订阅主题:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">select</span> * from mqtt_sub where clientid <span class="token operator">=</span> <span class="token string">'test'</span><span class="token punctuation">;</span>

 client_id <span class="token operator">|</span> topic       <span class="token operator">|</span> qos
-----------+-------------+------
      <span class="token builtin class-name">test</span> <span class="token operator">|</span> test_topic1 <span class="token operator">|</span>   <span class="token number">1</span>
      <span class="token builtin class-name">test</span> <span class="token operator">|</span> test_topic2 <span class="token operator">|</span>   <span class="token number">2</span>
</code></pre></div><h3 id="cassandra-发布消息表-msg-table"><a href="#cassandra-发布消息表-msg-table" class="header-anchor">#</a> Cassandra 发布消息表(Msg Table)</h3> <p><em>mqtt.msg</em> 存储MQTT消息:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> mqtt<span class="token punctuation">.</span>msg <span class="token punctuation">(</span>
  topic <span class="token keyword">text</span><span class="token punctuation">,</span>
  msgid <span class="token keyword">text</span><span class="token punctuation">,</span>
  arrived <span class="token keyword">timestamp</span><span class="token punctuation">,</span>
  payload <span class="token keyword">text</span><span class="token punctuation">,</span>
  qos <span class="token keyword">int</span><span class="token punctuation">,</span>
  retain <span class="token keyword">int</span><span class="token punctuation">,</span>
  sender <span class="token keyword">text</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>topic<span class="token punctuation">,</span> msgid<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> CLUSTERING <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>msgid <span class="token keyword">DESC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>查询某个客户端发布的消息:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mqtt_msg <span class="token keyword">where</span> sender <span class="token operator">=</span> ${clientid}<span class="token punctuation">;</span>
</code></pre></div><p>查询ClientId为'test'的客户端发布的消息:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">select</span> * from mqtt_msg where sender <span class="token operator">=</span> <span class="token string">'test'</span><span class="token punctuation">;</span>

 topic <span class="token operator">|</span> msgid                <span class="token operator">|</span> arrived                         <span class="token operator">|</span> payload      <span class="token operator">|</span> qos <span class="token operator">|</span> retain <span class="token operator">|</span> sender
-------+----------------------+---------------------------------+--------------+-----+--------+--------
 hello <span class="token operator">|</span> 2PguFrHsrzEvIIBdctmb <span class="token operator">|</span> <span class="token number">2017</span>-02-14 09:07:13.785000+0000 <span class="token operator">|</span> Hello world<span class="token operator">!</span> <span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span>      <span class="token number">0</span> <span class="token operator">|</span>   <span class="token builtin class-name">test</span>
 world <span class="token operator">|</span> 2PguFrHsrzEvIIBdctmb <span class="token operator">|</span> <span class="token number">2017</span>-02-14 09:07:13.785000+0000 <span class="token operator">|</span> Hello world<span class="token operator">!</span> <span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span>      <span class="token number">0</span> <span class="token operator">|</span>   <span class="token builtin class-name">test</span>
</code></pre></div><h3 id="cassandra-保留消息表-retain-message-table"><a href="#cassandra-保留消息表-retain-message-table" class="header-anchor">#</a> Cassandra 保留消息表(Retain Message Table)</h3> <p><em>mqtt.retain</em> 存储 Retain 消息:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> mqtt<span class="token punctuation">.</span>retain <span class="token punctuation">(</span>
  topic <span class="token keyword">text</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
  msgid <span class="token keyword">text</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>查询 retain 消息:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mqtt_retain <span class="token keyword">where</span> topic <span class="token operator">=</span> ${topic}<span class="token punctuation">;</span>
</code></pre></div><p>查询 topic 为 't/retain' 的 retain 消息:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">select</span> * from mqtt_retain where topic <span class="token operator">=</span> <span class="token string">'t/retain'</span><span class="token punctuation">;</span>

 topic  <span class="token operator">|</span> msgid
--------+----------------------
 retain <span class="token operator">|</span> 2PguFrHsrzEvIIBdctmb
</code></pre></div><h3 id="cassandra-接收消息-ack-表-message-acked-table"><a href="#cassandra-接收消息-ack-表-message-acked-table" class="header-anchor">#</a> Cassandra 接收消息 ack 表(Message Acked Table)</h3> <p><em>mqtt.acked</em> 存储客户端消息确认:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> mqtt<span class="token punctuation">.</span>acked <span class="token punctuation">(</span>
  client_id <span class="token keyword">text</span><span class="token punctuation">,</span>
  topic <span class="token keyword">text</span><span class="token punctuation">,</span>
  msgid <span class="token keyword">text</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>client_id<span class="token punctuation">,</span> topic<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="启用-cassandra-存储插件"><a href="#启用-cassandra-存储插件" class="header-anchor">#</a> 启用 Cassandra 存储插件</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>./bin/emqx_ctl plugins load emqx_backend_cassa
</code></pre></div><h2 id="dynamodb-消息存储"><a href="#dynamodb-消息存储" class="header-anchor">#</a> DynamoDB 消息存储</h2> <h3 id="配置-dyanmodb-消息存储"><a href="#配置-dyanmodb-消息存储" class="header-anchor">#</a> 配置 DyanmoDB 消息存储</h3> <p>配置文件: etc/plugins/emqx_backend_dynamo.conf</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## DynamoDB Region</span>
backend.dynamo.region <span class="token operator">=</span> us-west-2

<span class="token comment">## DynamoDB Server</span>
backend.dynamo.pool1.server <span class="token operator">=</span> http://localhost:8000

<span class="token comment">## DynamoDB Pool Size</span>
backend.dynamo.pool1.pool_size <span class="token operator">=</span> <span class="token number">8</span>

<span class="token comment">## AWS ACCESS KEY ID</span>
backend.dynamo.pool1.aws_access_key_id <span class="token operator">=</span> AKIAU5IM2XOC7AQWG7HK

<span class="token comment">## AWS SECRET ACCESS KEY</span>
backend.dynamo.pool1.aws_secret_access_key <span class="token operator">=</span> TZt7XoRi+vtCJYQ9YsAinh19jR1rngm/hxZMWR2P

<span class="token comment">## DynamoDB Backend Hooks</span>
backend.dynamo.hook.client.connected.1    <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_client_connected&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.dynamo.hook.session.created.1     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_subscribe_lookup&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.dynamo.hook.client.disconnected.1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_client_disconnected&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.dynamo.hook.session.subscribed.1  <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_fetch_for_queue&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.dynamo.hook.session.subscribed.2  <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_retain_lookup&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.dynamo.hook.session.unsubscribed.1<span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_acked_delete&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.dynamo.hook.message.publish.1     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_publish&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.dynamo.hook.message.publish.2     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_retain&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.dynamo.hook.message.publish.3     <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_retain_delete&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
backend.dynamo.hook.message.acked.1       <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_acked_for_queue&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>

<span class="token comment"># backend.dynamo.hook.message.publish.4   = {&quot;topic&quot;: &quot;#&quot;, &quot;action&quot;: {&quot;function&quot;: &quot;on_message_store&quot;}, &quot;pool&quot;: &quot;pool1&quot;}</span>
</code></pre></div><p><em>backend</em>
消息存储规则包括:</p> <table><thead><tr><th>hook</th> <th>topic</th> <th>action</th> <th>说明</th></tr></thead> <tbody><tr><td>client.connected</td> <td></td> <td>on_client_connected</td> <td>存储客户端在线状态</td></tr> <tr><td>client.connected</td> <td></td> <td>on_subscribe_lookup</td> <td>订阅主题</td></tr> <tr><td>client.disconnected</td> <td></td> <td>on_client_disconnected</td> <td>存储客户端离线状态</td></tr> <tr><td>session.subscribed</td> <td>#</td> <td>on_message_fetch_for_queue</td> <td>获取一对一离线消息</td></tr> <tr><td>session.subscribed</td> <td>#</td> <td>on_retain_lookup</td> <td>获取retain消息</td></tr> <tr><td>message.publish</td> <td>#</td> <td>on_message_publish</td> <td>存储发布消息</td></tr> <tr><td>message.publish</td> <td>#</td> <td>on_message_retain</td> <td>存储retain消息</td></tr> <tr><td>message.publish</td> <td>#</td> <td>on_retain_delete</td> <td>删除retain消息</td></tr> <tr><td>message.acked</td> <td>#</td> <td>on_message_acked_for_queue</td> <td>一对一消息ACK处理</td></tr></tbody></table> <h3 id="dynamodb-数据库创建表"><a href="#dynamodb-数据库创建表" class="header-anchor">#</a> DynamoDB 数据库创建表</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>./test/dynamo_test.sh
</code></pre></div><h3 id="dynamodb-用户状态表-client-table"><a href="#dynamodb-用户状态表-client-table" class="header-anchor">#</a> DynamoDB 用户状态表(Client Table)</h3> <p><em>mqtt_client</em> 表定义(存储设备在线状态):</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;TableName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mqtt_client&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;KeySchema&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token property">&quot;AttributeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;clientid&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;KeyType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HASH&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;AttributeDefinitions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token property">&quot;AttributeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;clientid&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;AttributeType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;S&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ProvisionedThroughput&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;ReadCapacityUnits&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token property">&quot;WriteCapacityUnits&quot;</span><span class="token operator">:</span> <span class="token number">5</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>查询设备在线状态:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>aws dynamodb scan --table-name mqtt_client --region us-west-2  --endpoint-url http://localhost:8000

<span class="token punctuation">{</span>
  <span class="token string">&quot;Items&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
          <span class="token string">&quot;offline_at&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;N&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;0&quot;</span> <span class="token punctuation">}</span>,
          <span class="token string">&quot;node&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;S&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;emqx@127.0.0.1&quot;</span> <span class="token punctuation">}</span>,
          <span class="token string">&quot;clientid&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;S&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;mqttjs_384b9c73a9&quot;</span> <span class="token punctuation">}</span>,
          <span class="token string">&quot;connect_state&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;N&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span> <span class="token punctuation">}</span>,
          <span class="token string">&quot;online_at&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;N&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1562224940&quot;</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
  <span class="token string">&quot;Count&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
  <span class="token string">&quot;ScannedCount&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
  <span class="token string">&quot;ConsumedCapacity&quot;</span><span class="token builtin class-name">:</span> null
<span class="token punctuation">}</span>
</code></pre></div><h3 id="dynamodb-用户订阅主题-subscription-table"><a href="#dynamodb-用户订阅主题-subscription-table" class="header-anchor">#</a> DynamoDB 用户订阅主题(Subscription Table)</h3> <p><em>mqtt_sub</em> 表定义(存储订阅关系):</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;TableName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mqtt_sub&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;KeySchema&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token property">&quot;AttributeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;clientid&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;KeyType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HASH&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> <span class="token property">&quot;AttributeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;topic&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;KeyType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;RANGE&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;AttributeDefinitions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token property">&quot;AttributeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;clientid&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;AttributeType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;S&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> <span class="token property">&quot;AttributeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;topic&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;AttributeType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;S&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ProvisionedThroughput&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;ReadCapacityUnits&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token property">&quot;WriteCapacityUnits&quot;</span><span class="token operator">:</span> <span class="token number">5</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>查询 ClientId 为 &quot;test-dynamo&quot;
的客户端已订阅主题:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>aws dynamodb scan --table-name mqtt_sub --region us-west-2  --endpoint-url http://localhost:8000

<span class="token punctuation">{</span>
  <span class="token string">&quot;Items&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;qos&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;N&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2&quot;</span> <span class="token punctuation">}</span>, <span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;S&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;test-dynamo-sub&quot;</span> <span class="token punctuation">}</span>, <span class="token string">&quot;clientid&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;S&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;test-dynamo&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>,
              <span class="token punctuation">{</span><span class="token string">&quot;qos&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;N&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2&quot;</span> <span class="token punctuation">}</span>, <span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;S&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;test-dynamo-sub-1&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;clientid&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;S&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;test-dynamo&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>,
              <span class="token punctuation">{</span><span class="token string">&quot;qos&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;N&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2&quot;</span> <span class="token punctuation">}</span>, <span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;S&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;test-dynamo-sub-2&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;clientid&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;S&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;test-dynamo&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span>,
  <span class="token string">&quot;Count&quot;</span><span class="token builtin class-name">:</span> <span class="token number">3</span>,
  <span class="token string">&quot;ScannedCount&quot;</span><span class="token builtin class-name">:</span> <span class="token number">3</span>,
  <span class="token string">&quot;ConsumedCapacity&quot;</span><span class="token builtin class-name">:</span> null
<span class="token punctuation">}</span>
</code></pre></div><h3 id="dynamodb-发布消息-message-table"><a href="#dynamodb-发布消息-message-table" class="header-anchor">#</a> DynamoDB 发布消息(Message Table)</h3> <p><em>mqtt_msg</em> 表定义(存储 MQTT 消息):</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;TableName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mqtt_msg&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;KeySchema&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token property">&quot;AttributeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;msgid&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;KeyType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HASH&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;AttributeDefinitions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token property">&quot;AttributeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;msgid&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;AttributeType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;S&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ProvisionedThroughput&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;ReadCapacityUnits&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token property">&quot;WriteCapacityUnits&quot;</span><span class="token operator">:</span> <span class="token number">5</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><em>mqtt_topic_msg_map</em> 表定义(存储主题和消息的映射关系):</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;TableName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mqtt_topic_msg_map&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;KeySchema&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token property">&quot;AttributeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;topic&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;KeyType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HASH&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;AttributeDefinitions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token property">&quot;AttributeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;topic&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;AttributeType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;S&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ProvisionedThroughput&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;ReadCapacityUnits&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token property">&quot;WriteCapacityUnits&quot;</span><span class="token operator">:</span> <span class="token number">5</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>某个客户端向主题 test 发布消息后，查询 <em>mqtt_msg</em> 表和 <em>mqtt_topic_msg_map</em> 表:</p> <p>查询 mqtt_msg
表:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>aws dynamodb scan --table-name mqtt_msg --region us-west-2  --endpoint-url http://localhost:8000

<span class="token operator">&gt;</span>   - <span class="token punctuation">{</span>
<span class="token operator">&gt;</span>     
<span class="token operator">&gt;</span>       - <span class="token string">&quot;Items&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">\</span><span class="token punctuation">[</span>
<span class="token operator">&gt;</span>         
<span class="token operator">&gt;</span>           - <span class="token punctuation">{</span>  
<span class="token operator">&gt;</span>             <span class="token string">&quot;arrived&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;N&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1562308553&quot;</span> <span class="token punctuation">}</span>, <span class="token string">&quot;qos&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;N&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span> <span class="token punctuation">}</span>,
<span class="token operator">&gt;</span>             <span class="token string">&quot;sender&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;S&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;mqttjs_231b962d5c&quot;</span> <span class="token punctuation">}</span>, <span class="token string">&quot;payload&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;S&quot;</span><span class="token builtin class-name">:</span>
<span class="token operator">&gt;</span>             <span class="token string">&quot;{ &quot;</span>msg<span class="token string">&quot;: &quot;</span>Hello, World<span class="token punctuation">\</span><span class="token operator">!</span><span class="token string">&quot; }&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;retain&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;N&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;0&quot;</span> <span class="token punctuation">}</span>,
<span class="token operator">&gt;</span>             <span class="token string">&quot;msgid&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;S&quot;</span><span class="token builtin class-name">:</span>
<span class="token operator">&gt;</span>             <span class="token string">&quot;Mjg4MTk1MDYwNTk0NjYwNzYzMTg4MDk3OTQ2MDU2Nzg1OTD&quot;</span> <span class="token punctuation">}</span>,
<span class="token operator">&gt;</span>             <span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;S&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;test&quot;</span> <span class="token punctuation">}</span>
<span class="token operator">&gt;</span>         
<span class="token operator">&gt;</span>         <span class="token punctuation">}</span>
<span class="token operator">&gt;</span>     
<span class="token operator">&gt;</span>     <span class="token punctuation">\</span><span class="token punctuation">]</span>, <span class="token string">&quot;Count&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">&quot;ScannedCount&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">&quot;ConsumedCapacity&quot;</span><span class="token builtin class-name">:</span> null
<span class="token operator">&gt;</span> 
<span class="token operator">&gt;</span> <span class="token punctuation">}</span>

</code></pre></div><p>查询 mqtt_topic_msg_map 表：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>aws dynamodb scan --table-name mqtt_topic_msg_map --region us-west-2  --endpoint-url http://localhost:8000


<span class="token operator">&gt;</span>   - <span class="token punctuation">{</span>
<span class="token operator">&gt;</span>     
<span class="token operator">&gt;</span>       - <span class="token string">&quot;Items&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">\</span><span class="token punctuation">[</span>
<span class="token operator">&gt;</span>         
<span class="token operator">&gt;</span>           - <span class="token punctuation">{</span>  
<span class="token operator">&gt;</span>             <span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;S&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;test&quot;</span> <span class="token punctuation">}</span>, <span class="token string">&quot;MsgId&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;SS&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">\</span><span class="token punctuation">[</span>
<span class="token operator">&gt;</span>             <span class="token string">&quot;Mjg4MTk1MDYwNTk0NjYwNzYzMTg4MDk3OTQ2MDU2Nzg1OTD&quot;</span> <span class="token punctuation">\</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token operator">&gt;</span>         
<span class="token operator">&gt;</span>         <span class="token punctuation">}</span>
<span class="token operator">&gt;</span>     
<span class="token operator">&gt;</span>     <span class="token punctuation">\</span><span class="token punctuation">]</span>, <span class="token string">&quot;Count&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">&quot;ScannedCount&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">&quot;ConsumedCapacity&quot;</span><span class="token builtin class-name">:</span> null
<span class="token operator">&gt;</span> 
<span class="token operator">&gt;</span> <span class="token punctuation">}</span>
</code></pre></div><h3 id="dynamodb-保留消息-retain-message-table"><a href="#dynamodb-保留消息-retain-message-table" class="header-anchor">#</a> DynamoDB 保留消息(Retain Message Table)</h3> <p><em>mqtt_retain</em> 表定义(存储 retain 消息):</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;TableName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mqtt_retain&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;KeySchema&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token property">&quot;AttributeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;topic&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;KeyType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HASH&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;AttributeDefinitions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token property">&quot;AttributeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;topic&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;AttributeType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;S&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ProvisionedThroughput&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;ReadCapacityUnits&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token property">&quot;WriteCapacityUnits&quot;</span><span class="token operator">:</span> <span class="token number">5</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>某个客户端向主题 test 发布消息后，查询 <em>mqtt_retain</em> 表:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;Items&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
          <span class="token property">&quot;arrived&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;N&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1562312113&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;qos&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;N&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;sender&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;S&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mqttjs_d0513acfce&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;payload&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;S&quot;</span><span class="token operator">:</span> <span class="token string">&quot;test&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;retain&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;N&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;msgid&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;S&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Mjg4MTk1NzE3MTY4MjYxMjA5MDExMDg0NTk5ODgzMjAyNTH&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;topic&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;S&quot;</span><span class="token operator">:</span> <span class="token string">&quot;testtopic&quot;</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;Count&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ScannedCount&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ConsumedCapacity&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="dynamodb-接收消息-ack-message-acked-table"><a href="#dynamodb-接收消息-ack-message-acked-table" class="header-anchor">#</a> DynamoDB 接收消息 ack (Message Acked Table)</h3> <p><em>mqtt_acked</em> 表定义(存储确认的消息):</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;TableName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mqtt_acked&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;KeySchema&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token property">&quot;AttributeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;topic&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;KeyType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HASH&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> <span class="token property">&quot;AttributeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;clientid&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;KeyType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;RANGE&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;AttributeDefinitions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token property">&quot;AttributeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;topic&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;AttributeType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;S&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> <span class="token property">&quot;AttributeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;clientid&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;AttributeType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;S&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ProvisionedThroughput&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;ReadCapacityUnits&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token property">&quot;WriteCapacityUnits&quot;</span><span class="token operator">:</span> <span class="token number">5</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>某个客户端向主题 test 发布消息后，查询 <em>mqtt_acked</em> 表:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;Items&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
          <span class="token property">&quot;topic&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;S&quot;</span><span class="token operator">:</span> <span class="token string">&quot;test&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;msgid&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;S&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Mjg4MTk1MDYwNTk0NjYwNzYzMTg4MDk3OTQ2MDU2Nzg1OTD&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;clientid&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;S&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mqttjs_861e582a70&quot;</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;Count&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ScannedCount&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ConsumedCapacity&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
<span class="token punctuation">}</span>
</code></pre></div><p>启用 DynamoDB 消息存储:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./bin/emqx_ctl plugins load emqx_backend_dynamo
</code></pre></div><h2 id="influxdb-消息存储"><a href="#influxdb-消息存储" class="header-anchor">#</a> InfluxDB 消息存储</h2> <h3 id="influxdb-配置"><a href="#influxdb-配置" class="header-anchor">#</a> InfluxDB 配置</h3> <p>EMQ X 仅支持通过 UDP 协议连接 InfluxDB，需要修改 InfluxDB 配置文件：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span><span class="token punctuation">[</span>udp<span class="token punctuation">]</span><span class="token punctuation">]</span>
  enabled <span class="token operator">=</span> <span class="token boolean">true</span>
  bind-address <span class="token operator">=</span> <span class="token string">&quot;:8089&quot;</span>
  <span class="token comment"># 消息保存的数据库</span>
  database <span class="token operator">=</span> <span class="token string">&quot;emqx&quot;</span>

  <span class="token comment"># InfluxDB precision for timestamps on received points (&quot;&quot; or &quot;n&quot;, &quot;u&quot;, &quot;ms&quot;, &quot;s&quot;, &quot;m&quot;, &quot;h&quot;)</span>
  <span class="token comment"># EMQ X 默认时间戳是毫秒</span>
  precision <span class="token operator">=</span> <span class="token string">&quot;ms&quot;</span>
  
  <span class="token comment"># 其他配置根据需要自行修改</span>
  <span class="token comment">#   batch-size = 1000</span>
  <span class="token comment">#   batch-pending = 5</span>
  <span class="token comment">#   batch-timeout = &quot;5s&quot;</span>
  <span class="token comment">#   read-buffer = 1024</span>
</code></pre></div><h3 id="配置-influxdb-消息存储"><a href="#配置-influxdb-消息存储" class="header-anchor">#</a> 配置 InfluxDB 消息存储</h3> <p>配置文件 etc/plugins/emqx_backend_influxdb.conf:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## 写数据到 InfluxDB 时使用的协议</span>
backend.influxdb.pool1.common.write_protocol <span class="token operator">=</span> udp

<span class="token comment">## 批量写入大小</span>
backend.influxdb.pool1.common.batch_size <span class="token operator">=</span> <span class="token number">1000</span>

<span class="token comment">## InfluxDB 写进程池大小</span>
backend.influxdb.pool1.pool_size <span class="token operator">=</span> <span class="token number">8</span>

<span class="token comment">## InfluxDB UDP 主机地址</span>
backend.influxdb.pool1.udp.host <span class="token operator">=</span> <span class="token number">127.0</span>.0.1

<span class="token comment">## InfluxDB UDP 主机端口</span>
backend.influxdb.pool1.udp.port <span class="token operator">=</span> <span class="token number">8089</span>

<span class="token comment">## InfluxDB HTTP/HTTPS 主机地址</span>
backend.influxdb.pool1.http.host <span class="token operator">=</span> <span class="token number">127.0</span>.0.1

<span class="token comment">## InfluxDB HTTP/HTTPS 主机端口</span>
backend.influxdb.pool1.http.port <span class="token operator">=</span> <span class="token number">8086</span>

<span class="token comment">## InflxuDB 数据库名</span>
backend.influxdb.pool1.http.database <span class="token operator">=</span> mydb

<span class="token comment">## 连接到 InfluxDB 的用户名</span>
<span class="token comment">## backend.influxdb.pool1.http.username = admin</span>

<span class="token comment">## 连接到 InfluxDB 的密码</span>
<span class="token comment">## backend.influxdb.pool1.http.password = public</span>

<span class="token comment">## 时间戳精度</span>
backend.influxdb.pool1.http.precision <span class="token operator">=</span> ms

<span class="token comment">## 是否启用 HTTPS</span>
backend.influxdb.pool1.http.https_enabled <span class="token operator">=</span> <span class="token boolean">false</span>

<span class="token comment">## 连接 InfluxDB 时使用的 TLS 协议版本</span>
<span class="token comment">## backend.influxdb.pool1.http.ssl.version = tlsv1.2</span>

<span class="token comment">## 密钥文件</span>
<span class="token comment">## backend.influxdb.pool1.http.ssl.keyfile = </span>

<span class="token comment">## 证书文件</span>
<span class="token comment">## backend.influxdb.pool1.http.ssl.certfile = </span>

<span class="token comment">## CA 证书文件</span>
<span class="token comment">## backend.influxdb.pool1.http.ssl.cacertfile = </span>

<span class="token comment">## 存储 PUBLISH 消息</span>
backend.influxdb.hook.message.publish.1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_publish&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
</code></pre></div><p><em>InfluxDB Backend</em> 消息存储规则参数:</p> <table><thead><tr><th>Option</th> <th>Description</th></tr></thead> <tbody><tr><td>topic</td> <td>配置哪些主题下的消息需要执行 hook</td></tr> <tr><td>action</td> <td>配置 hook 具体动作, function 为 Backend 提供的内置函数, 实现通用功能</td></tr> <tr><td>pool</td> <td>Pool Name, 实现连接多个 InfluxDB Server 功能</td></tr></tbody></table> <p>Example:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## 存储主题为 &quot;sensor/#&quot; 的 PUBLISH 消息</span>
backend.influxdb.hook.message.publish.1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;sensor/#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_publish&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>

<span class="token comment">## 存储主题为 &quot;stat/#&quot; 的 PUBLISH 消息</span>
backend.influxdb.hook.message.publish.2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;stat/#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_publish&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
</code></pre></div><p><em>InfluxDB Backend</em> 支持 Hook 与 相应内置函数列表:</p> <table><thead><tr><th>Hook</th> <th>Function list</th></tr></thead> <tbody><tr><td>message.publish</td> <td>on_message_publish</td></tr></tbody></table> <p>由于 MQTT Message 无法直接写入 InfluxDB, InfluxDB Backend 提供了
emqx_backend_influxdb.tmpl 模板文件将 MQTT Message 转换为可写入 InfluxDB 的
DataPoint。</p> <p>模板文件采用 JSON 格式, 组成部分:</p> <ul><li><code>key</code> - MQTT Topic, 字符串, 支持通配符</li> <li><code>value</code> - Template, Json 对象, 用于将 MQTT Message 转换成
<code>measurement,tag_key=tag_value,... field_key=field_value,... timestamp</code> 的形式以写入 InfluxDB。</li></ul> <p>你可以为不同 Topic 定义不同的 Template, 也可以为同一个 Topic 定义多个 Template, 类似:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">{</span>
  <span class="token operator">&lt;</span>Topic <span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>: <span class="token operator">&lt;</span>Template <span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>,
  <span class="token operator">&lt;</span>Topic <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>: <span class="token operator">&lt;</span>Template <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Template 格式如下:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;measurement&quot;</span><span class="token builtin class-name">:</span> <span class="token operator">&lt;</span>Measurement<span class="token operator">&gt;</span>,
  <span class="token string">&quot;tags&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token operator">&lt;</span>Tag Key<span class="token operator">&gt;</span>: <span class="token operator">&lt;</span>Tag Value<span class="token operator">&gt;</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;fields&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token operator">&lt;</span>Field Key<span class="token operator">&gt;</span>: <span class="token operator">&lt;</span>Field Value<span class="token operator">&gt;</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;timestamp&quot;</span><span class="token builtin class-name">:</span> <span class="token operator">&lt;</span>Timestamp<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>measurement</code> 与 <code>fields</code> 为必选项, <code>tags</code> 与 <code>timestamp</code> 为可选项。</p> <p>所有的值 (例如 <code>&lt;Measurement&gt;</code>) 你都可以直接在 Template 中配置为一个固定值,
它支持的数据类型依赖于你定义的数据表。当然更符合实际情况的是，你可以通过我们提供的占位符来获取
MQTT 消息中的数据。</p> <p>目前我们支持的占位符如下:</p> <table><thead><tr><th>Placeholder</th> <th>Description</th></tr></thead> <tbody><tr><td>$id</td> <td>MQTT 消息 UUID, 由 EMQ X 分配</td></tr> <tr><td>$clientid</td> <td>客户端使用的 Client ID</td></tr> <tr><td>$username</td> <td>客户端使用的 Username</td></tr> <tr><td>$peerhost</td> <td>客户端 IP</td></tr> <tr><td>$qos</td> <td>MQTT 消息的 QoS</td></tr> <tr><td>$topic</td> <td>MQTT 消息主题</td></tr> <tr><td>$payload</td> <td>MQTT 消息载荷, 必须为合法的 Json</td></tr> <tr><td>$&lt;Number&gt;</td> <td>必须配合 $paylaod 使用, 用于从 Json Array 中获取数据</td></tr> <tr><td>$timestamp</td> <td>EMQ X 准备转发消息时设置的时间戳, 精度: 纳秒</td></tr></tbody></table> <p><strong>$payload 与 $&lt;Number&gt;:</strong></p> <p>你可以直接使用 <code>$payload</code> 取得完整的消息载荷, 也可以通过 <code>[&quot;$payload&quot;, &lt;Key&gt;, ...]</code>
取得消息载荷内部的数据。</p> <p>例如 <code>payload</code> 为 <code>{&quot;data&quot;: {&quot;temperature&quot;: 23.9}}</code>, 你可以通过占位符 <code>[&quot;$payload&quot;, &quot;data&quot;, &quot;temperature&quot;]</code> 来获取其中的 <code>23.9</code>。</p> <p><img src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/emqx/backend/assets/backends_3.png" alt="backends_3.png"></p> <p>考虑到 Json 还有数组这一数据类型的情况, 我们引入了 <code>$0</code> 与 <code>$&lt;pos_integer&gt;</code>, <code>$0</code> 表示获取数组内所有元素,
<code>$&lt;pos_integer&gt;</code> 表示获取数组内第 <code>&lt;pos_integer&gt;</code> 个元素。</p> <p>一个简单例子, <code>[&quot;$payload&quot;, &quot;$0&quot;, &quot;temp&quot;]</code> 将从 <code>[{&quot;temp&quot;: 20}, {&quot;temp&quot;: 21}]</code>
中取得 <code>[20, 21]</code>, 而 <code>[&quot;$payload&quot;, &quot;$1&quot;, &quot;temp&quot;]</code> 将只取得 <code>20</code>。</p> <p><img src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/emqx/backend/assets/backends_4.png" alt="backends_4.png"></p> <p><img src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/emqx/backend/assets/backends_5.png" alt="backends_5.png"></p> <p>值得注意的是, 当你使用 <code>$0</code> 时，我们希望你取得的数据个数都是相等的。因为我们需要将这些数组转换为多条记录写入 InfluxDB,
而当你一个字段取得了 3 份数据, 另一个字段却取得了 2 份数据, 我们将无从判断应当怎样为你组合这些数据。</p> <p><img src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/emqx/backend/assets/backends_6.png" alt="backends_6.png"></p> <p><strong>Example</strong></p> <p>data/templates 目录下提供了一个示例模板 (emqx_backend_influxdb_example.tmpl,
正式使用时请去掉文件名中的 &quot;_example&quot; 后缀) 供用户参考:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;sample&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;measurement&quot;</span><span class="token operator">:</span> <span class="token string">&quot;$topic&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;$payload&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;host&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">&quot;region&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;$payload&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;region&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">&quot;qos&quot;</span><span class="token operator">:</span> <span class="token string">&quot;$qos&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;clientid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;$clientid&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;temperature&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;$payload&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;temp&quot;</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;$timestamp&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p>当 Template 中设置 timestamp 或插件配置 <code>backend.influxdb.pool1.set_timestamp = true</code> 时，请将 InfluxDB UDP 配置中的 precision 设为 &quot;ms&quot;。</p></div> <p>当 Topic 为 &quot;sample&quot; 的 MQTT Message 拥有以下 Payload 时:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
          <span class="token property">&quot;temp&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;serverA&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;region&quot;</span><span class="token operator">:</span> <span class="token string">&quot;hangzhou&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
          <span class="token property">&quot;temp&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;serverB&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;region&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ningbo&quot;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Backend 会将 MQTT Message 转换为:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
      <span class="token property">&quot;measurement&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sample&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;clientid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mqttjs_ebcc36079a&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;serverA&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;qos&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;region&quot;</span><span class="token operator">:</span> <span class="token string">&quot;hangzhou&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;temperature&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1560743513626681000&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
      <span class="token property">&quot;measurement&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sample&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;clientid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mqttjs_ebcc36079a&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;serverB&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;qos&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;region&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ningbo&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;temperature&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1560743513626681000&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>最终编码为以下数据写入
InfluxDB:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token string">&quot;sample,clientid=mqttjs_6990f0e886,host=serverA,qos=0,region=hangzhou temperature=<span class="token entity" title="\&quot;">\&quot;</span>1<span class="token entity" title="\&quot;">\&quot;</span> 1560745505429670000<span class="token entity" title="\n">\n</span>sample,clientid=mqttjs_6990f0e886,host=serverB,qos=0,region=ningbo temperature=<span class="token entity" title="\&quot;">\&quot;</span>2<span class="token entity" title="\&quot;">\&quot;</span> 1560745505429670000<span class="token entity" title="\n">\n</span>&quot;</span>
</code></pre></div><p>启用 InfluxDB 消息存储:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./bin/emqx_ctl plugins load emqx_backend_influxdb
</code></pre></div><h2 id="opentsdb-消息存储"><a href="#opentsdb-消息存储" class="header-anchor">#</a> OpenTSDB 消息存储</h2> <h3 id="配置-opentsdb-消息存储"><a href="#配置-opentsdb-消息存储" class="header-anchor">#</a> 配置 OpenTSDB 消息存储</h3> <p>配置文件：etc/plugins/emqx_backend_opentsdb.conf:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## OpenTSDB 服务地址</span>
backend.opentsdb.pool1.server <span class="token operator">=</span> <span class="token number">127.0</span>.0.1:4242

<span class="token comment">## OpenTSDB 连接池大小</span>
backend.opentsdb.pool1.pool_size <span class="token operator">=</span> <span class="token number">8</span>

<span class="token comment">## 是否返回 summary info</span>
<span class="token comment">##</span>
<span class="token comment">## Value: true | false</span>
backend.opentsdb.pool1.summary <span class="token operator">=</span> <span class="token boolean">true</span>

<span class="token comment">## 是否返回 detailed info</span>
<span class="token comment">##</span>
<span class="token comment">## Value: true | false</span>
backend.opentsdb.pool1.details <span class="token operator">=</span> <span class="token boolean">false</span>

<span class="token comment">## 是否同步写入</span>
<span class="token comment">##</span>
<span class="token comment">## Value: true | false</span>
backend.opentsdb.pool1.sync <span class="token operator">=</span> <span class="token boolean">false</span>

<span class="token comment">## 同步写入超时时间，单位毫秒</span>
<span class="token comment">##</span>
<span class="token comment">## Value: Duration</span>
<span class="token comment">##</span>
<span class="token comment">## Default: 0</span>
backend.opentsdb.pool1.sync_timeout <span class="token operator">=</span> <span class="token number">0</span>

<span class="token comment">## 最大批量写条数</span>
<span class="token comment">##</span>
<span class="token comment">## Value: Number &gt;= 0</span>
<span class="token comment">## Default: 20</span>
backend.opentsdb.pool1.max_batch_size <span class="token operator">=</span> <span class="token number">20</span>

<span class="token comment">## 存储 PUBLISH 消息</span>
backend.opentsdb.hook.message.publish.1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_publish&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
</code></pre></div><p><em>OpenTSDB Backend</em> 消息存储规则参数:</p> <table><thead><tr><th>Option</th> <th>Description</th></tr></thead> <tbody><tr><td>topic</td> <td>配置哪些主题下的消息需要执行 hook</td></tr> <tr><td>action</td> <td>配置 hook 具体动作, function 为 Backend 提供的内置函数, 实现通用功能</td></tr> <tr><td>pool</td> <td>Pool Name, 实现连接多个 OpenTSDB Server 功能</td></tr></tbody></table> <p>示例:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## 存储主题为 &quot;sensor/#&quot; 的 PUBLISH 消息</span>
backend.influxdb.hook.message.publish.1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;sensor/#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_publish&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>

<span class="token comment">## 存储主题为 &quot;stat/#&quot; 的 PUBLISH 消息</span>
backend.influxdb.hook.message.publish.2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;stat/#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_publish&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
</code></pre></div><p><em>OpenTSDB Backend</em> 支持 Hook 与 相应内置函数列表:</p> <table><thead><tr><th>Hook</th> <th>Function list</th></tr></thead> <tbody><tr><td>message.publish</td> <td>on_message_publish</td></tr></tbody></table> <p>由于 MQTT Message 无法直接写入 OpenTSDB, OpenTSDB Backend 提供了
emqx_backend_opentsdb.tmpl 模板文件将 MQTT Message 转换为可写入 OpenTSDB 的
DataPoint。</p> <p>模板文件采用 Json 格式, 组成部分:</p> <ul><li><code>key</code> - MQTT Topic, 字符串, 支持通配符主题</li> <li><code>value</code> - Template, Json 对象, 用于将 MQTT Message 转换成 OpenTSDB 的
DataPoint。</li></ul> <p>你可以为不同 Topic 定义不同的 Template, 也可以为同一个 Topic 定义多个 Template, 类似:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">{</span>
  <span class="token operator">&lt;</span>Topic <span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>: <span class="token operator">&lt;</span>Template <span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>,
  <span class="token operator">&lt;</span>Topic <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>: <span class="token operator">&lt;</span>Template <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Template 格式如下:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;measurement&quot;</span><span class="token builtin class-name">:</span> <span class="token operator">&lt;</span>Measurement<span class="token operator">&gt;</span>,
  <span class="token string">&quot;tags&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token operator">&lt;</span>Tag Key<span class="token operator">&gt;</span>: <span class="token operator">&lt;</span>Tag Value<span class="token operator">&gt;</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span>,
  <span class="token string">&quot;timestamp&quot;</span><span class="token builtin class-name">:</span> <span class="token operator">&lt;</span>Timestamp<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>measurement</code> 与 <code>value</code> 为必选项, <code>tags</code> 与 <code>timestamp</code> 为可选项。</p> <p>所有的值 (例如 <code>&lt;Measurement&gt;</code>) 你都可以直接在 Template 中配置为一个固定值,
它支持的数据类型依赖于你定义的数据表。当然更符合实际情况的是，你可以通过我们提供的占位符来获取
MQTT 消息中的数据。</p> <p>目前我们支持的占位符如下:</p> <table><thead><tr><th>Placeholder</th> <th>Description</th></tr></thead> <tbody><tr><td>$id</td> <td>MQTT 消息 UUID, 由 EMQ X 分配</td></tr> <tr><td>$clientid</td> <td>客户端使用的 Client ID</td></tr> <tr><td>$username</td> <td>客户端使用的 Username</td></tr> <tr><td>$peerhost</td> <td>客户端 IP</td></tr> <tr><td>$qos</td> <td>MQTT 消息的 QoS</td></tr> <tr><td>$topic</td> <td>MQTT 消息主题</td></tr> <tr><td>$payload</td> <td>MQTT 消息载荷, 必须为合法的 Json</td></tr> <tr><td>$&lt;Number&gt;</td> <td>必须配合 $paylaod 使用, 用于从 Json Array 中获取数据</td></tr> <tr><td>$timestamp</td> <td>EMQ X 准备转发消息时设置的时间戳, 精度: 毫秒</td></tr></tbody></table> <p><strong>$payload 与 $&lt;Number&gt;:</strong></p> <p>你可以直接使用 <code>$payload</code> 取得完整的消息载荷, 也可以通过 <code>[&quot;$payload&quot;, &lt;Key&gt;, ...]</code>
取得消息载荷内部的数据。</p> <p>例如 <code>payload</code> 为 <code>{&quot;data&quot;: {&quot;temperature&quot;: 23.9}}</code>, 你可以通过占位符 <code>[&quot;$payload&quot;, &quot;data&quot;, &quot;temperature&quot;]</code> 来获取其中的 <code>23.9</code>。</p> <p>考虑到 Json 还有数组这一数据类型的情况, 我们引入了 <code>$0</code> 与 <code>$&lt;pos_integer&gt;</code>, <code>$0</code> 表示获取数组内所有元素,
<code>$&lt;pos_integer&gt;</code> 表示获取数组内第 <code>&lt;pos_integer&gt;</code> 个元素。</p> <p>一个简单例子, <code>[&quot;$payload&quot;, &quot;$0&quot;, &quot;temp&quot;]</code> 将从 <code>[{&quot;temp&quot;: 20}, {&quot;temp&quot;: 21}]</code>
中取得 <code>[20, 21]</code>, 而 <code>[&quot;$payload&quot;, &quot;$1&quot;, &quot;temp&quot;]</code> 将只取得 <code>20</code>。</p> <p>值得注意的是, 当你使用 <code>$0</code> 时，我们希望你取得的数据个数都是相等的。因为我们需要将这些数组转换为多条记录写入 OpenTSDB,
而当你一个字段取得了 3 份数据, 另一个字段却取得了 2 份数据, 我们将无从判断应当怎样为你组合这些数据。</p> <p><strong>Example</strong></p> <p>data/templates 目录下提供了一个示例模板 (emqx_backend_opentsdb_example.tmpl,
正式使用时请去掉文件名中的 &quot;_example&quot; 后缀) 供用户参考:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;sample&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;measurement&quot;</span><span class="token operator">:</span> <span class="token string">&quot;$topic&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;$payload&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;host&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">&quot;region&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;$payload&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;region&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">&quot;qos&quot;</span><span class="token operator">:</span> <span class="token string">&quot;$qos&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;clientid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;$clientid&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;$payload&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;temp&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;$timestamp&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当 Topic 为 &quot;sample&quot; 的 MQTT Message 拥有以下 Payload 时:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
          <span class="token property">&quot;temp&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;serverA&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;region&quot;</span><span class="token operator">:</span> <span class="token string">&quot;hangzhou&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
          <span class="token property">&quot;temp&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;serverB&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;region&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ningbo&quot;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Backend 将 MQTT Message 转换为以下数据写入 OpenTSDB:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
      <span class="token property">&quot;measurement&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sample&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;clientid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mqttjs_ebcc36079a&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;serverA&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;qos&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;region&quot;</span><span class="token operator">:</span> <span class="token string">&quot;hangzhou&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1560743513626681000&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
      <span class="token property">&quot;measurement&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sample&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;clientid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mqttjs_ebcc36079a&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;serverB&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;qos&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;region&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ningbo&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1560743513626681000&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>启用 OpenTSDB 消息存储:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./bin/emqx_ctl plugins load emqx_backend_opentsdb
</code></pre></div><h2 id="timescale-消息存储"><a href="#timescale-消息存储" class="header-anchor">#</a> Timescale 消息存储</h2> <h3 id="配置-timescale-消息存储"><a href="#配置-timescale-消息存储" class="header-anchor">#</a> 配置 Timescale 消息存储</h3> <p>etc/plugins/emqx_backend_timescale.conf:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## Timescale Server</span>
backend.timescale.pool1.server <span class="token operator">=</span> <span class="token number">127.0</span>.0.1:5432
<span class="token comment">## Timescale Pool Size</span>
backend.timescale.pool1.pool_size <span class="token operator">=</span> <span class="token number">8</span>
<span class="token comment">## Timescale Username</span>
backend.timescale.pool1.username <span class="token operator">=</span> postgres
<span class="token comment">## Timescale Password</span>
backend.timescale.pool1.password <span class="token operator">=</span> password
<span class="token comment">## Timescale Database</span>
backend.timescale.pool1.database <span class="token operator">=</span> tutorial
<span class="token comment">## Timescale SSL</span>
backend.timescale.pool1.ssl <span class="token operator">=</span> <span class="token boolean">false</span>

<span class="token comment">## SSL keyfile.</span>
<span class="token comment">##</span>
<span class="token comment">## Value: File</span>
<span class="token comment">## backend.timescale.pool1.keyfile =</span>

<span class="token comment">## SSL certfile.</span>
<span class="token comment">##</span>
<span class="token comment">## Value: File</span>
<span class="token comment">## backend.timescale.pool1.certfile =</span>

<span class="token comment">## SSL cacertfile.</span>
<span class="token comment">##</span>
<span class="token comment">## Value: File</span>
<span class="token comment">## backend.timescale.pool1.cacertfile =</span>

<span class="token comment">## Store Publish Message</span>
backend.timescale.hook.message.publish.1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_publish&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
</code></pre></div><p><em>Timescale Backend</em> 消息存储规则参数:</p> <table><thead><tr><th>Option</th> <th>Description</th></tr></thead> <tbody><tr><td>topic</td> <td>配置哪些主题下的消息需要执行 hook</td></tr> <tr><td>action</td> <td>配置 hook 具体动作, function 为 Backend 提供的内置函数, 实现通用功能</td></tr> <tr><td>pool</td> <td>Pool Name, 实现连接多个 Timescale Server 功能</td></tr></tbody></table> <p>Example:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## Store Publish message with &quot;sensor/#&quot; topic</span>
backend.timescale.hook.message.publish.1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;sensor/#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_publish&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>

<span class="token comment">## Store Publish message with &quot;stat/#&quot; topic</span>
backend.timescale.hook.message.publish.2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;stat/#&quot;</span>, <span class="token string">&quot;action&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&quot;function&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;on_message_publish&quot;</span><span class="token punctuation">}</span>, <span class="token string">&quot;pool&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;pool1&quot;</span><span class="token punctuation">}</span>
</code></pre></div><p><em>Timescale Backend</em> 支持 Hook 与 相应内置函数列表:</p> <table><thead><tr><th>Hook</th> <th>Function list</th></tr></thead> <tbody><tr><td>message.publish</td> <td>on_message_publish</td></tr></tbody></table> <p>Timescale Backend 提供 emqx_backend_timescale.tmpl 模板文件，用于从不同主题的 MQTT
Message 中提取数据以写入 Timescale。</p> <p>模板文件采用 Json 格式, 组成部分:</p> <ul><li><code>key</code> - MQTT Topic, 字符串, 支持通配符主题</li> <li><code>value</code> - Template, Json 对象, 用于将 MQTT Message 转换成
<code>measurement,tag_key=tag_value,... field_key=field_value,... timestamp</code> 的形式以写入 InfluxDB。</li></ul> <p>你可以为不同 Topic 定义不同的 Template, 也可以为同一个 Topic 定义多个 Template, 类似:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">{</span>
  <span class="token operator">&lt;</span>Topic <span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>: <span class="token operator">&lt;</span>Template <span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>,
  <span class="token operator">&lt;</span>Topic <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>: <span class="token operator">&lt;</span>Template <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Template 格式如下:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token operator">&lt;</span>Name of template<span class="token operator">&gt;</span>,
  <span class="token string">&quot;sql&quot;</span><span class="token builtin class-name">:</span> <span class="token operator">&lt;</span>SQL INSERT INTO<span class="token operator">&gt;</span>,
  <span class="token string">&quot;param_keys&quot;</span><span class="token builtin class-name">:</span> <span class="token operator">&lt;</span>Param Keys<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>name</code>, <code>sql</code> 和 <code>param_keys</code> 都是必选项。</p> <p><code>name</code> 可以是任意的字符串，确保没有重复即可。</p> <p><code>sql</code> 为 Timescale 可用的 SQL INSERT INTO 语句，例如：<code>insert into sensor_data(time, location, temperature, humidity) values (NOW(), $1, $2, $3)</code>。</p> <p><code>param_keys</code> 是一个数组，它的第一个元素对应 <code>sql</code> 中出现的 <code>$1</code>，并以此类推。</p> <p>数组中任意元素都可以是一个固定值, 它支持的数据类型依赖于你定义的数据表。当然更符合实际情况的是，你可以通过我们提供的占位符来获取 MQTT
消息中的数据。</p> <p>目前我们支持的占位符如下:</p> <table><thead><tr><th>Placeholder</th> <th>Description</th></tr></thead> <tbody><tr><td>$id</td> <td>MQTT 消息 UUID, 由 EMQ X 分配</td></tr> <tr><td>$clientid</td> <td>客户端使用的 Client ID</td></tr> <tr><td>$username</td> <td>客户端使用的 Username</td></tr> <tr><td>$peerhost</td> <td>客户端 IP</td></tr> <tr><td>$qos</td> <td>MQTT 消息的 QoS</td></tr> <tr><td>$topic</td> <td>MQTT 消息主题</td></tr> <tr><td>$payload</td> <td>MQTT 消息载荷, 必须为合法的 Json</td></tr> <tr><td>$&lt;Number&gt;</td> <td>必须配合 $paylaod 使用, 用于从 Json Array 中获取数据</td></tr> <tr><td>$timestamp</td> <td>EMQ X 准备转发消息时设置的时间戳, 精度: 毫秒</td></tr></tbody></table> <p><strong>$payload 与 $&lt;Number&gt;:</strong></p> <p>你可以直接使用 <code>$payload</code> 取得完整的消息载荷, 也可以通过 <code>[&quot;$payload&quot;, &lt;Key&gt;, ...]</code>
取得消息载荷内部的数据。</p> <p>例如 <code>payload</code> 为 <code>{&quot;data&quot;: {&quot;temperature&quot;: 23.9}}</code>, 你可以通过占位符 <code>[&quot;$payload&quot;, &quot;data&quot;, &quot;temperature&quot;]</code> 来获取其中的 <code>23.9</code>。</p> <p>考虑到 Json 还有数组这一数据类型的情况, 我们引入了 <code>$0</code> 与 <code>$&lt;pos_integer&gt;</code>, <code>$0</code> 表示获取数组内所有元素,
<code>$&lt;pos_integer&gt;</code> 表示获取数组内第 <code>&lt;pos_integer&gt;</code> 个元素。</p> <p>一个简单例子, <code>[&quot;$payload&quot;, &quot;$0&quot;, &quot;temp&quot;]</code> 将从 <code>[{&quot;temp&quot;: 20}, {&quot;temp&quot;: 21}]</code>
中取得 <code>[20, 21]</code>, 而 <code>[&quot;$payload&quot;, &quot;$1&quot;, &quot;temp&quot;]</code> 将只取得 <code>20</code>。</p> <p>值得注意的是, 当你使用 <code>$0</code> 时，我们希望你取得的数据个数都是相等的。因为我们需要将这些数组转换为多条记录写入 Timescale,
而当你一个字段取得了 3 份数据, 另一个字段却取得了 2 份数据, 我们将无从判断应当怎样为你组合这些数据。</p> <p><strong>Example</strong></p> <p>data/templates 目录下提供了一个示例模板 (emqx_backend_timescale_example.tmpl,
正式使用时请去掉文件名中的 &quot;_example&quot; 后缀) 供用户参考:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;sensor_data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;insert_sensor_data&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;sql&quot;</span><span class="token operator">:</span> <span class="token string">&quot;insert into sensor_data(time, location, temperature, humidity) values (NOW(), $1, $2, $3)&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;param_keys&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">[</span><span class="token string">&quot;$payload&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;location&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token string">&quot;$payload&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;temperature&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token string">&quot;$payload&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;humidity&quot;</span><span class="token punctuation">]</span>
      <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sensor_data2/#&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;insert_sensor_data2&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;sql&quot;</span><span class="token operator">:</span> <span class="token string">&quot;insert into sensor_data(time, location, temperature, humidity) values (NOW(), $1, $2, $3)&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;param_keys&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">[</span><span class="token string">&quot;$payload&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;location&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token string">&quot;$payload&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;temperature&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token string">&quot;$payload&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;humidity&quot;</span><span class="token punctuation">]</span>
      <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;easy_data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;insert_easy_data&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;sql&quot;</span><span class="token operator">:</span> <span class="token string">&quot;insert into easy_data(time, data) values (NOW(), $1)&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;param_keys&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">&quot;$payload&quot;</span>
      <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当 Topic 为 &quot;sensor_data&quot; 的 MQTT Message 拥有以下 Payload 时:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
          <span class="token property">&quot;location&quot;</span><span class="token operator">:</span><span class="token string">&quot;bedroom&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;temperature&quot;</span><span class="token operator">:</span><span class="token number">21.3</span><span class="token punctuation">,</span>
          <span class="token property">&quot;humidity&quot;</span><span class="token operator">:</span><span class="token number">40.3</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
          <span class="token property">&quot;location&quot;</span><span class="token operator">:</span><span class="token string">&quot;bathroom&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;temperature&quot;</span><span class="token operator">:</span><span class="token number">22.3</span><span class="token punctuation">,</span>
          <span class="token property">&quot;humidity&quot;</span><span class="token operator">:</span><span class="token number">61.8</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
          <span class="token property">&quot;location&quot;</span><span class="token operator">:</span><span class="token string">&quot;kitchen&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;temperature&quot;</span><span class="token operator">:</span><span class="token number">29.5</span><span class="token punctuation">,</span>
          <span class="token property">&quot;humidity&quot;</span><span class="token operator">:</span><span class="token number">58.7</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>[&quot;$payload&quot;, &quot;data&quot;, &quot;$0&quot;, &quot;location&quot;] 会先获取 MQTT Message 的 Payload，如果
Payload 为 json 格式，则继续尝试读取 data。data 的值是数组，这里我们用到了 &quot;$0&quot; 表示获取数组中所有的元素，因此
[&quot;$payload&quot;, &quot;data&quot;, &quot;$0&quot;, &quot;location&quot;] 将帮我们获得 [&quot;bedroom&quot;, &quot;bathroom&quot;,
&quot;kitchen&quot;]。相应的，如果将 &quot;$0&quot; 替换为 &quot;$1&quot;，将只获得 [&quot;bedroom&quot;]。相应的，如果将</p> <p>那么在这个场景中，我们将得到以下 SQL
语句:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> sensor_data<span class="token punctuation">(</span><span class="token keyword">time</span><span class="token punctuation">,</span> location<span class="token punctuation">,</span> temperature<span class="token punctuation">,</span> humidity<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'bedroom'</span><span class="token punctuation">,</span> <span class="token number">21.3</span><span class="token punctuation">,</span> <span class="token number">40.3</span><span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> sensor_data<span class="token punctuation">(</span><span class="token keyword">time</span><span class="token punctuation">,</span> location<span class="token punctuation">,</span> temperature<span class="token punctuation">,</span> humidity<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'bathroom'</span><span class="token punctuation">,</span> <span class="token number">22.3</span><span class="token punctuation">,</span> <span class="token number">61.8</span><span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> sensor_data<span class="token punctuation">(</span><span class="token keyword">time</span><span class="token punctuation">,</span> location<span class="token punctuation">,</span> temperature<span class="token punctuation">,</span> humidity<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'kitchen'</span><span class="token punctuation">,</span> <span class="token number">29.5</span><span class="token punctuation">,</span> <span class="token number">58.7</span><span class="token punctuation">)</span>
</code></pre></div><p>最终 Timescale Backend 执行这些 SQL 语句将数据写入 Timescale。</p></div> <!----></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/15/2021, 9:43:01 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/zh/backend/emqx/backend/backend.html" class="prev">数据存储设计</a></span> <span class="next"><a href="/zh/backend/emqx/bridge/bridge.html">消息桥接简介</a>
      →
    </span></p></div> </main></div><div class="global-ui"><div></div><div class="add-this"></div><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button title="Close (Esc)" class="pswp__button pswp__button--close"></button> <button title="Share" class="pswp__button pswp__button--share"></button> <button title="Toggle fullscreen" class="pswp__button pswp__button--fs"></button> <button title="Zoom in/out" class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button title="Previous (arrow left)" class="pswp__button pswp__button--arrow--left"></button> <button title="Next (arrow right)" class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/assets/js/app.25b3400a.js" defer></script><script src="/assets/js/6.5fcf748f.js" defer></script><script src="/assets/js/5.ef440211.js" defer></script><script src="/assets/js/86.3cb3d02d.js" defer></script>
  </body>
</html>
