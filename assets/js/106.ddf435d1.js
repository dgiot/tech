(window.webpackJsonp=window.webpackJsonp||[]).push([[106],{679:function(t,e,s){"use strict";s.r(e);var a=s(10),r=Object(a.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"emq-x-mqtt-微信小程序接入"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#emq-x-mqtt-微信小程序接入"}},[t._v("#")]),t._v(" EMQ X MQTT 微信小程序接入")]),t._v(" "),s("p",[t._v("微信小程序支持通过 WebSocket 进行即时通信，EMQ X 的 MQTT Over WebSocket 能够完全兼容使用在微信小程序上。")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("提示")]),t._v(" "),s("p",[t._v("由于微信小程序的规范限制，EMQ X 使用微信小程序接入时需要注意以下几点：")]),t._v(" "),s("ul",[s("li",[t._v("必须使用已经通过"),s("a",{attrs:{href:"https://baike.baidu.com/item/%E5%9F%9F%E5%90%8D%E5%A4%87%E6%A1%88",target:"_blank",rel:"noopener noreferrer"}},[t._v("域名备案"),s("OutboundLink")],1),t._v("的"),s("strong",[t._v("域名")]),t._v("接入")]),t._v(" "),s("li",[t._v("域名需要在"),s("a",{attrs:{href:"https://mp.weixin.qq.com/wxamp/devprofile/get_profile",target:"_blank",rel:"noopener noreferrer"}},[t._v("小程序管理后台"),s("OutboundLink")],1),t._v("域名/IP 白名单中(开发 -> 开发设置 -> 服务器域名 -> socket 合法域名)")]),t._v(" "),s("li",[t._v("仅支持 WebSocket/TLS 协议，需要为域名分配受信任 CA 颁发的证书")]),t._v(" "),s("li",[t._v("由于微信小程序 BUG，安卓"),s("strong",[t._v("真机必须")]),t._v("使用 TLS/443 端口，否则会连接失败（即连接地址不能带端口）")])])]),t._v(" "),s("h2",{attrs:{id:"参考资料"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[t._v("#")]),t._v(" 参考资料")]),t._v(" "),s("ul",[s("li",[t._v("EMQ X "),s("a",{attrs:{href:"https://www.emqx.cn/blog/connect-to-mqtt-broker-with-websocket",target:"_blank",rel:"noopener noreferrer"}},[t._v("使用 WebSocket 连接 MQTT 服务器"),s("OutboundLink")],1)]),t._v(" "),s("li",[t._v("CSDN "),s("a",{attrs:{href:"https://www.xncoding.com/2018/03/12/fullstack/nginx-websocket.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Nginx 反向代理 WebSocket"),s("OutboundLink")],1)]),t._v(" "),s("li",[t._v("微信小程序 MQTT 接入"),s("a",{attrs:{href:"https://github.com/iAoe444/WeChatMiniEsp8266",target:"_blank",rel:"noopener noreferrer"}},[t._v("Demo"),s("OutboundLink")],1)])]),t._v(" "),s("h2",{attrs:{id:"详细步骤"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#详细步骤"}},[t._v("#")]),t._v(" 详细步骤")]),t._v(" "),s("p",[t._v("1、注册微信小程序帐号，并下载"),s("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信开发者工具"),s("OutboundLink")],1),t._v("。由于微信小程序安全要求比较高，在与后台服务器之间的通讯必须使用 https 或 wss 协议，因此要在微信小程序后台设置域名服务器。")]),t._v(" "),s("p",[t._v("登录小程序后台后，找到 "),s("strong",[t._v("开发设置 -> 服务器域名")]),t._v(" 进行服务器配置，在 socket 合法域名处输入格式如 wss://xxx.emqx.io，此处不带端口号。")]),t._v(" "),s("p",[t._v("2、服务器端要申请并安装证书，华为云等云提供商均可以"),s("a",{attrs:{href:"https://www.huaweicloud.com/product/scm.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("申请免费证书"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("p",[t._v("这里必须注意的是，证书申请绑定时，必须与所使用的服务器域名一致，此处建议使用 Nginx 来做反向代理并终结证书，相关配置如下：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("server "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    listen  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(" ssl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("        \n    server_name xxx.emqx.io"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n    ssl_certificate   cert/***.pem"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ssl_certificate_key  cert/***.key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ssl_session_timeout  5m"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("      \n    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("NULL:"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("aNULL:"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("MD5:"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("ADH:"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("RC4"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ssl_prefer_server_ciphers on"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加反向代理")]),t._v("\n    location /mqtt "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      proxy_pass http://127.0.0.1:8083/mqtt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      proxy_set_header Host "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$host")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      proxy_set_header X-Real-IP "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      proxy_set_header X-Forwarded-For "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$proxy_add_x_forwarded_for")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# client_max_body_size 35m;")]),t._v("\n      proxy_http_version "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      proxy_set_header Upgrade "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$http_upgrade")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      proxy_set_header Connection "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"upgrade"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("3、开源社区提供了小程序 MQTT 接入的 Demo："),s("a",{attrs:{href:"https://github.com/iAoe444/WeChatMiniEsp8266",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/iAoe444/WeChatMiniEsp8266"),s("OutboundLink")],1),t._v(" 下载解压到一个文件夹后，用微信小程序开发者工具，打开 "),s("code",[t._v("index.js")]),t._v(" 文件，"),s("strong",[t._v("将 MQTT 地址、用户名和密码改为实际参数即可")]),t._v("。")]),t._v(" "),s("p",[t._v("按照以上 3 步的安装配置，你的微信小程序已经能够成功连接到 EMQ X 服务器了。")])])}),[],!1,null,null,null);e.default=r.exports}}]);